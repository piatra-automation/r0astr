# Story 9.5: Create Slider Manager Module

## Status
Ready for Development

## Story

**As a** developer,
**I want** slider rendering and management extracted to a dedicated module,
**so that** slider logic is isolated from panel management

## Acceptance Criteria

1. Create `src/managers/sliderManager.js`
2. Move slider-related code from `main.js`:
   - `renderSliders(panelId, widgets)`
   - `createSliderElement(widget)`
   - Slider event handlers
3. Link to Strudel's `sliderValues` ref
4. Use event bus: `eventBus.emit('slider:changed', { panelId, sliderId, value })`
5. Import and use in panel manager

## Tasks / Subtasks

- [ ] **Task 1: Create slider manager file** (AC: 1)
  - [ ] Create `src/managers/sliderManager.js`
  - [ ] Add file header with module description

- [ ] **Task 2: Import dependencies**
  - [ ] Import event bus: `import { eventBus } from '../utils/eventBus.js'`
  - [ ] Import Strudel slider: `import { sliderValues } from '@strudel/codemirror'`
  - [ ] Make sliderValues accessible globally (if needed)

- [ ] **Task 3: Implement renderSliders() function** (AC: 2)
  - [ ] Extract from main.js lines 123-169
  - [ ] Function signature: `renderSliders(panelId, widgets)`
  - [ ] Get slider container for panel
  - [ ] Clear existing sliders
  - [ ] Loop through widgets, filter for type === 'slider'
  - [ ] Create slider element for each widget
  - [ ] Append to container
  - [ ] Export function

- [ ] **Task 4: Implement createSliderElement() function** (AC: 2)
  - [ ] Function signature: `createSliderElement(widget, panelId)`
  - [ ] Create wrapper div
  - [ ] Create label with slider name
  - [ ] Create `<input type="range">` element
  - [ ] Set attributes: min, max, value, step
  - [ ] Add event listener for 'input' event
  - [ ] Return wrapper element
  - [ ] Export function

- [ ] **Task 5: Implement slider event handling** (AC: 2, 3)
  - [ ] On slider input:
    - Update `sliderValues[widget.id] = parseFloat(value)`
    - Emit event: `eventBus.emit('slider:changed', { panelId, sliderId, value })`
  - [ ] Ensure Strudel reactive refs update correctly

- [ ] **Task 6: Add slider utilities**
  - [ ] `clearSliders(panelId)` - Remove all sliders from panel
  - [ ] `getSliderValue(sliderId)` - Get current slider value
  - [ ] `setSliderValue(sliderId, value)` - Programmatically set slider
  - [ ] Export utility functions

- [ ] **Task 7: Add JSDoc documentation**
  - [ ] Document renderSliders() with @param
  - [ ] Document createSliderElement() with @param and @returns
  - [ ] Add usage examples in comments

- [ ] **Task 8: Refactor main.js to use sliderManager** (AC: 5)
  - [ ] Import slider manager functions
  - [ ] Replace slider rendering code with manager calls
  - [ ] Remove slider-related code from main.js
  - [ ] Verify sliders still work with pattern evaluation

- [ ] **Task 9: Test slider functionality**
  - [ ] Test slider rendering after pattern evaluation
  - [ ] Test slider value updates `sliderValues` object
  - [ ] Test slider changes trigger pattern re-evaluation
  - [ ] Verify events emitted correctly
  - [ ] Test multiple sliders in single panel

## Dev Notes

### Slider Manager Implementation
[Source: architecture/frontend-architecture.md#codemirror-integration-architecture]

```javascript
// src/managers/sliderManager.js

import { eventBus } from '../utils/eventBus.js';
import { sliderValues } from '@strudel/codemirror';

/**
 * Render sliders for a panel based on transpiler widgets
 * @param {string} panelId - Panel identifier
 * @param {Array} widgets - Widget metadata from transpiler
 */
export function renderSliders(panelId, widgets) {
  const sliderContainer = document.querySelector(
    `[data-panel="${panelId}"] .slider-container`
  );

  if (!sliderContainer) return;

  // Clear existing sliders
  sliderContainer.innerHTML = '';

  // Filter for slider widgets
  const sliders = widgets.filter(w => w.type === 'slider');

  // Create slider elements
  sliders.forEach(widget => {
    const sliderElement = createSliderElement(widget, panelId);
    sliderContainer.appendChild(sliderElement);
  });
}

/**
 * Create HTML slider element from widget metadata
 * @param {object} widget - Widget metadata {id, type, default, min, max}
 * @param {string} panelId - Panel identifier
 * @returns {HTMLElement} Slider wrapper element
 */
export function createSliderElement(widget, panelId) {
  const wrapper = document.createElement('div');
  wrapper.className = 'slider-wrapper';

  // Label
  const label = document.createElement('label');
  label.textContent = `${widget.id}: ${widget.default}`;
  label.className = 'slider-label';

  // Input range
  const slider = document.createElement('input');
  slider.type = 'range';
  slider.min = widget.min || 0;
  slider.max = widget.max || 100;
  slider.value = widget.default || 50;
  slider.step = widget.step || 1;
  slider.className = 'slider-input';
  slider.dataset.sliderId = widget.id;

  // Event listener
  slider.addEventListener('input', (e) => {
    const value = parseFloat(e.target.value);

    // Update Strudel reactive ref
    sliderValues[widget.id] = value;

    // Update label
    label.textContent = `${widget.id}: ${value}`;

    // Emit event
    eventBus.emit('slider:changed', {
      panelId,
      sliderId: widget.id,
      value
    });
  });

  wrapper.appendChild(label);
  wrapper.appendChild(slider);

  return wrapper;
}

// Utility functions
export function clearSliders(panelId) {
  const container = document.querySelector(
    `[data-panel="${panelId}"] .slider-container`
  );
  if (container) {
    container.innerHTML = '';
  }
}

export function getSliderValue(sliderId) {
  return sliderValues[sliderId];
}

export function setSliderValue(sliderId, value) {
  sliderValues[sliderId] = value;

  // Update UI slider if exists
  const sliderElement = document.querySelector(
    `input[data-slider-id="${sliderId}"]`
  );
  if (sliderElement) {
    sliderElement.value = value;
  }
}
```

### Strudel Slider Integration
[Source: architecture/frontend-architecture.md#codemirror-integration-architecture]

**How Strudel sliders work:**

1. **Transpiler extracts sliders:**
   ```javascript
   // Pattern code:
   note("c2").lpf(slider(800, 100, 5000))

   // Transpiler converts to:
   note("c2").lpf(sliderWithID('slider_0', 800, 100, 5000))

   // Widget metadata returned:
   { id: 'slider_0', type: 'slider', default: 800, min: 100, max: 5000 }
   ```

2. **sliderValues reactive ref:**
   ```javascript
   window.sliderValues = {}; // Global object
   sliderValues['slider_0'] = 800; // Set value

   // Strudel patterns use ref(() => sliderValues['slider_0'])
   ```

3. **Pattern re-evaluates when slider changes:**
   - Slider input event updates `sliderValues`
   - Strudel pattern uses ref, so updates automatically
   - No manual re-evaluation needed (reactive)

### Current Slider Code Location in main.js
[Source: architecture/source-tree.md#application-logic-srcmainjs]

Code to extract:
- Lines 123-169: `renderSliders()` function
- Embedded slider element creation logic
- Event listener setup for slider inputs

### Slider HTML Structure
Expected DOM structure:
```html
<div class="slider-container">
  <div class="slider-wrapper">
    <label class="slider-label">slider_0: 800</label>
    <input type="range" class="slider-input"
           data-slider-id="slider_0"
           min="100" max="5000" value="800" step="1">
  </div>
  <!-- More sliders... -->
</div>
```

### Event Bus Integration
[Source: architecture/frontend-architecture.md#event-bus-pattern]

Slider manager events:
- `slider:changed` - Emitted when slider value changes
  - Payload: `{ panelId, sliderId, value }`
  - Other managers can listen (e.g., WebSocket sync)

### sliderValues Global Object
[Source: architecture/source-tree.md#application-logic-srcmainjs]

```javascript
// In main.js (stays here):
window.sliderValues = {};

// In sliderManager.js (imports from Strudel):
import { sliderValues } from '@strudel/codemirror';
// sliderValues points to window.sliderValues
```

## Testing

### Testing Standards

**Manual Testing:**

1. **Slider Rendering:**
   - Evaluate pattern: `note("c2").lpf(slider(800, 100, 5000))`
   - Verify slider appears in panel
   - Verify label shows "slider_0: 800"
   - Verify range input has correct min/max/value

2. **Slider Interaction:**
   - Move slider with mouse
   - Verify label updates to show new value
   - Verify `sliderValues` object updated (check console)
   - Verify event emitted (console.log in listener)

3. **Pattern Reactivity:**
   - Play pattern with slider
   - Move slider while pattern playing
   - Verify audio changes reflect slider value
   - Verify pattern doesn't need manual re-evaluation

4. **Multiple Sliders:**
   - Pattern: `note("c2").lpf(slider(800, 100, 5000)).gain(slider(0.5, 0, 1))`
   - Verify 2 sliders render
   - Verify each slider controls correct parameter
   - Verify both update independently

5. **Clear Sliders:**
   - Call `clearSliders('panel-1')`
   - Verify all sliders removed from panel
   - Verify `sliderValues` object unchanged (values persist)

### Expected Outcomes

- ✅ `src/managers/sliderManager.js` exists
- ✅ Sliders render correctly from widget metadata
- ✅ Slider values update `sliderValues` object
- ✅ Events emitted on slider changes
- ✅ Strudel patterns react to slider changes
- ✅ main.js uses slider manager

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-09 | 1.0 | Story created for Epic 9 | Bob (SM) |

## Dev Agent Record

### Agent Model Used
(To be filled by dev agent)

### Debug Log References
(To be filled by dev agent)

### Completion Notes List
(To be filled by dev agent)

### File List
(To be filled by dev agent)

## QA Results
(To be filled by QA agent)

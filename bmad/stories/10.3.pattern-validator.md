# Story 10.3: Create Pattern Validator Module

## Status
Draft

## Story

**As a** developer,
**I want** pattern validation logic extracted to a dedicated module,
**so that** syntax checking and error display are isolated from panel logic

## Acceptance Criteria

1. Create `src/ui/patternValidator.js` module
2. Export functions:
   - `validateCode(panelId, code)` - Validate pattern syntax using Strudel transpiler
   - `displayError(panelId, errorMessage, lineNumber)` - Show error UI
   - `clearErrorMessage(panelId)` - Remove error UI
   - `checkStaleness(panelId)` - Detect if code changed since last eval
   - `updateActivateButton(panelId)` - Enable/disable based on validation
   - `updatePauseButton(panelId)` - Update pause button state
3. Use Strudel transpiler for syntax validation:
   - Import `transpiler` from @strudel/transpiler
   - Catch transpilation errors to detect invalid syntax
   - Extract line numbers from error messages
4. Use event bus:
   - Emit: `pattern:valid`, `pattern:invalid`, `panel:stale`
   - Listen: `panel:codeChanged`, `panel:evaluated`
5. Update button states (enable/disable based on validity)
6. Application functions identically before/after extraction

## Tasks / Subtasks

- [ ] **Task 1: Create module structure** (AC: 1)
  - [ ] Create `src/ui/patternValidator.js` file
  - [ ] Add module purpose JSDoc
  - [ ] Setup imports: panelManager, eventBus
  - [ ] Setup imports: transpiler from @strudel/transpiler
  - [ ] Declare module-private state (lastEvaluatedCode Map)

- [ ] **Task 2: Implement pattern validation** (AC: 2, 3)
  - [ ] Create `validateCode(panelId, code)` function
  - [ ] Call transpiler(code) to check syntax
  - [ ] Catch transpilation errors
  - [ ] Extract error message from exception
  - [ ] Extract line number from error message (if available)
  - [ ] Return validation result: { valid: boolean, error: string, line: number }

- [ ] **Task 3: Implement error display** (AC: 2)
  - [ ] Create `displayError(panelId, errorMessage, lineNumber)` function
  - [ ] Get panel DOM element
  - [ ] Create/update error message element
  - [ ] Display error text with line number
  - [ ] Apply error styling (red border, error text color)
  - [ ] Position error message near line (if line number available)

- [ ] **Task 4: Implement error clearing** (AC: 2)
  - [ ] Create `clearErrorMessage(panelId)` function
  - [ ] Get panel DOM element
  - [ ] Remove error message element
  - [ ] Remove error styling from panel
  - [ ] Reset panel border color to normal

- [ ] **Task 5: Implement staleness detection** (AC: 2)
  - [ ] Create `checkStaleness(panelId)` function
  - [ ] Get current code from panel editor
  - [ ] Compare with lastEvaluatedCode[panelId]
  - [ ] Return boolean: true if code changed since last eval
  - [ ] Store evaluated code: `lastEvaluatedCode.set(panelId, code)`

- [ ] **Task 6: Implement ACTIVATE button state** (AC: 2, 5)
  - [ ] Create `updateActivateButton(panelId)` function
  - [ ] Get ACTIVATE button DOM element
  - [ ] Enable if: code valid AND (not playing OR stale)
  - [ ] Disable if: code invalid OR (playing AND not stale)
  - [ ] Update button text: "ACTIVATE" or "UPDATE" based on staleness

- [ ] **Task 7: Implement PAUSE button state** (AC: 2, 5)
  - [ ] Create `updatePauseButton(panelId)` function
  - [ ] Get PAUSE button DOM element
  - [ ] Enable if: panel is playing
  - [ ] Disable if: panel is not playing
  - [ ] Update button visibility/opacity

- [ ] **Task 8: Setup event bus integration** (AC: 4)
  - [ ] Emit `pattern:valid` when validation passes
  - [ ] Emit `pattern:invalid` when validation fails
  - [ ] Emit `panel:stale` when staleness detected
  - [ ] Listen for `panel:codeChanged` to trigger validation
  - [ ] Listen for `panel:evaluated` to update lastEvaluatedCode

- [ ] **Task 9: Implement automatic validation** (AC: 2, 4)
  - [ ] Listen for `panel:codeChanged` event
  - [ ] Call `validateCode()` when code changes
  - [ ] Call `displayError()` if invalid
  - [ ] Call `clearErrorMessage()` if valid
  - [ ] Call `updateActivateButton()` after validation

- [ ] **Task 10: Add comprehensive JSDoc** (AC: 1, 2)
  - [ ] Document all exported functions
  - [ ] Document validation logic and error handling
  - [ ] Document button state logic
  - [ ] Document staleness detection algorithm
  - [ ] Add usage examples

- [ ] **Task 11: Integration testing** (AC: 6)
  - [ ] Import patternValidator in main.js
  - [ ] Trigger validation on panel code change
  - [ ] Test valid code → verify no error, ACTIVATE enabled
  - [ ] Test invalid code → verify error displayed, ACTIVATE disabled
  - [ ] Test staleness → verify UPDATE button shown
  - [ ] Verify application functions identically

## Dev Notes

### Validation Using Transpiler
[Source: bmad/prd/epic-10-ui-module-extraction.md#story-103]

Pattern validation uses the Strudel transpiler to detect syntax errors:

**Note:** Transpiler is SAFE for panel pattern validation (unlike master panel where it hangs)

```javascript
import { transpiler } from '@strudel/transpiler';

export function validateCode(panelId, code) {
  if (!code || code.trim() === '') {
    return { valid: false, error: 'Code is empty', line: null };
  }

  try {
    // Attempt to transpile
    const result = transpiler(code, { addReturn: false });

    // If transpilation succeeds, code is valid
    return { valid: true, error: null, line: null };

  } catch (error) {
    // Transpilation failed - syntax error
    const errorMessage = error.message || 'Unknown syntax error';

    // Try to extract line number from error message
    const lineMatch = errorMessage.match(/line (\d+)/i);
    const lineNumber = lineMatch ? parseInt(lineMatch[1]) : null;

    return {
      valid: false,
      error: errorMessage,
      line: lineNumber
    };
  }
}
```

### Error Display Pattern
[Source: bmad/prd/epic-10-ui-module-extraction.md#story-103]

Error messages should be displayed inline:

```javascript
export function displayError(panelId, errorMessage, lineNumber) {
  const panelElement = document.getElementById(panelId);
  if (!panelElement) return;

  // Remove existing error
  clearErrorMessage(panelId);

  // Create error element
  const errorEl = document.createElement('div');
  errorEl.className = 'pattern-error';
  errorEl.textContent = lineNumber
    ? `Line ${lineNumber}: ${errorMessage}`
    : errorMessage;

  // Add to panel
  const panelBody = panelElement.querySelector('.panel-body');
  panelBody.appendChild(errorEl);

  // Apply error styling
  panelElement.classList.add('panel-error');

  eventBus.emit('pattern:invalid', { panelId, error: errorMessage, line: lineNumber });
}

export function clearErrorMessage(panelId) {
  const panelElement = document.getElementById(panelId);
  if (!panelElement) return;

  // Remove error element
  const errorEl = panelElement.querySelector('.pattern-error');
  if (errorEl) {
    errorEl.remove();
  }

  // Remove error styling
  panelElement.classList.remove('panel-error');

  eventBus.emit('pattern:valid', { panelId });
}
```

### Staleness Detection
[Source: bmad/prd/epic-10-ui-module-extraction.md#story-103]

Staleness detection compares current code with last evaluated code:

```javascript
// Module-private storage
const lastEvaluatedCode = new Map();

export function checkStaleness(panelId) {
  const panelElement = document.getElementById(panelId);
  if (!panelElement) return false;

  // Get current code from editor
  const currentCode = getPanelCode(panelId); // Helper function

  // Get last evaluated code
  const lastCode = lastEvaluatedCode.get(panelId) || '';

  // Compare
  const isStale = currentCode !== lastCode;

  if (isStale) {
    eventBus.emit('panel:stale', { panelId });
  }

  return isStale;
}

// Call this when pattern is evaluated
eventBus.on('panel:evaluated', ({ panelId, code }) => {
  lastEvaluatedCode.set(panelId, code);
});
```

### Button State Logic
[Source: bmad/prd/epic-10-ui-module-extraction.md#story-103]

ACTIVATE button state logic:

```javascript
export function updateActivateButton(panelId) {
  const panelElement = document.getElementById(panelId);
  if (!panelElement) return;

  const activateBtn = panelElement.querySelector('.action-activate');
  if (!activateBtn) return;

  // Get panel state
  const panelState = panelManager.getPanelState(panelId);
  const isPlaying = panelState?.playing || false;
  const isStale = checkStaleness(panelId);
  const validation = validateCode(panelId, getPanelCode(panelId));

  // Button text
  if (isStale && isPlaying) {
    activateBtn.textContent = 'UPDATE';
  } else {
    activateBtn.textContent = 'ACTIVATE';
  }

  // Button enabled state
  if (validation.valid && (isStale || !isPlaying)) {
    activateBtn.disabled = false;
  } else {
    activateBtn.disabled = true;
  }
}
```

PAUSE button state logic:

```javascript
export function updatePauseButton(panelId) {
  const panelElement = document.getElementById(panelId);
  if (!panelElement) return;

  const pauseBtn = panelElement.querySelector('.action-pause');
  if (!pauseBtn) return;

  // Get panel state
  const panelState = panelManager.getPanelState(panelId);
  const isPlaying = panelState?.playing || false;

  // Enable only if playing
  pauseBtn.disabled = !isPlaying;

  // Optional: Show/hide instead of enable/disable
  pauseBtn.style.display = isPlaying ? 'inline-block' : 'none';
}
```

### Event Bus Integration
[Source: bmad/architecture/frontend-architecture.md#event-bus-pattern]

**Events to EMIT:**
- `pattern:valid` - Pattern syntax valid
- `pattern:invalid` - Pattern syntax invalid (includes error details)
- `panel:stale` - Panel code changed since last eval

**Events to LISTEN:**
- `panel:codeChanged` - Panel code edited (trigger validation)
- `panel:evaluated` - Panel pattern evaluated (store code, clear staleness)

### Transpiler vs Master Panel
[Source: bmad/architecture/strudel-integration-gotchas.md#where-transpiler-is-safe]

**Transpiler is SAFE for panel pattern validation:**
- ✅ Used for pattern code that will be evaluated by `evaluate()`
- ✅ Called within event handlers (not master panel context)
- ✅ No blocking issues

**Transpiler is UNSAFE for master panel:**
- ❌ Hangs when called in master panel context
- ❌ Use regex parsing instead (Story 10.2)

### Module Structure
[Source: bmad/architecture/coding-standards.md#file-organization]

```javascript
// src/ui/patternValidator.js

/**
 * Pattern Validator Module
 *
 * Handles pattern syntax validation, error display, and staleness detection.
 * Uses Strudel transpiler for validation (safe in panel context).
 */

// ===== 1. IMPORTS =====
import { transpiler } from '@strudel/transpiler';
import { panelManager } from '../managers/panelManager.js';
import { eventBus } from '../utils/eventBus.js';

// ===== 2. MODULE-PRIVATE STATE =====
const lastEvaluatedCode = new Map(); // panelId -> code

// ===== 3. HELPER FUNCTIONS =====
function getPanelCode(panelId) { ... }

// ===== 4. EXPORTED FUNCTIONS =====
export function validateCode(panelId, code) { ... }
export function displayError(panelId, errorMessage, lineNumber) { ... }
export function clearErrorMessage(panelId) { ... }
export function checkStaleness(panelId) { ... }
export function updateActivateButton(panelId) { ... }
export function updatePauseButton(panelId) { ... }

// ===== 5. EVENT BUS SETUP =====
eventBus.on('panel:codeChanged', ({ panelId, code }) => { ... });
eventBus.on('panel:evaluated', ({ panelId, code }) => { ... });
```

### File Paths and Locations
[Source: bmad/architecture/source-tree.md#proposed-structure-with-skin-system]

- **Create:** `src/ui/patternValidator.js`
- **Import from:** `src/managers/panelManager.js`
- **Import from:** `src/utils/eventBus.js`
- **Import from:** `@strudel/transpiler`
- **Import in:** `src/main.js` (Story 10.4)

### Extract, Don't Refactor
[Source: bmad/prd/epic-10-ui-module-extraction.md#technical-guidance]

**Extract existing validation logic from main.js AS-IS:**
- Lines 1357-1455 of original main.js (approximately)
- Maintain identical validation behavior
- Do not improve error messages during extraction
- Focus on moving code to dedicated module

### Error Styling
[Source: bmad/prd/epic-10-ui-module-extraction.md#story-103]

Error display should apply CSS classes for styling:
- **`.panel-error`** - Applied to panel element when error exists
- **`.pattern-error`** - Error message element class

Example CSS (should already exist in base.css):
```css
.panel-error {
  border-color: var(--color-error, #ff4444);
}

.pattern-error {
  color: var(--color-error, #ff4444);
  background: var(--color-error-bg, rgba(255, 68, 68, 0.1));
  padding: 8px;
  margin: 8px 0;
  border-radius: 4px;
  font-size: 0.9em;
}
```

## Testing

### Testing Standards

**Manual Testing:**

1. **Valid Pattern:**
   - Enter valid code: `s('bd hh')`
   - Verify no error displayed
   - Verify ACTIVATE button enabled
   - Verify `pattern:valid` event emitted
   - Verify no console errors

2. **Invalid Pattern:**
   - Enter invalid code: `s('bd hh'`  (missing closing paren)
   - Verify error message displayed
   - Verify error shows line number (if available)
   - Verify ACTIVATE button disabled
   - Verify `pattern:invalid` event emitted
   - Verify panel has error styling

3. **Error Clearing:**
   - Enter invalid code → verify error shown
   - Fix code → verify error removed
   - Verify error styling removed
   - Verify `pattern:valid` event emitted

4. **Staleness Detection:**
   - Evaluate pattern → code stored as "last evaluated"
   - Edit code → verify `panel:stale` event emitted
   - Verify ACTIVATE button text changes to "UPDATE"
   - Evaluate again → staleness cleared
   - Verify button text returns to "ACTIVATE"

5. **Button States:**
   - **Not playing, valid code:** ACTIVATE enabled
   - **Not playing, invalid code:** ACTIVATE disabled
   - **Playing, not stale:** ACTIVATE disabled, PAUSE enabled
   - **Playing, stale:** ACTIVATE enabled (shows "UPDATE"), PAUSE enabled
   - Verify button states update correctly

6. **Event Bus Integration:**
   - Emit `panel:codeChanged` → verify validation triggered
   - Emit `panel:evaluated` → verify lastEvaluatedCode updated
   - Verify event listeners working
   - Check console for event logs

7. **Visual Regression:**
   - Application looks identical before/after
   - Error display styling unchanged
   - Button states update correctly
   - No layout shifts

### Expected Outcomes

- ✅ `src/ui/patternValidator.js` created
- ✅ Pattern validation working (transpiler-based)
- ✅ Error display functional
- ✅ Staleness detection accurate
- ✅ Button states update correctly
- ✅ Event bus integration working
- ✅ Application functions identically
- ✅ No console errors

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-09 | 1.0 | Story created for Epic 10 | Bob (SM) |

## Dev Agent Record

### Agent Model Used
(To be filled by Dev agent)

### Debug Log References
(To be filled by Dev agent)

### Completion Notes List
(To be filled by Dev agent)

### File List
(To be filled by Dev agent)

## QA Results
(To be filled by QA agent)

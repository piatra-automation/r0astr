# Story 7.2: Default Panel Dimensions

## Status
Ready for Review

## Story

**As a** live coder,
**I want** to configure default panel width and height,
**so that** new panels start at my preferred size

## Acceptance Criteria

1. Settings includes `settings.default_w` (default: 600) and `settings.default_h` (default: 400)
2. New panels created after setting change use configured dimensions
3. Existing panels retain their current size (not retroactively resized)
4. Valid range: width 300-2000px, height 200-1500px
5. Settings UI includes number inputs with validation
6. Settings persist in localStorage

## Tasks / Subtasks

- [x] **Task 1: Add default_w and default_h to settings schema** (AC: 1, 6)
  - [x] Update `DEFAULT_SETTINGS` in `src/managers/settingsManager.js`
  - [x] Add `default_w: 600` and `default_h: 400` to settings object
  - [x] Document valid ranges in JSDoc comments
  - [x] Ensure settings saved/loaded with other settings

- [x] **Task 2: Create validation function for dimensions** (AC: 4)
  - [x] Create `validateDimension(value, min, max)` helper function
  - [x] Width validation: clamp between 300-2000px
  - [x] Height validation: clamp between 200-1500px
  - [x] Return sanitized value or error message

- [x] **Task 3: Update panel creation to use default dimensions** (AC: 2, 3)
  - [x] Modify `createPanel()` in `src/managers/panelManager.js` (or main.js)
  - [x] Read `settings.default_w` and `settings.default_h` from settingsManager
  - [x] Apply dimensions to new panel: `panel.style.width = ${default_w}px`
  - [x] Apply dimensions to new panel: `panel.style.height = ${default_h}px`
  - [x] Do NOT modify existing panels (only apply to newly created panels)

- [x] **Task 4: Add dimension inputs in Settings UI** (AC: 5)
  - [x] Add number inputs in Settings panel (Story 4.3 or 4.4)
  - [x] HTML: `<input type="number" id="default-width" min="300" max="2000">`
  - [x] HTML: `<input type="number" id="default-height" min="200" max="1500">`
  - [x] Labels: "Default panel width (px)" and "Default panel height (px)"
  - [x] Display current values from settings

- [x] **Task 5: Implement input validation** (AC: 4, 5)
  - [x] Attach `input` or `change` event listener to dimension inputs
  - [x] Validate on change: ensure value within valid range
  - [x] Display validation error if out of range (e.g., red border)
  - [x] Prevent saving invalid values to settings

- [x] **Task 6: Wire dimension inputs to settings** (AC: 1, 6)
  - [x] Bind input values to `settings.default_w` and `settings.default_h`
  - [x] On change: validate input, update settings, save to localStorage
  - [x] Debounce save (200ms) to prevent excessive writes while typing
  - [x] Show validation feedback (e.g., green checkmark when valid)

- [x] **Task 7: Test with dynamic panel creation** (AC: 2, 3)
  - [x] Create panel with default settings (600x400)
  - [x] Change default dimensions in Settings (e.g., 800x500)
  - [x] Create new panel → verify it uses new dimensions (800x500)
  - [x] Verify existing panel still has old dimensions (600x400)

## Dev Notes

### Settings Schema Update
[Source: Epic 4, Story 4.1, epic-7-text-panel-improvements.md]

Add `default_w` and `default_h` to default settings:
```javascript
const DEFAULT_SETTINGS = {
  version: 1,
  yolo: false,
  colorScheme: 'dark',
  wrap_lines: false,
  default_w: 600,           // NEW: Default panel width in px
  default_h: 400,           // NEW: Default panel height in px
  behavior: { ... },
  snippetLocation: '',
  remoteWSLayout: 'side-panel',
  skinPack: ''
};
```

### Valid Range Constraints
[Source: AC: 4, epic-7-text-panel-improvements.md]

Dimension constraints:
- **Width:** 300px (minimum) to 2000px (maximum)
- **Height:** 200px (minimum) to 1500px (maximum)

Rationale:
- Minimum width/height ensures usability (textarea not too cramped)
- Maximum width/height prevents panels from being unreasonably large

### Validation Function
[Source: AC: 4]

```javascript
function validateDimension(value, min, max) {
  const numValue = parseInt(value, 10);

  // Check if valid number
  if (isNaN(numValue)) {
    return { valid: false, error: 'Must be a number' };
  }

  // Clamp to valid range
  if (numValue < min) {
    return { valid: false, error: `Minimum value is ${min}px` };
  }
  if (numValue > max) {
    return { valid: false, error: `Maximum value is ${max}px` };
  }

  return { valid: true, value: numValue };
}
```

### Panel Creation Integration
[Source: AC: 2, 3, Story 1.1]

Modify `createPanel()` to apply default dimensions:
```javascript
function createPanel(options = {}) {
  const settings = getSettings(); // From settingsManager
  const panelId = generatePanelId();

  // Create panel HTML
  const panel = document.createElement('div');
  panel.className = 'card';
  panel.id = panelId;

  // Apply default dimensions from settings (only for new panels)
  panel.style.width = `${settings.default_w}px`;
  panel.style.height = `${settings.default_h}px`;

  // Panel content (header, textarea, buttons)
  panel.innerHTML = `
    <div class="card-header">
      <h3>Instrument ${panelCount}</h3>
      <button class="control-btn" data-card="${panelId}">Play</button>
    </div>
    <textarea class="code-input" data-card="${panelId}"></textarea>
  `;

  // Attach to DOM
  document.body.appendChild(panel);

  return panelId;
}
```

### Non-Retroactive Behavior
[Source: AC: 3]

Key principle: **Only new panels use updated dimensions**

```javascript
// ✅ Correct: Only apply to newly created panels
function createPanel() {
  panel.style.width = `${settings.default_w}px`; // Applied at creation time
}

// ❌ Wrong: Retroactively resize all panels
function applyDefaultDimensions() {
  document.querySelectorAll('.card').forEach(panel => {
    panel.style.width = `${settings.default_w}px`; // Don't do this!
  });
}
```

Rationale:
- User may have manually resized existing panels (Story 2.2)
- Changing default dimensions should not disrupt current layout
- Only affects future panel creation

### Settings UI Integration
[Source: Epic 4, Story 4.4, AC: 5]

Add dimension inputs in Settings panel:
```html
<div class="setting-group">
  <h4>Default Panel Dimensions</h4>

  <div class="setting-row">
    <label for="default-width">Default panel width (px)</label>
    <input type="number" id="default-width" min="300" max="2000" step="10">
    <span class="validation-message" id="width-validation"></span>
  </div>

  <div class="setting-row">
    <label for="default-height">Default panel height (px)</label>
    <input type="number" id="default-height" min="200" max="1500" step="10">
    <span class="validation-message" id="height-validation"></span>
  </div>

  <p class="setting-description">
    New panels will be created with these dimensions. Existing panels are not affected.
  </p>
</div>
```

### Input Validation and Feedback
[Source: AC: 4, 5]

```javascript
// Initialize inputs with current settings
const widthInput = document.querySelector('#default-width');
const heightInput = document.querySelector('#default-height');

widthInput.value = settings.default_w;
heightInput.value = settings.default_h;

// Validate and update on change
widthInput.addEventListener('input', (e) => {
  const result = validateDimension(e.target.value, 300, 2000);
  const validationMsg = document.querySelector('#width-validation');

  if (result.valid) {
    validationMsg.textContent = '✓';
    validationMsg.className = 'validation-message valid';
    updateSettings('default_w', result.value);
  } else {
    validationMsg.textContent = result.error;
    validationMsg.className = 'validation-message invalid';
  }
});

heightInput.addEventListener('input', (e) => {
  const result = validateDimension(e.target.value, 200, 1500);
  const validationMsg = document.querySelector('#height-validation');

  if (result.valid) {
    validationMsg.textContent = '✓';
    validationMsg.className = 'validation-message valid';
    updateSettings('default_h', result.value);
  } else {
    validationMsg.textContent = result.error;
    validationMsg.className = 'validation-message invalid';
  }
});
```

### CSS for Validation Feedback
[Source: AC: 5]

```css
.validation-message {
  font-size: 0.85em;
  margin-left: 0.5em;
}

.validation-message.valid {
  color: #98c379; /* Green */
}

.validation-message.invalid {
  color: #e06c75; /* Red */
}

input[type="number"]:invalid {
  border-color: #e06c75; /* Red border */
}

input[type="number"]:valid {
  border-color: #98c379; /* Green border */
}
```

### Debounced Save Pattern
[Source: Epic 4, Story 4.1]

Debounce settings save to prevent excessive localStorage writes:
```javascript
let saveTimeout;

function debouncedUpdateSettings(key, value) {
  currentSettings[key] = value;

  clearTimeout(saveTimeout);
  saveTimeout = setTimeout(() => {
    saveSettings(currentSettings);
  }, 200); // Wait 200ms after user stops typing
}
```

### Integration with Resizable Panels
[Source: Epic 2, Story 2.2]

Default dimensions are **initial size only**:
- User can resize panels manually after creation (Story 2.2)
- Resized dimensions override defaults for that panel
- Resized dimensions persist if panel state saved (Story 4.2)

### HTML5 Input Validation
[Source: AC: 5]

Leverage HTML5 input attributes for basic validation:
```html
<input type="number"
       id="default-width"
       min="300"
       max="2000"
       step="10"
       required>
```

This provides:
- Browser-native validation UI
- Keyboard controls (up/down arrows)
- Prevents non-numeric input

### Testing

Manual testing checklist:

- [ ] Default settings: New panel created at 600x400px
- [ ] Change default width: New panel created at new width
- [ ] Change default height: New panel created at new height
- [ ] Existing panels: Not resized when default dimensions change
- [ ] Invalid input: Width < 300px shows validation error
- [ ] Invalid input: Width > 2000px shows validation error
- [ ] Invalid input: Height < 200px shows validation error
- [ ] Invalid input: Height > 1500px shows validation error
- [ ] Settings persist: Reload page, default dimensions restored
- [ ] Combined with resize: User can manually resize panel after creation

## Dependencies

- Epic 4: Settings System (Story 4.1 for settingsManager, Story 4.3/4.4 for Settings UI)
- Epic 1: Dynamic Panel Management (Story 1.1 for panel creation)

## Related Stories

- Story 1.1: Add New Panel Button (panel creation logic)
- Story 2.2: Resizable Panels (manual resize after creation)
- Story 4.1: Settings JSON Structure and Storage (settings persistence)
- Story 4.4: Behavior Settings Controls (Settings UI controls)

## Change Log

| Date       | Version | Description          | Author |
|------------|---------|----------------------|--------|
| 2025-11-16 | 1.0     | Initial story draft  | Claude |

## Dev Agent Record

### Agent Model Used

claude-sonnet-4-5-20250929

### Debug Log References

None required - implementation completed without blocking issues

### Completion Notes List

- Added `default_w: 600` and `default_h: 400` to DEFAULT_SETTINGS in settingsManager.js
- Implemented validation for default_w (300-2000px) and default_h (200-1500px) in validateSettings()
- Updated createPanel() to use settings.default_w and settings.default_h instead of hardcoded values
- Added number input controls in Settings UI (Appearance section) for both dimensions
- Added CSS styles for .setting-number-input and .validation-message
- Implemented real-time validation with visual feedback (✓ for valid, error messages for invalid)
- Values update live as user types, with immediate validation and persistence to localStorage
- New panels automatically use current default dimensions; existing panels unaffected (non-retroactive)

### File List

- `src/managers/settingsManager.js` - Added default_w/default_h settings and validation
- `src/managers/panelManager.js` - Updated createPanel() to use default dimensions from settings
- `index.html` - Added number inputs UI and CSS for validation
- `src/ui/settingsModal.js` - Added loading, saving, and validation for dimension inputs

## QA Results

_Results from QA Agent review of the completed story implementation_

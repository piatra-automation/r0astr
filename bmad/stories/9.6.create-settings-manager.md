# Story 9.6: Create Settings Manager Module

## Status
Ready for Development

## Story

**As a** developer,
**I want** settings persistence logic extracted to a dedicated module,
**so that** settings can be managed independently

## Acceptance Criteria

1. Create `src/managers/settingsManager.js`
2. Implement functions:
   - `loadSettings()` - Reads from localStorage, returns default on error
   - `saveSettings(settings)` - Writes to localStorage
   - `getSettings()` - Returns current settings object
3. Define default settings structure:
   ```javascript
   {
     appearance: { colorScheme: 'dark', fontSize: 14 },
     skin: { enabled: true, currentSkin: 'default' },
     audio: { sampleLibrary: 'dirt-samples' }
   }
   ```
4. Use event bus: `eventBus.emit('settings:saved', settings)`
5. Graceful error handling (malformed JSON falls back to defaults)

## Tasks / Subtasks

- [ ] **Task 1: Create settings manager file** (AC: 1)
  - [ ] Create `src/managers/settingsManager.js`
  - [ ] Add file header with module description

- [ ] **Task 2: Define default settings** (AC: 3)
  - [ ] Create `defaultSettings` constant with structure:
    ```javascript
    const defaultSettings = {
      appearance: {
        colorScheme: 'dark',
        fontSize: 14
      },
      skin: {
        enabled: true,
        currentSkin: 'default',
        allowUntrustedSkins: false
      },
      audio: {
        sampleLibrary: 'dirt-samples'
      }
    };
    ```
  - [ ] Export defaultSettings for reference

- [ ] **Task 3: Implement loadSettings() function** (AC: 2, 5)
  - [ ] Function signature: `loadSettings()`
  - [ ] Try to read from localStorage: `localStorage.getItem('r0astr-settings')`
  - [ ] If exists, parse JSON
  - [ ] Deep merge with defaultSettings (handle partial saves)
  - [ ] On error (malformed JSON), log warning and return defaults
  - [ ] Return settings object
  - [ ] Export function

- [ ] **Task 4: Implement saveSettings() function** (AC: 2, 4)
  - [ ] Function signature: `saveSettings(settings)`
  - [ ] Validate settings object (basic structure check)
  - [ ] Stringify to JSON
  - [ ] Write to localStorage: `localStorage.setItem('r0astr-settings', json)`
  - [ ] On error, log and throw exception
  - [ ] Emit event: `eventBus.emit('settings:saved', settings)`
  - [ ] Export function

- [ ] **Task 5: Implement getSettings() function** (AC: 2)
  - [ ] Module-private `currentSettings` variable
  - [ ] Initialize with `loadSettings()` on first call
  - [ ] Function signature: `getSettings()`
  - [ ] Return `currentSettings`
  - [ ] Export function

- [ ] **Task 6: Implement deep merge utility**
  - [ ] Function: `deepMerge(defaults, saved)`
  - [ ] Handle nested objects (appearance, skin, audio)
  - [ ] Preserve defaults for missing keys
  - [ ] Override defaults with saved values
  - [ ] Return merged object

- [ ] **Task 7: Add error handling**
  - [ ] Try-catch around JSON.parse in loadSettings
  - [ ] Try-catch around JSON.stringify in saveSettings
  - [ ] Try-catch around localStorage access (quota exceeded)
  - [ ] Log errors to console with helpful messages

- [ ] **Task 8: Add JSDoc documentation**
  - [ ] Document loadSettings() with @returns
  - [ ] Document saveSettings() with @param
  - [ ] Document getSettings() with @returns
  - [ ] Add usage examples

- [ ] **Task 9: Import event bus**
  - [ ] Import: `import { eventBus } from '../utils/eventBus.js'`
  - [ ] Use in saveSettings()

- [ ] **Task 10: Test settings persistence**
  - [ ] Test saveSettings() writes to localStorage
  - [ ] Test loadSettings() reads from localStorage
  - [ ] Test malformed JSON gracefully falls back
  - [ ] Test deep merge with partial settings
  - [ ] Test event emission on save

## Dev Notes

### Settings Manager Implementation
[Source: architecture/frontend-architecture.md#settings-state-localstorage]

```javascript
// src/managers/settingsManager.js

import { eventBus } from '../utils/eventBus.js';

const STORAGE_KEY = 'r0astr-settings';

const defaultSettings = {
  appearance: {
    colorScheme: 'dark',
    fontSize: 14
  },
  skin: {
    enabled: true,
    currentSkin: 'default',
    allowUntrustedSkins: false
  },
  audio: {
    sampleLibrary: 'dirt-samples'
  }
};

let currentSettings = null;

/**
 * Load settings from localStorage
 * @returns {object} Settings object (merged with defaults)
 */
export function loadSettings() {
  try {
    const saved = localStorage.getItem(STORAGE_KEY);

    if (saved) {
      const parsed = JSON.parse(saved);
      return deepMerge(defaultSettings, parsed);
    }
  } catch (error) {
    console.warn('Failed to load settings, using defaults:', error);
  }

  return { ...defaultSettings };
}

/**
 * Save settings to localStorage
 * @param {object} settings - Settings object
 */
export function saveSettings(settings) {
  try {
    const json = JSON.stringify(settings);
    localStorage.setItem(STORAGE_KEY, json);

    currentSettings = settings;

    eventBus.emit('settings:saved', settings);
  } catch (error) {
    console.error('Failed to save settings:', error);
    throw error;
  }
}

/**
 * Get current settings (loads from storage on first call)
 * @returns {object} Current settings
 */
export function getSettings() {
  if (!currentSettings) {
    currentSettings = loadSettings();
  }
  return currentSettings;
}

/**
 * Deep merge two objects
 * @private
 */
function deepMerge(defaults, saved) {
  const result = { ...defaults };

  for (const key in saved) {
    if (typeof saved[key] === 'object' && !Array.isArray(saved[key])) {
      result[key] = { ...defaults[key], ...saved[key] };
    } else {
      result[key] = saved[key];
    }
  }

  return result;
}

export { defaultSettings };
```

### Storage Key
[Source: epic-4-settings-system.md#story-41]

- Storage key: `r0astr-settings`
- Namespace prevents conflicts with other apps
- localStorage is synchronous (no async needed)

### Default Settings Structure
[Source: architecture/frontend-architecture.md#settings-state-localstorage]

```javascript
{
  appearance: {
    colorScheme: 'dark',  // 'dark' | 'light'
    fontSize: 14          // px
  },
  skin: {
    enabled: true,         // Enable skin system
    currentSkin: 'default', // Skin folder name
    allowUntrustedSkins: false
  },
  audio: {
    sampleLibrary: 'dirt-samples'  // Sample library URL
  }
}
```

### Deep Merge Rationale
If user has partial settings saved:
```javascript
// Saved: { appearance: { colorScheme: 'light' } }
// Merged result:
{
  appearance: {
    colorScheme: 'light',  // From saved
    fontSize: 14           // From defaults (preserved)
  },
  skin: { ...defaults },   // Entirely from defaults
  audio: { ...defaults }
}
```

### Error Handling Strategy
[Source: epic-9-code-architecture-refactor.md#acceptance-criteria]

- **JSON.parse error**: Return defaults, log warning
- **localStorage quota exceeded**: Throw error (caller handles)
- **Malformed saved data**: Gracefully fall back to defaults

### Event Bus Integration
[Source: architecture/frontend-architecture.md#event-bus-pattern]

Settings events:
- `settings:saved` - Emitted after successful localStorage write
  - Payload: Full settings object
  - Other managers can listen (e.g., skin manager reloads skin)

### Browser Compatibility
[Source: architecture/tech-stack.md#browser-compatibility]

localStorage supported in all target browsers:
- Chrome 4+ (2010)
- Firefox 3.5+ (2009)
- Safari 4+ (2009)

No polyfill needed.

### localStorage Size Limits
- Typical limit: 5-10MB per origin
- Settings object: ~1KB (well within limits)
- Quota exceeded errors very unlikely for settings

## Testing

### Testing Standards

**Manual Testing:**

1. **Save Settings:**
   - Call `saveSettings({ appearance: { colorScheme: 'light' } })`
   - Open DevTools → Application → Local Storage
   - Verify `r0astr-settings` key exists
   - Verify JSON value correct

2. **Load Settings:**
   - Manually edit localStorage value
   - Call `loadSettings()`
   - Verify returns merged object with defaults

3. **Malformed JSON Handling:**
   - Set localStorage to invalid JSON: `localStorage.setItem('r0astr-settings', '{invalid')`
   - Call `loadSettings()`
   - Verify returns defaults
   - Verify warning logged to console

4. **Deep Merge:**
   - Save partial settings: `{ appearance: { fontSize: 18 } }`
   - Load settings
   - Verify `colorScheme` preserved from defaults
   - Verify `fontSize` overridden to 18

5. **Event Emission:**
   - Listen for event: `eventBus.on('settings:saved', console.log)`
   - Call `saveSettings({})`
   - Verify event emitted with settings object

### Expected Outcomes

- ✅ `src/managers/settingsManager.js` exists
- ✅ Settings save to localStorage
- ✅ Settings load from localStorage
- ✅ Malformed JSON gracefully falls back to defaults
- ✅ Deep merge preserves missing keys
- ✅ Events emitted on save

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-09 | 1.0 | Story created for Epic 9 | Bob (SM) |

## Dev Agent Record

### Agent Model Used
(To be filled by dev agent)

### Debug Log References
(To be filled by dev agent)

### Completion Notes List
(To be filled by dev agent)

### File List
(To be filled by dev agent)

## QA Results
(To be filled by QA agent)

# Story 9.10: Verification and Regression Testing

## Status
Ready for Development

## Story

**As a** developer,
**I want** to verify the refactor introduces no regressions,
**so that** users experience zero downtime or bugs

## Acceptance Criteria

1. **Functional Testing:**
   - Create panel → plays pattern → sliders work → delete panel
   - WebSocket remote control functions (play, pause, update code)
   - Settings persistence (save → reload → verify restored)
   - Master panel sliders control all panels
2. **Visual Regression:**
   - Screenshot comparison before/after refactor (identical)
   - No layout shifts or color changes
   - Z-index/layering unchanged
3. **Performance Testing:**
   - Pattern evaluation latency unchanged (< 10ms)
   - Initial load time similar (± 100ms acceptable)
   - Memory usage stable
4. **Code Quality:**
   - No ESLint errors (if linter configured)
   - All imports resolve correctly
   - No console errors

## Tasks / Subtasks

- [ ] **Task 1: Functional Testing - Panel Lifecycle** (AC: 1)
  - [ ] Test: Create new panel
    - Verify panel appears in UI
    - Verify panel added to panelState
    - Verify event emitted
  - [ ] Test: Play pattern
    - Enter pattern code: `note("c2 e2 g2")`
    - Click Play
    - Verify audio plays
    - Verify button state changes to Pause
  - [ ] Test: Pause pattern
    - Click Pause
    - Verify audio stops
    - Verify button state changes to Play
  - [ ] Test: Delete panel
    - Click Delete
    - Verify panel removed from DOM
    - Verify panel removed from panelState

- [ ] **Task 2: Functional Testing - Sliders** (AC: 1)
  - [ ] Test: Slider rendering
    - Enter pattern: `note("c2").lpf(slider(800, 100, 5000))`
    - Click Play
    - Verify slider appears
    - Verify label shows value
  - [ ] Test: Slider interaction
    - Move slider
    - Verify label updates
    - Verify audio changes (filter adjusts)
    - Verify pattern re-evaluates

- [ ] **Task 3: Functional Testing - Master Panel** (AC: 1)
  - [ ] Test: Global sliders
    - Add to master panel: `let SLIDER_LPF = slider(800, 100, 5000)`
    - In panel 1: `note("c2").lpf(SLIDER_LPF)`
    - In panel 2: `note("e2").lpf(SLIDER_LPF)`
    - Play both panels
    - Move master slider
    - Verify both panels affected

- [ ] **Task 4: Functional Testing - Settings** (AC: 1)
  - [ ] Test: Save settings
    - Open settings modal
    - Change appearance settings
    - Save
    - Verify localStorage updated
  - [ ] Test: Load settings
    - Reload page
    - Verify settings restored
    - Verify UI reflects saved settings

- [ ] **Task 5: Functional Testing - WebSocket** (AC: 1)
  - [ ] Test: Remote control connection
    - Start WebSocket server: `npm run server`
    - Open remote control: `localhost:5173/remote`
    - Verify connection established
  - [ ] Test: Remote play/pause
    - Click Play on remote
    - Verify main app plays pattern
    - Click Pause on remote
    - Verify main app pauses
  - [ ] Test: State sync
    - Create panel in main app
    - Verify remote UI shows new panel

- [ ] **Task 6: Visual Regression Testing** (AC: 2)
  - [ ] Take screenshots BEFORE refactor (baseline)
    - Homepage
    - Panel playing
    - Sliders rendered
    - Settings modal
  - [ ] Take screenshots AFTER refactor
    - Same states as baseline
  - [ ] Compare pixel-by-pixel
    - Use image diff tool or browser DevTools
    - Verify no visual changes
  - [ ] Check specific elements:
    - Card layout
    - Button styles
    - Slider styles
    - Colors (dark theme)
    - Typography

- [ ] **Task 7: Performance Testing** (AC: 3)
  - [ ] Measure pattern evaluation latency
    - Before refactor: Evaluate pattern, measure time
    - After refactor: Repeat, compare
    - Verify < 10ms (should be nearly identical)
  - [ ] Measure initial load time
    - Before: Measure DOMContentLoaded → page ready
    - After: Repeat
    - Verify ± 100ms (acceptable variance)
  - [ ] Measure memory usage
    - Before: Check DevTools Memory profiler
    - After: Repeat
    - Verify stable (no leaks)

- [ ] **Task 8: Code Quality Checks** (AC: 4)
  - [ ] Check browser console
    - Verify no errors
    - Verify no warnings (except expected)
  - [ ] Check import resolution
    - All imports resolve (no 404s)
    - All ES module syntax correct
  - [ ] Check ESLint (if configured)
    - Run: `npm run lint` (if exists)
    - Fix any errors
  - [ ] Check file structure
    - All files in correct directories
    - No orphaned files

- [ ] **Task 9: Cross-Browser Testing** (AC: 2)
  - [ ] Test in Chrome
    - All functional tests pass
    - Visual regression check
  - [ ] Test in Firefox
    - All functional tests pass
    - Visual regression check
  - [ ] Test in Safari
    - All functional tests pass
    - Visual regression check

- [ ] **Task 10: Document Test Results**
  - [ ] Create test report
  - [ ] List all tests performed
  - [ ] Document any issues found
  - [ ] Verify all issues resolved
  - [ ] Sign off on refactor completion

## Dev Notes

### Testing Checklist
[Source: epic-9-code-architecture-refactor.md#story-910]

**Functional Tests:**
- ✅ Panel creation
- ✅ Panel play/pause
- ✅ Panel deletion
- ✅ Slider rendering
- ✅ Slider interaction
- ✅ Master panel globals
- ✅ Settings save/load
- ✅ WebSocket connection
- ✅ Remote control

**Visual Tests:**
- ✅ Layout unchanged
- ✅ Colors unchanged
- ✅ Typography unchanged
- ✅ No layout shifts

**Performance Tests:**
- ✅ Pattern eval < 10ms
- ✅ Load time ± 100ms
- ✅ Memory stable

**Code Quality:**
- ✅ No console errors
- ✅ Imports resolve
- ✅ ESLint clean

### Screenshot Comparison Tools
[Source: architecture/frontend-architecture.md#testing-requirements]

**Options:**
1. **Manual:** Take screenshots, overlay in image editor
2. **Browser DevTools:** Chrome Device Toolbar → Screenshot
3. **Automated (future):** Percy, BackstopJS, Chromatic

For this story: **Manual comparison** is acceptable.

### Performance Measurement
[Source: epic-9-code-architecture-refactor.md#acceptance-criteria]

**Pattern Evaluation:**
```javascript
const start = performance.now();
await evaluate(code, true, false);
const duration = performance.now() - start;
console.log('Evaluation time:', duration, 'ms');
// Expected: < 10ms
```

**Initial Load Time:**
```javascript
// In main.js
const loadStart = performance.now();

window.addEventListener('load', () => {
  const loadTime = performance.now() - loadStart;
  console.log('Load time:', loadTime, 'ms');
  // Expected: 2000-3000ms (Vite dev mode)
});
```

**Memory Usage:**
- Chrome DevTools → Memory tab → Take snapshot
- Before refactor: ~50-100MB
- After refactor: Should be similar (no leaks)

### Critical Gotchas to Test
[Source: architecture/strudel-integration-gotchas.md]

1. **Transpiler in master panel:** Verify master panel still uses regex parsing (NOT transpiler)
2. **TEMPO slider:** Verify CPS conversion still works
3. **Slider reactivity:** Verify `sliderValues` ref pattern works
4. **Sample loading:** Verify dirt-samples pre-load works

### Browser Compatibility
[Source: architecture/tech-stack.md#browser-compatibility]

**Test in:**
- Chrome 91+ (primary)
- Firefox 89+
- Safari 14.1+

**Known Limitations:**
- Safari autoplay policy (expected)
- Firefox AudioWorklet latency (acceptable)

### Expected Console Output
After refactor, console should show:
- ✅ "Strudel initialized"
- ✅ "WebSocket connected" (if server running)
- ✅ No import errors
- ✅ No undefined errors

### What Changes Are Acceptable

**Acceptable:**
- Load time ± 100ms (network variance)
- Minor memory usage differences (< 5MB)
- Different log order (async timing)

**NOT Acceptable:**
- Visual changes (pixel differences)
- Functional regressions (features broken)
- Performance degradation (> 10% slower)
- New console errors

## Testing

### Testing Standards
[Source: architecture/frontend-architecture.md#testing-requirements]

**Manual Testing (No automated tests yet):**

This story IS the manual testing for entire Epic 9.

### Test Matrix

| Test Category | Chrome | Firefox | Safari | Status |
|---------------|--------|---------|--------|--------|
| Panel CRUD | ☐ | ☐ | ☐ | Pending |
| Slider Rendering | ☐ | ☐ | ☐ | Pending |
| Settings Persistence | ☐ | ☐ | ☐ | Pending |
| WebSocket Sync | ☐ | ☐ | ☐ | Pending |
| Visual Regression | ☐ | ☐ | ☐ | Pending |
| Performance | ☐ | ☐ | ☐ | Pending |

### Test Report Template

```markdown
## Epic 9 Refactor Test Report

**Date:** YYYY-MM-DD
**Tester:** [Name]
**Build:** [Git commit hash]

### Functional Tests
- [ ] Panel creation: PASS/FAIL
- [ ] Panel play/pause: PASS/FAIL
- [ ] Slider rendering: PASS/FAIL
- [ ] Settings persistence: PASS/FAIL
- [ ] WebSocket sync: PASS/FAIL

### Visual Regression
- [ ] Layout unchanged: PASS/FAIL
- [ ] Colors unchanged: PASS/FAIL
- [ ] Typography unchanged: PASS/FAIL

### Performance
- Pattern eval: ____ ms (target: < 10ms)
- Load time: ____ ms (target: ± 100ms from baseline)
- Memory: ____ MB (target: stable)

### Issues Found
1. [Description]
2. [Description]

### Resolution
- All issues resolved: YES/NO
- Refactor approved: YES/NO

**Sign-off:** [Name, Date]
```

### Expected Outcomes

- ✅ All functional tests pass
- ✅ Visual regression: 0 pixel differences
- ✅ Performance: Within acceptable range
- ✅ Code quality: No errors
- ✅ Cross-browser: All browsers pass
- ✅ Epic 9 complete: Ready for production

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-09 | 1.0 | Story created for Epic 9 | Bob (SM) |

## Dev Agent Record

### Agent Model Used
(To be filled by dev agent)

### Debug Log References
(To be filled by dev agent)

### Completion Notes List
(To be filled by dev agent)

### File List
(To be filled by dev agent)

## QA Results
(To be filled by QA agent)

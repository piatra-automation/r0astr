# Story 9.3: Create Event Bus Module

## Status
DONE

## Story

**As a** developer,
**I want** a centralized event bus for cross-component communication,
**so that** modules are decoupled and easier to test

## Acceptance Criteria

1. Create `src/utils/eventBus.js` with EventBus class
2. Implement methods: `on(event, callback)`, `emit(event, data)`, `off(event, callback)`
3. Export singleton instance: `export const eventBus = new EventBus()`
4. Add JSDoc documentation for all methods
5. No external dependencies (vanilla JavaScript implementation)

## Tasks / Subtasks

- [x] **Task 1: Create utils directory and file** (AC: 1)
  - [x] Create `src/utils/` directory (already existed)
  - [x] Create `src/utils/eventBus.js` file
  - [x] Add file header comment with purpose

- [x] **Task 2: Implement EventBus class** (AC: 2, 5)
  - [x] Create `class EventBus {}`
  - [x] Add constructor: `this.listeners = new Map()`
  - [x] Implement `on(event, callback)` method:
    - Create array for event if not exists
    - Push callback to event's listener array
  - [x] Implement `emit(event, data)` method:
    - Get all callbacks for event
    - Call each callback with data
  - [x] Implement `off(event, callback)` method:
    - Remove specific callback from event's listeners
    - Filter out the callback from array

- [x] **Task 3: Export singleton instance** (AC: 3)
  - [x] Create single instance: `const eventBus = new EventBus()`
  - [x] Export instance: `export { eventBus }`
  - [x] Export class for testing: `export { EventBus }`

- [x] **Task 4: Add JSDoc documentation** (AC: 4)
  - [x] Document EventBus class
  - [x] Document `on()` method with @param and @example
  - [x] Document `emit()` method with @param and @example
  - [x] Document `off()` method with @param
  - [x] Add usage examples in file header

- [x] **Task 5: Create basic test (manual)**
  - [x] Created test-eventbus.html with comprehensive test suite
  - [x] Tests: basic emission, multiple listeners, remove listener, complex data
  - [x] Verify listener called with correct data
  - [x] Test `off()` removes listener

## Dev Notes

### Event Bus Implementation
[Source: architecture/frontend-architecture.md#event-bus-pattern]

```javascript
// src/utils/eventBus.js

/**
 * Event Bus for decoupled cross-component communication
 * @example
 * import { eventBus } from './utils/eventBus.js';
 *
 * // Listen for events
 * eventBus.on('panel:created', (panel) => {
 *   console.log('Panel created:', panel.id);
 * });
 *
 * // Emit events
 * eventBus.emit('panel:created', { id: 'panel-1', code: '...' });
 */
class EventBus {
  constructor() {
    this.listeners = new Map();
  }

  /**
   * Register event listener
   * @param {string} event - Event name (e.g., 'panel:created')
   * @param {Function} callback - Callback function to invoke
   */
  on(event, callback) {
    if (!this.listeners.has(event)) {
      this.listeners.set(event, []);
    }
    this.listeners.get(event).push(callback);
  }

  /**
   * Emit event with data
   * @param {string} event - Event name
   * @param {*} data - Data to pass to listeners
   */
  emit(event, data) {
    const callbacks = this.listeners.get(event) || [];
    callbacks.forEach(cb => cb(data));
  }

  /**
   * Remove event listener
   * @param {string} event - Event name
   * @param {Function} callback - Callback to remove
   */
  off(event, callback) {
    const callbacks = this.listeners.get(event) || [];
    this.listeners.set(event, callbacks.filter(cb => cb !== callback));
  }
}

export const eventBus = new EventBus();
export { EventBus }; // For testing
```

### Event Naming Convention
[Source: architecture/frontend-architecture.md#component-standards]

Use **namespaced event names** with colon separator:
- `panel:created`, `panel:deleted`, `panel:updated`
- `slider:changed`
- `skin:loaded`, `skin:error`
- `settings:saved`

### Why Map Instead of Object
[Source: architecture/frontend-architecture.md#state-management-architecture]

- Map has better performance for frequent additions/deletions
- Map preserves insertion order
- Map allows any value as key (not just strings)

### Future Manager Usage Examples
[Source: architecture/frontend-architecture.md#event-bus-pattern]

```javascript
// panelManager.js
import { eventBus } from '../utils/eventBus.js';

export function createPanel(id, code) {
  const panel = { id, code, playing: false };
  panels.set(id, panel);
  eventBus.emit('panel:created', panel);
  return panel;
}

// websocketManager.js
import { eventBus } from '../utils/eventBus.js';

eventBus.on('panel:created', (panel) => {
  broadcast('PANEL_CREATED', panel);
});
```

### File Location
[Source: architecture/source-tree.md#future-modular-architecture]

```
src/
├── utils/
│   └── eventBus.js  ← NEW FILE
```

## Testing

### Testing Standards
[Source: architecture/coding-standards.md#code-structure]

**Manual Testing (No test framework yet):**

1. **Basic Functionality:**
   - Import event bus in main.js
   - Register test listener: `eventBus.on('test', console.log)`
   - Emit event: `eventBus.emit('test', { data: 'hello' })`
   - Verify console output

2. **Multiple Listeners:**
   - Register 2+ listeners for same event
   - Emit event
   - Verify all listeners called

3. **Remove Listener:**
   - Register listener
   - Call `off()` with same callback reference
   - Emit event
   - Verify listener NOT called

4. **Data Passing:**
   - Emit event with complex data (object, array)
   - Verify listener receives exact data

### Expected Outcomes

- ✅ `src/utils/eventBus.js` exists
- ✅ EventBus class has `on()`, `emit()`, `off()` methods
- ✅ Singleton instance exported
- ✅ JSDoc documentation complete
- ✅ Manual tests pass in browser console

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-09 | 1.0 | Story created for Epic 9 | Bob (SM) |
| 2025-12-09 | 1.1 | Implementation complete, ready for review | James (Dev) |

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-5-20250929

### Debug Log References
None - No issues encountered during implementation

### Completion Notes List
- **Implementation approach:** Created clean vanilla JavaScript EventBus class with Map-based storage
- **EventBus class implementation:**
  - Constructor initializes `this.listeners` as Map for efficient event management
  - `on(event, callback)` registers listeners, creating array for new events
  - `emit(event, data)` calls all registered callbacks with provided data
  - `off(event, callback)` removes specific callback using filter
- **Exports:**
  - Singleton instance `eventBus` for application-wide use
  - Class `EventBus` exported for testing and custom instances
- **Documentation:**
  - Comprehensive JSDoc comments for class and all methods
  - File header with purpose and usage examples
  - @param, @returns annotations throughout
  - Examples demonstrate namespaced event naming (e.g., 'panel:created')
- **Testing:**
  - Created test-eventbus.html with 4 automated test cases
  - Test 1: Basic event emission and listener callback
  - Test 2: Multiple listeners for same event
  - Test 3: Remove listener functionality
  - Test 4: Complex data object passing
  - Browser-based visual test interface with results display
- **Design decisions:**
  - Map over Object for better performance and insertion order
  - Namespaced event naming convention (component:action)
  - Silent no-op when emitting to non-existent event (no error)
  - Callback reference equality required for off() (standard pattern)
- **Development environment:** Used git worktree for isolated development on branch `feature/story-9.3-event-bus`
- **Result:** All acceptance criteria met (AC 1-5 ✓)

### File List
- `src/utils/eventBus.js` - EventBus class implementation with JSDoc (new file, 127 lines)
- `test-eventbus.html` - Manual test suite for browser testing (new file, 185 lines)

## QA Results

**Reviewed by:** Quinn (Test Architect)
**Review Date:** 2025-12-09
**Gate:** ✅ **PASS** → [bmad/qa/gates/9.3-create-event-bus.yml](../qa/gates/9.3-create-event-bus.yml)
**Quality Score:** 100/100

### Code Quality Assessment
**Implementation:** EXCELLENT

Clean vanilla JavaScript implementation with comprehensive JSDoc documentation. All methods correctly implemented using Map-based storage for optimal O(1) performance. Singleton pattern properly exported alongside class for testing flexibility. Event naming convention well documented with examples.

**Standards Compliance:**
- ✅ 2-space indentation
- ✅ camelCase naming conventions
- ✅ ES modules (import/export)
- ✅ Single quotes for strings
- ✅ Semicolons required
- ✅ Comprehensive JSDoc with @param, @returns, @example

### Requirements Traceability
All 5 acceptance criteria covered with zero gaps:
- AC #1: EventBus class created in src/utils/eventBus.js ✓
- AC #2: Methods on(), emit(), off() implemented ✓
- AC #3: Singleton instance exported ✓
- AC #4: JSDoc documentation complete ✓
- AC #5: No external dependencies (vanilla JS) ✓

### NFR Validation
- **Security:** PASS - N/A for utility module
- **Performance:** PASS - Efficient Map-based O(1) operations
- **Reliability:** PASS - Simple, predictable behavior with silent no-op pattern
- **Maintainability:** PASS - Excellent documentation and clean code

### Testing
Manual test suite (test-eventbus.html) with 4 test cases:
1. ✅ Basic event emission and listener callback
2. ✅ Multiple listeners for same event
3. ✅ Remove listener functionality
4. ✅ Complex data object passing

User confirmed: "the page loads and the tests pass!"

### Issues Identified
**None** - Zero critical, high, medium, or low severity issues

### Technical Debt
**None identified** - Clean implementation with no shortcuts or workarounds

### Recommendations
**Immediate:** None
**Future:** Consider adding optional error handling mode for debugging (nice-to-have)

### Recommended Status
**Ready for Done** - All acceptance criteria met with excellent code quality and no blocking issues.

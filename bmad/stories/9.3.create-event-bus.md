# Story 9.3: Create Event Bus Module

## Status
Ready for Development

## Story

**As a** developer,
**I want** a centralized event bus for cross-component communication,
**so that** modules are decoupled and easier to test

## Acceptance Criteria

1. Create `src/utils/eventBus.js` with EventBus class
2. Implement methods: `on(event, callback)`, `emit(event, data)`, `off(event, callback)`
3. Export singleton instance: `export const eventBus = new EventBus()`
4. Add JSDoc documentation for all methods
5. No external dependencies (vanilla JavaScript implementation)

## Tasks / Subtasks

- [ ] **Task 1: Create utils directory and file** (AC: 1)
  - [ ] Create `src/utils/` directory
  - [ ] Create `src/utils/eventBus.js` file
  - [ ] Add file header comment with purpose

- [ ] **Task 2: Implement EventBus class** (AC: 2, 5)
  - [ ] Create `class EventBus {}`
  - [ ] Add constructor: `this.listeners = new Map()`
  - [ ] Implement `on(event, callback)` method:
    - Create array for event if not exists
    - Push callback to event's listener array
  - [ ] Implement `emit(event, data)` method:
    - Get all callbacks for event
    - Call each callback with data
  - [ ] Implement `off(event, callback)` method:
    - Remove specific callback from event's listeners
    - Filter out the callback from array

- [ ] **Task 3: Export singleton instance** (AC: 3)
  - [ ] Create single instance: `const eventBus = new EventBus()`
  - [ ] Export instance: `export { eventBus }`
  - [ ] Export class for testing: `export { EventBus }`

- [ ] **Task 4: Add JSDoc documentation** (AC: 4)
  - [ ] Document EventBus class
  - [ ] Document `on()` method with @param and @example
  - [ ] Document `emit()` method with @param and @example
  - [ ] Document `off()` method with @param
  - [ ] Add usage examples in file header

- [ ] **Task 5: Create basic test (manual)**
  - [ ] In browser console, test event bus:
    ```javascript
    import { eventBus } from './utils/eventBus.js';
    eventBus.on('test', (data) => console.log('Received:', data));
    eventBus.emit('test', { message: 'Hello' });
    ```
  - [ ] Verify listener called with correct data
  - [ ] Test `off()` removes listener

## Dev Notes

### Event Bus Implementation
[Source: architecture/frontend-architecture.md#event-bus-pattern]

```javascript
// src/utils/eventBus.js

/**
 * Event Bus for decoupled cross-component communication
 * @example
 * import { eventBus } from './utils/eventBus.js';
 *
 * // Listen for events
 * eventBus.on('panel:created', (panel) => {
 *   console.log('Panel created:', panel.id);
 * });
 *
 * // Emit events
 * eventBus.emit('panel:created', { id: 'panel-1', code: '...' });
 */
class EventBus {
  constructor() {
    this.listeners = new Map();
  }

  /**
   * Register event listener
   * @param {string} event - Event name (e.g., 'panel:created')
   * @param {Function} callback - Callback function to invoke
   */
  on(event, callback) {
    if (!this.listeners.has(event)) {
      this.listeners.set(event, []);
    }
    this.listeners.get(event).push(callback);
  }

  /**
   * Emit event with data
   * @param {string} event - Event name
   * @param {*} data - Data to pass to listeners
   */
  emit(event, data) {
    const callbacks = this.listeners.get(event) || [];
    callbacks.forEach(cb => cb(data));
  }

  /**
   * Remove event listener
   * @param {string} event - Event name
   * @param {Function} callback - Callback to remove
   */
  off(event, callback) {
    const callbacks = this.listeners.get(event) || [];
    this.listeners.set(event, callbacks.filter(cb => cb !== callback));
  }
}

export const eventBus = new EventBus();
export { EventBus }; // For testing
```

### Event Naming Convention
[Source: architecture/frontend-architecture.md#component-standards]

Use **namespaced event names** with colon separator:
- `panel:created`, `panel:deleted`, `panel:updated`
- `slider:changed`
- `skin:loaded`, `skin:error`
- `settings:saved`

### Why Map Instead of Object
[Source: architecture/frontend-architecture.md#state-management-architecture]

- Map has better performance for frequent additions/deletions
- Map preserves insertion order
- Map allows any value as key (not just strings)

### Future Manager Usage Examples
[Source: architecture/frontend-architecture.md#event-bus-pattern]

```javascript
// panelManager.js
import { eventBus } from '../utils/eventBus.js';

export function createPanel(id, code) {
  const panel = { id, code, playing: false };
  panels.set(id, panel);
  eventBus.emit('panel:created', panel);
  return panel;
}

// websocketManager.js
import { eventBus } from '../utils/eventBus.js';

eventBus.on('panel:created', (panel) => {
  broadcast('PANEL_CREATED', panel);
});
```

### File Location
[Source: architecture/source-tree.md#future-modular-architecture]

```
src/
├── utils/
│   └── eventBus.js  ← NEW FILE
```

## Testing

### Testing Standards
[Source: architecture/coding-standards.md#code-structure]

**Manual Testing (No test framework yet):**

1. **Basic Functionality:**
   - Import event bus in main.js
   - Register test listener: `eventBus.on('test', console.log)`
   - Emit event: `eventBus.emit('test', { data: 'hello' })`
   - Verify console output

2. **Multiple Listeners:**
   - Register 2+ listeners for same event
   - Emit event
   - Verify all listeners called

3. **Remove Listener:**
   - Register listener
   - Call `off()` with same callback reference
   - Emit event
   - Verify listener NOT called

4. **Data Passing:**
   - Emit event with complex data (object, array)
   - Verify listener receives exact data

### Expected Outcomes

- ✅ `src/utils/eventBus.js` exists
- ✅ EventBus class has `on()`, `emit()`, `off()` methods
- ✅ Singleton instance exported
- ✅ JSDoc documentation complete
- ✅ Manual tests pass in browser console

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-09 | 1.0 | Story created for Epic 9 | Bob (SM) |

## Dev Agent Record

### Agent Model Used
(To be filled by dev agent)

### Debug Log References
(To be filled by dev agent)

### Completion Notes List
(To be filled by dev agent)

### File List
(To be filled by dev agent)

## QA Results
(To be filled by QA agent)

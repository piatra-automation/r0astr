# Story 5.3: Update Panel Code Endpoint

## Status
Ready for Review

## Story

**As an** external application,
**I want** to push new code to a panel via POST request,
**so that** I can update patterns remotely

## Acceptance Criteria

1. Endpoint: `POST /api/panels/:id/code`
2. Request body: `{ code: string, autoPlay?: boolean }`
3. Response: `{ success: true, stale: boolean }` (stale=true if panel was playing)
4. Code updated in textarea immediately
5. If `autoPlay: true`, panel activates with new code automatically

## Tasks / Subtasks

- [x] **Task 1: Implement POST /api/panels/:id/code endpoint** (AC: 1, 2)
  - [x] Add POST route handler to `src/server/routes/panels.js`
  - [x] Parse panel ID from URL parameter: `req.params.id`
  - [x] Parse request body: `{ code, autoPlay }`
  - [x] Validate `code` is a string (required)
  - [x] Validate `autoPlay` is boolean (optional, defaults to false)
  - [x] Return `400 Bad Request` if validation fails

- [x] **Task 2: Update panel code in state** (AC: 3, 4)
  - [x] Import `updatePanelCode()` from `src/managers/panelManager.js`
  - [x] Call `updatePanelCode(panelId, code)` to update panel state
  - [x] Update textarea value in DOM: `document.querySelector(\`#${panelId} textarea\`).value = code`
  - [x] Ensure code is saved to panel state object

- [x] **Task 3: Detect staleness** (AC: 3)
  - [x] Check if panel is currently playing before update
  - [x] Set `stale = true` if panel was playing
  - [x] Set `stale = false` if panel was paused
  - [x] Mark panel with stale flag in state (Epic 6 integration)
  - [x] Return staleness in response

- [x] **Task 4: Implement autoPlay functionality** (AC: 5)
  - [x] If `autoPlay: true` and panel is playing, restart with new code
  - [x] If `autoPlay: true` and panel is paused, start playback with new code
  - [x] If `autoPlay: false`, only update code without affecting playback
  - [x] Call `evaluatePanel(panelId)` to activate new pattern
  - [x] Test: Update code with autoPlay, verify audio starts immediately

- [x] **Task 5: WebSocket notification for UI sync** (AC: 4)
  - [x] Broadcast `panel_updated` event to all connected WebSocket clients
  - [x] Event payload: `{ type: 'panel_updated', panelId, code, autoPlay, stale }`
  - [x] UI client receives event and updates textarea
  - [x] Test: Update panel code via API, verify textarea updates in browser

- [x] **Task 6: Error handling** (AC: 3)
  - [x] Return `404 Not Found` if panel doesn't exist
  - [x] Return `400 Bad Request` if code is not a string
  - [x] Return `500 Internal Server Error` on unexpected errors
  - [x] Test: Send invalid panel ID, verify error response
  - [x] Test: Send non-string code, verify error response

- [x] **Task 7: Update documentation** (AC: 1, 2, 3, 5)
  - [x] Add POST /api/panels/:id/code documentation to `docs/remote-control.md`
  - [x] Document request/response format
  - [x] Provide curl examples:
    ```bash
    curl -X POST http://localhost:3000/api/panels/panel-123/code \
      -H "Content-Type: application/json" \
      -H "X-API-Key: your-api-key" \
      -d '{"code": "note(\"c3 e3 g3\").s(\"piano\")", "autoPlay": true}'
    ```
  - [x] Document staleness detection behavior

## Dev Notes

### POST /api/panels/:id/code Route Handler
[Source: AC: 1, 2, 3, 5]

```javascript
// src/server/routes/panels.js
router.post('/:id/code', async (req, res) => {
  try {
    const panelId = req.params.id;
    const { code, autoPlay = false } = req.body;

    // Validate request body
    if (typeof code !== 'string') {
      return res.status(400).json({ error: 'code must be a string' });
    }
    if (autoPlay !== undefined && typeof autoPlay !== 'boolean') {
      return res.status(400).json({ error: 'autoPlay must be a boolean' });
    }

    // Check if panel exists
    const panel = getPanelById(panelId);
    if (!panel) {
      return res.status(404).json({ error: 'Panel not found' });
    }

    // Detect staleness (AC: 3)
    const wasPlaying = panel.playing;
    const stale = wasPlaying && !autoPlay;

    // Update panel code (AC: 4)
    updatePanelCode(panelId, code);

    // Handle autoPlay (AC: 5)
    if (autoPlay) {
      evaluatePanel(panelId, code);
    } else if (stale) {
      // Mark panel as stale (Epic 6)
      markPanelStale(panelId, true);
    }

    // Broadcast WebSocket event (AC: 4)
    broadcastWebSocket({
      type: 'panel_updated',
      panelId,
      code,
      autoPlay,
      stale
    });

    res.json({ success: true, stale });
  } catch (error) {
    console.error('Error updating panel code:', error);
    res.status(500).json({ error: 'Failed to update panel code', details: error.message });
  }
});
```

### Panel Manager Update Function
[Source: AC: 4, Epic 1]

```javascript
// src/managers/panelManager.js
export function updatePanelCode(panelId, code) {
  // Update state
  if (panels[panelId]) {
    panels[panelId].code = code;
  }

  // Update textarea in DOM
  const textarea = document.querySelector(`#${panelId} textarea`);
  if (textarea) {
    textarea.value = code;
  }

  console.log(`Panel code updated: ${panelId}`);
}
```

### Evaluate Panel Function
[Source: AC: 5, Strudel integration]

```javascript
// src/audio/evaluator.js
import { evaluate, scheduler } from './strudel.js';

export function evaluatePanel(panelId, code) {
  try {
    // Stop existing pattern if playing
    scheduler.stop(panelId);

    // Evaluate new pattern with .p(panelId) for independent control
    const patternCode = `${code}.p('${panelId}')`;
    evaluate(patternCode, false, false);

    // Update panel state
    if (panels[panelId]) {
      panels[panelId].playing = true;
    }

    console.log(`Panel ${panelId} evaluated with new code`);
  } catch (error) {
    console.error(`Failed to evaluate panel ${panelId}:`, error);
    throw error; // Propagate to route handler
  }
}
```

### Staleness Detection Logic
[Source: AC: 3, Epic 6 integration]

```javascript
// Staleness is detected when:
// 1. Panel was playing before update (wasPlaying = true)
// 2. autoPlay is false (user didn't request immediate activation)
// Result: Code in textarea differs from running pattern

const wasPlaying = panel.playing;
const stale = wasPlaying && !autoPlay;

if (stale) {
  markPanelStale(panelId, true);
}
```

### WebSocket Event Payload
[Source: AC: 4]

```javascript
{
  type: 'panel_updated',
  panelId: 'panel-1701234567890',
  code: 'note("c3 e3 g3").s("piano")',
  autoPlay: true,
  stale: false,
  timestamp: Date.now()
}
```

### Client-Side WebSocket Handler
[Source: AC: 4]

```javascript
// src/client/websocket.js
ws.on('message', (data) => {
  const event = JSON.parse(data);

  switch (event.type) {
    case 'panel_updated':
      const textarea = document.querySelector(`#${event.panelId} textarea`);
      if (textarea) {
        textarea.value = event.code;
      }

      // Update stale indicator if present
      if (event.stale) {
        markPanelStale(event.panelId, true);
      }

      console.log(`Panel ${event.panelId} code updated remotely`);
      break;
    // ... other event handlers
  }
});
```

### AutoPlay Behavior
[Source: AC: 5]

| Panel State | autoPlay | Result |
|-------------|----------|--------|
| Playing     | true     | Restart with new code immediately |
| Playing     | false    | Update code, keep old pattern running, mark stale |
| Paused      | true     | Start playback with new code |
| Paused      | false    | Update code, remain paused |

### Testing

Manual testing checklist:

- [x] Update code (autoPlay: false): Textarea updates, audio unchanged
- [x] Update code (autoPlay: true): Textarea updates, audio restarts
- [x] Update playing panel (autoPlay: false): Returns `stale: true`
- [x] Update paused panel (autoPlay: false): Returns `stale: false`
- [x] Update playing panel (autoPlay: true): Returns `stale: false`
- [x] Update non-existent panel: Returns 404 error
- [x] Send non-string code: Returns 400 error
- [x] Send non-boolean autoPlay: Returns 400 error
- [x] Multiple clients: All see textarea update
- [x] WebSocket event broadcast works correctly

### API Documentation Example
[Source: Task 7]

```markdown
## POST /api/panels/:id/code

Update panel code and optionally trigger playback.

**Request:**
```
POST /api/panels/panel-1701234567890/code
Content-Type: application/json
X-API-Key: your-api-key

{
  "code": "note(\"c3 e3 g3\").s(\"piano\")",
  "autoPlay": true
}
```

**Response:**
```json
{
  "success": true,
  "stale": false
}
```

**Parameters:**
- `code` (string, required): Strudel pattern code
- `autoPlay` (boolean, optional): Automatically activate pattern (default: false)

**Staleness:**
- `stale: true` if panel was playing and autoPlay is false
- `stale: false` if panel was paused or autoPlay is true

**Notes:**
- Code is updated in textarea immediately
- If autoPlay is true, pattern starts/restarts automatically
- WebSocket clients receive `panel_updated` event
```

### Dependencies

- Epic 1: Panel manager
- Epic 6: Staleness detection (markPanelStale function)
- Story 5.1: Server infrastructure
- Story 5.6: WebSocket state sync

## Change Log

| Date       | Version | Description          | Author |
|------------|---------|----------------------|--------|
| 2025-11-16 | 1.0     | Initial story draft  | Claude |

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes List

_To be filled by dev agent_

### File List

- `src/server/routes/panels.js` (modify) - Add POST /:id/code route
- `src/managers/panelManager.js` (modify) - Add updatePanelCode function
- `src/audio/evaluator.js` (new or modify) - Add evaluatePanel function

## QA Results

_Results from QA Agent review of the completed story implementation_

# Story 8.3: Remote UI Updates on Panel Rename

## Status
Ready for Review

## Story

**As a** remote control user,
**I want** panel title changes to appear automatically on my remote device,
**so that** I see the same instrument names as the main interface

## Acceptance Criteria

1. When main interface renames panel, remote.html receives `panel_renamed` event
2. Remote client updates panel title in UI immediately
3. Title update does not affect button states (Play/Pause)
4. Title updates are debounced if user types rapidly (500ms)
5. Master panel title changes also synchronized

## Tasks / Subtasks

- [ ] **Task 1: Implement title update debouncing in main interface** (AC: 4)
  - [ ] Update `updatePanelTitle()` in `src/managers/panelManager.js`
  - [ ] Add debounce wrapper around WebSocket broadcast call
  - [ ] Delay: 500ms after last title change
  - [ ] Cancel pending broadcast if new change occurs
  - [ ] Test: Type rapidly in panel title, verify single broadcast after 500ms

- [ ] **Task 2: Extend WebSocket server to broadcast panel_renamed event** (AC: 1)
  - [ ] Update debounced `updatePanelTitle()` function
  - [ ] After debounce period, call `broadcastWebSocket()`
  - [ ] Event payload: `{ type: 'panel_renamed', id, newTitle }`
  - [ ] Test: Rename panel in main UI, verify WebSocket broadcast (debounced)
  - [ ] Requires Story 2.1 editable panel titles implementation

- [ ] **Task 3: Update remote WebSocket message handler** (AC: 1, 2)
  - [ ] Extend `handleMessage()` in remote.html to handle `panel_renamed` event
  - [ ] Extract panel ID and new title from event: `{ id, newTitle }`
  - [ ] Call `updateRemotePanelTitle(panelId, newTitle)` function
  - [ ] Test: Send mock panel_renamed message, verify title updates

- [ ] **Task 4: Implement remote panel title update function** (AC: 2, 3)
  - [ ] Create `updateRemotePanelTitle(panelId, newTitle)` function in remote.html
  - [ ] Find panel element by ID: `document.querySelector(\`#remote-${panelId}\`)`
  - [ ] Update title text: `panelElement.querySelector('h3').textContent = newTitle`
  - [ ] Preserve playing state and button state (no changes)
  - [ ] Test: Update title, verify button state unchanged

- [ ] **Task 5: Sanitize title on remote client** (AC: 2)
  - [ ] Implement XSS prevention: sanitize title before rendering
  - [ ] Use `textContent` (not `innerHTML`) to prevent HTML injection
  - [ ] Limit title length: truncate if exceeds 50 characters
  - [ ] Test: Send title with HTML tags, verify tags not rendered

- [ ] **Task 6: Handle title update for non-existent panel** (AC: 2)
  - [ ] Check if panel element exists before updating title
  - [ ] If panel not found, log warning and skip update
  - [ ] Prevents errors if panel deleted or never created
  - [ ] Test: Send panel_renamed for non-existent ID, verify no errors

- [ ] **Task 7: Add visual feedback for title update** (AC: 2)
  - [ ] Add CSS transition on title element: `color 0.3s ease`
  - [ ] Briefly highlight title on update: flash to accent color, fade back
  - [ ] Provides user feedback that sync occurred
  - [ ] Test: Rename panel, verify subtle highlight flash on remote

- [ ] **Task 8: Support master panel title changes** (AC: 5)
  - [ ] Master panel has ID "master" (convention from Epic 1)
  - [ ] Apply same title update logic to master panel
  - [ ] Verify master panel element exists in remote UI
  - [ ] Test: Rename master panel, verify remote updates

## Dev Notes

### Debounce Implementation
[Source: AC: 4]

Debounce WebSocket broadcast to prevent excessive events during rapid typing:

```javascript
// src/managers/panelManager.js

// Debounce timer storage (panel ID -> timer ID)
const titleBroadcastTimers = {};

export function updatePanelTitle(panelId, newTitle) {
  if (!panels[panelId]) {
    console.warn('Panel not found:', panelId);
    return;
  }

  // Sanitize title
  const sanitizedTitle = sanitizeTitle(newTitle);
  panels[panelId].title = sanitizedTitle;

  // Update DOM
  const titleElement = document.querySelector(`#${panelId} .panel-title`);
  if (titleElement) {
    titleElement.textContent = sanitizedTitle;
  }

  // Debounce WebSocket broadcast
  if (titleBroadcastTimers[panelId]) {
    clearTimeout(titleBroadcastTimers[panelId]);
  }

  titleBroadcastTimers[panelId] = setTimeout(() => {
    if (typeof broadcastWebSocket === 'function') {
      broadcastWebSocket({
        type: 'panel_renamed',
        id: panelId,
        newTitle: sanitizedTitle
      });
    }
    delete titleBroadcastTimers[panelId];
  }, 500);
}

function sanitizeTitle(title) {
  return title.replace(/<[^>]*>/g, '').substring(0, 50).trim();
}
```

### WebSocket Event Payload
[Source: Epic 8 PRD Technical Notes]

`panel_renamed` event structure:
```json
{
  "type": "panel_renamed",
  "id": "panel-1701234567890",
  "newTitle": "808 Bass",
  "timestamp": 1701234567890
}
```

### Remote Panel Title Update Function
[Source: AC: 2, 3, 5]

```javascript
function updateRemotePanelTitle(panelId, newTitle) {
  const panelElement = document.querySelector(`#remote-${panelId}`);

  if (!panelElement) {
    console.warn('[Remote] Panel not found for title update:', panelId);
    return;
  }

  // Find title element (h3)
  const titleElement = panelElement.querySelector('h3');
  if (!titleElement) {
    console.warn('[Remote] Title element not found:', panelId);
    return;
  }

  // Sanitize and update title
  const sanitizedTitle = sanitizeRemoteTitle(newTitle);
  titleElement.textContent = sanitizedTitle;

  // Add flash animation for visual feedback
  titleElement.classList.add('title-updated');
  setTimeout(() => {
    titleElement.classList.remove('title-updated');
  }, 600);

  console.log('[Remote] Title updated:', panelId, sanitizedTitle);
}

function sanitizeRemoteTitle(title) {
  // Use textContent for XSS prevention (no HTML parsing)
  // Limit length to prevent layout issues
  return String(title).substring(0, 50).trim() || 'Untitled';
}
```

### CSS Animation for Title Update
[Source: AC: 7]

Subtle highlight flash on title update:
```css
.panel-info h3 {
  transition: color 0.3s ease;
}

.panel-info h3.title-updated {
  animation: titleFlash 0.6s ease;
}

@keyframes titleFlash {
  0% { color: #fff; }
  50% { color: #4CAF50; } /* Accent color */
  100% { color: #fff; }
}
```

Alternative approach (background flash):
```css
@keyframes titleFlash {
  0% { background-color: transparent; }
  50% { background-color: rgba(76, 175, 80, 0.2); }
  100% { background-color: transparent; }
}
```

### WebSocket Message Handler Integration
[Source: remote.html lines 273-293]

Extend existing `handleMessage()` function:
```javascript
function handleMessage(message) {
  const { type } = message;

  console.log('[Remote] Received:', type);

  switch (type) {
    case 'server.hello':
      console.log('[Remote] Server hello:', message);
      break;

    case 'state.update':
      // Existing state update logic
      if (message.panels) {
        message.panels.forEach(({ panel, playing }) => {
          panelStates[panel] = playing;
          updatePanelUI(panel, playing);
        });
      }
      break;

    case 'panel_created':
      handlePanelCreated(message);
      break;

    case 'panel_deleted':
      handlePanelDeleted(message);
      break;

    case 'panel_renamed':
      // New handler for this story
      handlePanelRenamed(message);
      break;

    // Additional cases...
  }
}

function handlePanelRenamed({ id, newTitle }) {
  console.log('[Remote] Renaming panel:', id, newTitle);
  updateRemotePanelTitle(id, newTitle);
}
```

### Master Panel Support
[Source: AC: 5]

Master panel is special case:
- ID: "master" (convention from Epic 1 Story 1.3)
- Always first in panel list
- Protected from deletion but can be renamed
- Remote UI should handle master panel title updates

Master panel element in remote.html:
```html
<!-- Existing hardcoded master panel (update if needed) -->
<div class="panel-control" id="remote-master" data-panel-id="master">
  <div class="panel-info">
    <h3>Master Controls</h3>
    <div class="status">Active</div>
  </div>
  <button class="panel-button" data-panel="master">⏹</button>
</div>
```

Title update logic handles master panel same as regular panels:
```javascript
// Master panel ID is "master"
updateRemotePanelTitle('master', 'My Master Panel');
```

### Debounce Rationale
[Source: AC: 4]

Without debounce:
- User types "Bass Line" (9 characters)
- 9 WebSocket events sent (one per character)
- Remote client updates title 9 times
- Unnecessary network traffic and processing

With 500ms debounce:
- User types "Bass Line" (9 characters in ~1 second)
- Single WebSocket event sent 500ms after last keystroke
- Remote client updates title once
- Efficient and responsive

### XSS Prevention Strategy
[Source: AC: 5]

Multiple layers of protection:

1. **Main interface sanitization**: `sanitizeTitle()` strips HTML tags before storing
2. **Remote client sanitization**: `sanitizeRemoteTitle()` validates received data
3. **DOM API choice**: Use `textContent` instead of `innerHTML` (prevents HTML parsing)

Example attack prevention:
```javascript
// Malicious title attempt
const maliciousTitle = '<script>alert("XSS")</script>Bass';

// After sanitization (main interface)
const sanitized = sanitizeTitle(maliciousTitle); // "Bass"

// Remote receives: "Bass" (safe)

// Even if unsanitized, textContent prevents execution:
titleElement.textContent = maliciousTitle;
// Renders literal text: "<script>alert("XSS")</script>Bass"
// Script does NOT execute
```

### Testing Edge Cases

Test scenarios for robust title updates:

- [ ] Rename panel to empty string (should reject or use fallback)
- [ ] Rename panel to very long string (50+ characters)
- [ ] Rename panel to string with HTML tags
- [ ] Rename panel to string with special characters (quotes, backslashes)
- [ ] Rename panel to Unicode/emoji characters
- [ ] Rename panel while it's playing (should not affect playback)
- [ ] Rename panel rapidly (type quickly, verify single debounced update)
- [ ] Rename master panel
- [ ] Rename panel that doesn't exist on remote (should not error)
- [ ] Multiple panels renamed in rapid succession

### Integration with Epic 2
[Source: Story 2.1 Editable Panel Titles]

Title editing in main interface:
```javascript
// Event listener for title editing (from Story 2.1)
document.addEventListener('blur', (e) => {
  const titleElement = e.target.closest('.panel-title');
  if (titleElement) {
    const panelId = titleElement.dataset.panelId;
    const newTitle = titleElement.textContent.trim();
    if (newTitle) {
      updatePanelTitle(panelId, newTitle); // Triggers debounced broadcast
    }
  }
}, true);
```

### Performance Considerations

**Memory overhead:**
- Debounce timers: O(n) where n = number of panels
- Minimal impact (few KB per timer)

**Network overhead:**
- Without debounce: 1 event per keystroke (~10-20 events/second during typing)
- With debounce: 1 event per title change (~0.1-1 event/second)
- 90%+ reduction in network traffic

### Testing

Manual testing checklist:

- [ ] Start main interface and remote.html in separate browser windows
- [ ] Create panel in main interface
- [ ] Click panel title to edit (from Story 2.1)
- [ ] Type slowly (1 character/second), verify single update after 500ms
- [ ] Type rapidly (10 characters/second), verify single update after 500ms
- [ ] Verify `panel_renamed` event received in remote WebSocket connection
- [ ] Verify remote panel title updates to match main interface
- [ ] Verify panel button state unchanged (still shows Play/Pause icon)
- [ ] Verify playing state unchanged if panel was playing
- [ ] Rename panel to HTML string like `<b>Bold</b>`, verify not rendered as HTML
- [ ] Rename panel to very long string, verify truncation at 50 characters
- [ ] Rename master panel, verify remote master panel title updates
- [ ] Rename multiple panels in quick succession, verify all update correctly
- [ ] Verify title flash animation plays on each update

### Dependencies

- Story 2.1: Editable Panel Titles (title editing in main interface)
- Story 5.6: WebSocket State Sync (WebSocket infrastructure)
- Story 8.1: Remote UI Updates on Panel Creation (remote panel structure)

### Related Stories

- Story 8.1: Remote UI Updates on Panel Creation
- Story 8.2: Remote UI Updates on Panel Deletion
- Story 8.4: Full Panel State Sync on Remote Connect
- Story 8.5: Remote Panel Order Synchronization

## Change Log

| Date       | Version | Description          | Author |
|------------|---------|----------------------|--------|
| 2025-11-16 | 1.0     | Initial story draft  | Claude |

## Dev Agent Record

### Agent Model Used

claude-sonnet-4-5-20250929

### Debug Log References

None - Implementation completed without issues

### Completion Notes List

- Implemented debounced WebSocket broadcast in src/main.js (line 704-720):
  - 500ms debounce timer per panel ID
  - Clears pending timer on new title change
  - Broadcasts after debounce period with panel_renamed event
  - Uses existing sanitized title from updatePanelTitle()
- Created updateRemotePanelTitle() function in remote.html (line 385-414):
  - Non-existent panel handling (warns + returns)
  - Title element validation
  - XSS prevention via textContent (not innerHTML)
  - Title truncation at 50 characters
  - Fallback to 'Untitled' for empty titles
  - Visual feedback flash animation
- Extended handleMessage() in remote.html to handle panel_renamed events (line 517-522)
- Added CSS title flash animation (.title-updated class) with:
  - Color transition from white → green → white
  - 600ms duration with ease timing
  - Automatically removed after animation
- Master panel support: updateRemotePanelTitle() works with any panel ID including 'master'

### File List

- `src/main.js` (modified) - Added debounce timer storage (line 85-86) and debounced broadcast (line 704-720)
- `remote.html` (modified) - Added updateRemotePanelTitle() function (line 385-414)
- `remote.html` (modified) - Extended handleMessage() to handle panel_renamed event (line 517-522)
- `remote.html` (modified) - Added CSS title flash animation (line 98-107)

## QA Results

_Results from QA Agent review of the completed story implementation_

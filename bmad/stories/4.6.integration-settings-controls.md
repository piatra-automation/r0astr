# Story 4.6: Integration Settings Controls

## Status
Ready for Review

## Story

**As a** user,
**I want** to configure integrations like snippet libraries and remote control,
**so that** I can extend the application with external resources

## Acceptance Criteria

1. **Snippet Location**: Text input for JSON file URL or local path
2. **Remote WebSocket Layout**: Dropdown for remote control panel layout preference (side panel, modal, hidden)
3. **Skin Pack Path**: Text input for WinAmp-style skin folder path
4. Settings validated before saving (URL format, path existence if possible)
5. Integration settings trigger relevant subsystem reload (e.g., reload snippets when URL changes)

## Tasks / Subtasks

- [ ] **Task 1: Add Snippet Location text input** (AC: 1, 4, 5)
  - [ ] Add text input to Integrations section in settings modal
  - [ ] Label: "Snippet Library URL/Path"
  - [ ] Placeholder: "https://example.com/snippets.json or /path/to/snippets.json"
  - [ ] HTML structure:
    ```html
    <div class="setting-item">
      <label for="snippet-location-input">Snippet Library URL/Path</label>
      <input type="text" id="snippet-location-input"
             class="setting-text-input"
             placeholder="https://example.com/snippets.json">
      <p class="setting-description">
        URL or file path to external snippet library (JSON format)
      </p>
    </div>
    ```
  - [ ] Bind to `settings.snippetLocation`
  - [ ] Validate URL format on change

- [ ] **Task 2: Add Remote WebSocket Layout dropdown** (AC: 2, 5)
  - [ ] Add dropdown select to Integrations section
  - [ ] Label: "Remote Control Panel Layout"
  - [ ] Options: Side Panel, Modal, Hidden
  - [ ] HTML structure:
    ```html
    <div class="setting-item">
      <label for="remote-ws-layout-select">Remote Control Panel Layout</label>
      <select id="remote-ws-layout-select" class="setting-select">
        <option value="side-panel">Side Panel (Default)</option>
        <option value="modal">Modal Overlay</option>
        <option value="hidden">Hidden</option>
      </select>
      <p class="setting-description">
        Where to display remote control panel (requires WebSocket server)
      </p>
    </div>
    ```
  - [ ] Bind to `settings.remoteWSLayout`
  - [ ] On change, update remote control UI layout (if WebSocket active)

- [ ] **Task 3: Add Skin Pack Path text input** (AC: 3, 4)
  - [ ] Add text input to Integrations section
  - [ ] Label: "Skin Pack Folder Path"
  - [ ] Placeholder: "/path/to/skins or https://example.com/skins/"
  - [ ] HTML structure:
    ```html
    <div class="setting-item">
      <label for="skin-pack-input">Skin Pack Folder Path</label>
      <input type="text" id="skin-pack-input"
             class="setting-text-input"
             placeholder="/path/to/skins">
      <p class="setting-description">
        Path to WinAmp-style skin folder (future feature, Epic 2 extension)
      </p>
    </div>
    ```
  - [ ] Bind to `settings.skinPack`
  - [ ] Note: Feature not implemented yet, placeholder for future

- [ ] **Task 4: Implement URL validation** (AC: 4)
  - [ ] Create `validateURL(url)` function in utils/validation.js
  - [ ] Check URL format with regex or URL constructor:
    ```javascript
    function validateURL(url) {
      try {
        new URL(url);
        return true;
      } catch (error) {
        return false;
      }
    }
    ```
  - [ ] Show validation error if URL is invalid
  - [ ] Allow empty string (clear setting)

- [ ] **Task 5: Implement path validation** (AC: 4)
  - [ ] Create `validatePath(path)` function
  - [ ] Basic check: Path is non-empty string
  - [ ] Note: Cannot check file existence in browser (no filesystem access)
  - [ ] Display warning if path looks invalid (e.g., contains invalid characters)

- [ ] **Task 6: Wire snippet location change handler** (AC: 5)
  - [ ] Attach change event listener to snippet location input
  - [ ] On change, validate URL/path
  - [ ] If valid, save to settings and reload snippets:
    ```javascript
    document.getElementById('snippet-location-input').addEventListener('blur', async (e) => {
      const url = e.target.value.trim();

      if (url && !validateURL(url) && !validatePath(url)) {
        alert('Invalid URL or path format');
        return;
      }

      const settings = getSettings();
      settings.snippetLocation = url;
      saveSettings(settings);

      if (url) {
        await loadSnippets(url);
      }
    });
    ```

- [ ] **Task 7: Wire remote WS layout change handler** (AC: 2, 5)
  - [ ] Attach change event listener to remote WS layout dropdown
  - [ ] On change, update remote control panel UI:
    ```javascript
    document.getElementById('remote-ws-layout-select').addEventListener('change', (e) => {
      const layout = e.target.value;

      const settings = getSettings();
      settings.remoteWSLayout = layout;
      saveSettings(settings);

      // Update remote control panel layout (if WebSocket active)
      if (window.remoteControlActive) {
        applyRemoteControlLayout(layout);
      }
    });
    ```

- [ ] **Task 8: Wire skin pack path change handler** (AC: 3)
  - [ ] Attach change event listener to skin pack input
  - [ ] On change, validate path and save to settings
  - [ ] Note: Skin loading not implemented (future feature)
  - [ ] Show message: "Skin pack setting saved. Skin loading not yet implemented."

- [ ] **Task 9: Load integration settings into form** (AC: 1, 2, 3)
  - [ ] When opening settings modal, load current values:
    ```javascript
    const settings = getSettings();
    document.getElementById('snippet-location-input').value = settings.snippetLocation || '';
    document.getElementById('remote-ws-layout-select').value = settings.remoteWSLayout || 'side-panel';
    document.getElementById('skin-pack-input').value = settings.skinPack || '';
    ```

- [ ] **Task 10: Create snippet loading function** (AC: 5)
  - [ ] Create `loadSnippets(url)` function in src/managers/snippetManager.js
  - [ ] Fetch JSON from URL:
    ```javascript
    async function loadSnippets(url) {
      try {
        const response = await fetch(url);
        const snippets = await response.json();
        console.log('Snippets loaded:', snippets.length, 'items');
        // Store snippets in global state
        window.snippets = snippets;
      } catch (error) {
        console.error('Failed to load snippets:', error);
        alert(`Failed to load snippets from ${url}`);
      }
    }
    ```
  - [ ] Call on settings change and app initialization

- [ ] **Task 11: Create remote control layout function** (AC: 5)
  - [ ] Create `applyRemoteControlLayout(layout)` function
  - [ ] Update remote control panel visibility and position:
    ```javascript
    function applyRemoteControlLayout(layout) {
      const remotePanel = document.getElementById('remote-control-panel');
      if (!remotePanel) return;

      switch (layout) {
        case 'side-panel':
          remotePanel.classList.remove('modal', 'hidden');
          remotePanel.classList.add('side-panel');
          break;
        case 'modal':
          remotePanel.classList.remove('side-panel', 'hidden');
          remotePanel.classList.add('modal');
          break;
        case 'hidden':
          remotePanel.classList.add('hidden');
          break;
      }
    }
    ```

## Dev Notes

### Integration Settings Section HTML
[Source: AC: 1-3, epic-4-settings-system.md]

```html
<section class="settings-section" id="integration-settings">
  <h3>Integrations</h3>

  <!-- Snippet Location Input (AC: 1) -->
  <div class="setting-item">
    <label for="snippet-location-input">Snippet Library URL/Path</label>
    <input type="text" id="snippet-location-input"
           class="setting-text-input"
           placeholder="https://example.com/snippets.json">
    <p class="setting-description">
      URL or file path to external snippet library (JSON format). Leave empty to disable.
    </p>
  </div>

  <!-- Remote WebSocket Layout Dropdown (AC: 2) -->
  <div class="setting-item">
    <label for="remote-ws-layout-select">Remote Control Panel Layout</label>
    <select id="remote-ws-layout-select" class="setting-select">
      <option value="side-panel">Side Panel (Default)</option>
      <option value="modal">Modal Overlay</option>
      <option value="hidden">Hidden</option>
    </select>
    <p class="setting-description">
      Where to display remote control panel (requires WebSocket server from Epic 5)
    </p>
  </div>

  <!-- Skin Pack Path Input (AC: 3) -->
  <div class="setting-item">
    <label for="skin-pack-input">Skin Pack Folder Path</label>
    <input type="text" id="skin-pack-input"
           class="setting-text-input"
           placeholder="/path/to/skins">
    <p class="setting-description">
      Path to WinAmp-style skin folder (future feature, Epic 2 extension)
    </p>
  </div>
</section>
```

### Text Input Styling
[Source: AC: 1, 3, application theme]

```css
.setting-text-input {
  width: 100%;
  padding: 8px;
  background: #1a1a1a;
  border: 1px solid #00ff00;
  color: #00ff00;
  font-size: 14px;
  border-radius: 4px;
  font-family: monospace;
}

.setting-text-input:focus {
  outline: none;
  border-color: #00ff00;
  box-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
}

.setting-text-input::placeholder {
  color: #666;
}

.setting-text-input.invalid {
  border-color: #ff0000;
  box-shadow: 0 0 5px rgba(255, 0, 0, 0.5);
}
```

### URL Validation Implementation
[Source: AC: 4]

```javascript
// src/utils/validation.js
export function validateURL(url) {
  if (!url || url.trim() === '') {
    return true; // Empty is valid (clear setting)
  }

  try {
    new URL(url);
    return true;
  } catch (error) {
    return false;
  }
}

export function validatePath(path) {
  if (!path || path.trim() === '') {
    return true; // Empty is valid
  }

  // Basic path validation (non-empty string)
  // Cannot check file existence in browser
  return typeof path === 'string' && path.length > 0;
}
```

### Snippet Location Validation and Loading
[Source: AC: 1, 4, 5]

```javascript
// Wire snippet location input
document.getElementById('snippet-location-input').addEventListener('blur', async (e) => {
  const input = e.target;
  const url = input.value.trim();

  // Validate URL/path
  if (url && !validateURL(url) && !validatePath(url)) {
    input.classList.add('invalid');
    alert('Invalid URL or path format. Please enter a valid URL or file path.');
    return;
  } else {
    input.classList.remove('invalid');
  }

  // Save to settings
  const settings = getSettings();
  settings.snippetLocation = url;
  saveSettings(settings);

  // Reload snippets if URL provided
  if (url) {
    await loadSnippets(url);
  } else {
    window.snippets = []; // Clear snippets
    console.log('Snippet location cleared');
  }
});
```

### Snippet Loading Function
[Source: AC: 5]

```javascript
// src/managers/snippetManager.js
export async function loadSnippets(url) {
  if (!url) {
    console.log('No snippet URL provided');
    return;
  }

  try {
    console.log('Loading snippets from:', url);
    const response = await fetch(url);

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }

    const snippets = await response.json();

    // Validate snippet format
    if (!Array.isArray(snippets)) {
      throw new Error('Snippets must be a JSON array');
    }

    // Store in global state
    window.snippets = snippets;
    console.log('Snippets loaded successfully:', snippets.length, 'items');

    // Optional: Trigger UI update (snippet menu, autocomplete, etc.)
    if (typeof renderSnippetMenu === 'function') {
      renderSnippetMenu(snippets);
    }
  } catch (error) {
    console.error('Failed to load snippets:', error);
    alert(`Failed to load snippets from ${url}\n\nError: ${error.message}`);
  }
}
```

### Remote Control Layout Implementation
[Source: AC: 2, 5, Epic 5 WebSocket integration]

```javascript
// src/ui/remoteControl.js
export function applyRemoteControlLayout(layout) {
  const remotePanel = document.getElementById('remote-control-panel');
  if (!remotePanel) {
    console.warn('Remote control panel not found');
    return;
  }

  // Remove all layout classes
  remotePanel.classList.remove('side-panel', 'modal', 'hidden');

  // Apply new layout
  switch (layout) {
    case 'side-panel':
      remotePanel.classList.add('side-panel');
      remotePanel.style.display = 'block';
      console.log('Remote control layout: Side panel');
      break;
    case 'modal':
      remotePanel.classList.add('modal');
      remotePanel.style.display = 'flex';
      console.log('Remote control layout: Modal overlay');
      break;
    case 'hidden':
      remotePanel.classList.add('hidden');
      remotePanel.style.display = 'none';
      console.log('Remote control layout: Hidden');
      break;
    default:
      console.error('Invalid remote control layout:', layout);
  }
}

// Wire dropdown
document.getElementById('remote-ws-layout-select').addEventListener('change', (e) => {
  const layout = e.target.value;

  const settings = getSettings();
  settings.remoteWSLayout = layout;
  saveSettings(settings);

  // Apply immediately if remote control is active
  if (window.remoteControlActive) {
    applyRemoteControlLayout(layout);
  } else {
    console.log('Remote control layout saved (will apply when WebSocket connects)');
  }
});
```

### Remote Control Layout CSS
[Source: AC: 2, Epic 5 context]

```css
#remote-control-panel.side-panel {
  position: fixed;
  right: 0;
  top: 0;
  width: 300px;
  height: 100vh;
  background: #1a1a1a;
  border-left: 2px solid #00ff00;
  z-index: 100;
}

#remote-control-panel.modal {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 400px;
  max-height: 80vh;
  background: #1a1a1a;
  border: 2px solid #00ff00;
  border-radius: 8px;
  z-index: 1000;
}

#remote-control-panel.hidden {
  display: none !important;
}
```

### Skin Pack Path Handler
[Source: AC: 3]

```javascript
// Wire skin pack input
document.getElementById('skin-pack-input').addEventListener('blur', (e) => {
  const path = e.target.value.trim();

  // Basic validation
  if (path && !validatePath(path)) {
    alert('Invalid path format');
    return;
  }

  // Save to settings
  const settings = getSettings();
  settings.skinPack = path;
  saveSettings(settings);

  // Note: Skin loading not implemented yet
  if (path) {
    console.log('Skin pack path saved:', path);
    console.warn('Skin loading not yet implemented (Epic 2 future feature)');
  }
});
```

### Default Integration Settings
[Source: Story 4.1, DEFAULT_SETTINGS schema]

```javascript
const DEFAULT_SETTINGS = {
  version: 1,
  yolo: false,
  colorScheme: 'dark',
  behavior: { ... },
  snippetLocation: '',                // AC: 1 - Empty by default
  remoteWSLayout: 'side-panel',       // AC: 2 - Side panel by default
  skinPack: ''                        // AC: 3 - Empty by default
};
```

### Load Snippets on Initialization
[Source: AC: 5]

```javascript
// src/main.js
async function initializeApp() {
  const settings = loadSettings();

  // Apply appearance settings
  applyColorScheme(settings.colorScheme);
  // ... other appearance settings

  // Load snippets if URL provided
  if (settings.snippetLocation) {
    await loadSnippets(settings.snippetLocation);
  }

  // Apply remote control layout if active
  if (settings.remoteWSLayout && window.remoteControlActive) {
    applyRemoteControlLayout(settings.remoteWSLayout);
  }

  // Initialize Strudel
  await initializeStrudel();

  // ... rest of initialization
}
```

### Snippet JSON Format (Example)
[Source: AC: 1, future snippet library feature]

Expected snippet JSON format:
```json
[
  {
    "name": "Kick Drum",
    "category": "Drums",
    "code": "s(\"bd*4\").gain(0.8)"
  },
  {
    "name": "Hi-Hat Loop",
    "category": "Drums",
    "code": "s(\"hh*8\").gain(0.5)"
  },
  {
    "name": "Bass Line",
    "category": "Bass",
    "code": "note(\"c2 c2 eb2 f2\").s(\"sawtooth\").lpf(400)"
  }
]
```

### Future: Snippet Autocomplete Integration
[Source: AC: 5, future enhancement]

After loading snippets, integrate with code editor autocomplete:
```javascript
// Future enhancement
function renderSnippetMenu(snippets) {
  // Create dropdown menu or autocomplete suggestions
  // Integrate with CodeMirror editor (if using)
  // Show snippets in UI (sidebar, context menu, etc.)
}
```

### Testing

Manual testing checklist:

- [ ] Snippet Location input visible in Integrations section
- [ ] Entering valid URL and pressing blur saves to settings
- [ ] Invalid URL shows validation error (red border)
- [ ] Empty snippet location clears snippets
- [ ] Valid snippet URL loads snippets successfully
- [ ] Invalid snippet URL shows error message
- [ ] Remote WS Layout dropdown visible with 3 options
- [ ] Changing layout saves to settings immediately
- [ ] Side panel layout: Remote panel on right side
- [ ] Modal layout: Remote panel centered as overlay
- [ ] Hidden layout: Remote panel not visible
- [ ] Skin Pack Path input visible
- [ ] Entering path saves to settings
- [ ] Skin pack setting saved (feature not implemented warning shown)
- [ ] All integration settings persist after page reload
- [ ] Text inputs styled correctly (monospace font, green border)
- [ ] Validation errors display correctly (invalid class)

## Change Log

| Date       | Version | Description          | Author |
|------------|---------|----------------------|--------|
| 2025-11-16 | 1.0     | Initial story draft  | Claude |

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes List

_To be filled by dev agent_

### File List

_To be filled by dev agent_

## QA Results

_Results from QA Agent review of the completed story implementation_

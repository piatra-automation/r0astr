# Story 9.8: Refactor main.js as Initialization Glue

## Status
Blocked - Requires UI Coordinator Modules

## Story

**As a** developer,
**I want** main.js to only handle initialization and wiring,
**so that** it's easy to understand the application entry point

## Acceptance Criteria

1. `main.js` reduced to < 200 lines (just imports and initialization)
2. Strudel initialization remains in `main.js` (async sample loading, repl setup)
3. Manager imports at top:
   ```javascript
   import { panelManager } from './managers/panelManager.js';
   import { settingsManager } from './managers/settingsManager.js';
   import { sliderManager } from './managers/sliderManager.js';
   import { websocketManager } from './managers/websocketManager.js';
   import { eventBus } from './utils/eventBus.js';
   ```
4. Initialization sequence:
   - Load settings
   - Initialize Strudel (samples, repl)
   - Setup event listeners
   - Initialize managers
   - Hide splash screen
5. No business logic in `main.js` (delegated to managers)

## Tasks / Subtasks

- [ ] **Task 1: Import all managers** (AC: 3)
  - [ ] Import panelManager functions
  - [ ] Import settingsManager functions
  - [ ] Import sliderManager functions
  - [ ] Import websocketManager functions
  - [ ] Import eventBus
  - [ ] Remove code now in managers

- [ ] **Task 2: Refactor initialization sequence** (AC: 4)
  - [ ] Create `initializeApp()` async function
  - [ ] Step 1: Load settings via settingsManager
  - [ ] Step 2: Initialize Strudel (keep in main.js)
  - [ ] Step 3: Setup event listeners (eventBus)
  - [ ] Step 4: Connect WebSocket (if enabled in settings)
  - [ ] Step 5: Hide splash screen
  - [ ] Call `initializeApp()` on DOMContentLoaded

- [ ] **Task 3: Setup event listeners** (AC: 4)
  - [ ] Function: `setupEventListeners()`
  - [ ] Listen for panel events:
    - `eventBus.on('panel:play', handlePanelPlay)`
    - `eventBus.on('panel:pause', handlePanelPause)`
    - `eventBus.on('stopAll', handleStopAll)`
  - [ ] Keep Strudel-specific event handling in main.js
  - [ ] Delegate non-Strudel logic to managers

- [ ] **Task 4: Create event handler functions** (AC: 5)
  - [ ] `handlePanelPlay(panelId)` - Call Strudel scheduler.start()
  - [ ] `handlePanelPause(panelId)` - Call Strudel scheduler.stop()
  - [ ] `handleStopAll()` - Stop all Strudel patterns
  - [ ] Keep handlers thin (< 10 lines each)

- [ ] **Task 5: Preserve Strudel initialization** (AC: 2)
  - [ ] Keep `initializeStrudel()` function in main.js
  - [ ] Async sample loading logic stays here
  - [ ] REPL creation stays here
  - [ ] Audio context initialization stays here
  - [ ] Reason: Tightly coupled to Web Audio API

- [ ] **Task 6: Remove delegated code** (AC: 5)
  - [ ] Remove panel CRUD logic (now in panelManager)
  - [ ] Remove slider rendering (now in sliderManager)
  - [ ] Remove settings logic (now in settingsManager)
  - [ ] Remove WebSocket logic (now in websocketManager)
  - [ ] Keep only: imports, init, event wiring, Strudel

- [ ] **Task 7: Add initialization comments** (AC: 1)
  - [ ] Document initialization sequence
  - [ ] Comment each major section
  - [ ] Add JSDoc for initializeApp()
  - [ ] Explain why Strudel stays in main.js

- [ ] **Task 8: Verify line count** (AC: 1)
  - [ ] Count lines in main.js
  - [ ] Target: < 200 lines
  - [ ] If over 200, extract more to utilities
  - [ ] Blank lines and comments don't count against limit

- [ ] **Task 9: Test application initialization**
  - [ ] Test app loads without errors
  - [ ] Test settings load on startup
  - [ ] Test Strudel initializes correctly
  - [ ] Test event listeners work
  - [ ] Test managers initialized

- [ ] **Task 10: Document initialization order**
  - [ ] Add comment block explaining load sequence
  - [ ] Document dependencies between steps
  - [ ] Note what can/cannot be reordered

## Dev Notes

### Refactored main.js Structure
[Source: epic-9-code-architecture-refactor.md#story-98]

```javascript
// src/main.js

// ===== IMPORTS =====
import { repl, evalScope, ref } from '@strudel/core';
import { transpiler } from '@strudel/transpiler';
import { getAudioContext, webaudioOutput, initAudioOnFirstClick } from '@strudel/webaudio';
import { registerSoundfonts } from '@strudel/soundfonts';

import { panelManager } from './managers/panelManager.js';
import { settingsManager } from './managers/settingsManager.js';
import { sliderManager } from './managers/sliderManager.js';
import { websocketManager } from './managers/websocketManager.js';
import { eventBus } from './utils/eventBus.js';

// ===== CONSTANTS =====
const DEFAULT_SAMPLE_DELAY = 3000;

// ===== GLOBAL STATE (Strudel-specific) =====
window.sliderValues = {}; // Required by Strudel
let scheduler = null;
let evaluatePattern = null;

// ===== INITIALIZATION =====

/**
 * Initialize application
 * SEQUENCE:
 * 1. Load settings (localStorage)
 * 2. Initialize Strudel (async samples, REPL)
 * 3. Setup event listeners
 * 4. Connect WebSocket (if enabled)
 * 5. Hide splash screen
 */
async function initializeApp() {
  try {
    // 1. Load settings
    const settings = settingsManager.loadSettings();

    // 2. Initialize Strudel (keep here - tightly coupled to Web Audio)
    const { evaluate, scheduler: strudelScheduler } = await initializeStrudel();
    evaluatePattern = evaluate;
    scheduler = strudelScheduler;

    // 3. Setup event listeners
    setupEventListeners();

    // 4. Connect WebSocket (optional)
    if (settings.websocket?.enabled) {
      websocketManager.connect(settings.websocket.url);
    }

    // 5. Hide splash
    document.getElementById('splash-modal')?.remove();

  } catch (error) {
    console.error('Failed to initialize app:', error);
  }
}

/**
 * Initialize Strudel (async sample loading, REPL setup)
 * CRITICAL: Keep in main.js - tightly coupled to Web Audio
 */
async function initializeStrudel() {
  const ctx = getAudioContext();
  initAudioOnFirstClick();

  // Import Strudel modules
  await import('@strudel/core');
  await import('@strudel/mini');
  await import('@strudel/tonal');

  // Register synths and soundfonts
  registerSynthSounds();
  registerSoundfonts();

  // Create REPL instance
  const { evaluate, scheduler } = repl({
    defaultOutput: webaudioOutput,
    getTime: () => ctx.currentTime,
    transpiler,
  });

  // Pre-load dirt-samples
  setTimeout(() => {
    samples('github:tidalcycles/dirt-samples');
  }, DEFAULT_SAMPLE_DELAY);

  return { evaluate, scheduler };
}

/**
 * Setup event listeners
 */
function setupEventListeners() {
  // Panel play/pause
  eventBus.on('panel:play', handlePanelPlay);
  eventBus.on('panel:pause', handlePanelPause);
  eventBus.on('stopAll', handleStopAll);

  // Panel code evaluation
  eventBus.on('panel:evaluate', handlePanelEvaluate);
}

// ===== EVENT HANDLERS (Thin wrappers for Strudel) =====

function handlePanelPlay(panelId) {
  const panel = panelManager.getPanelState(panelId);
  if (panel && !panel.playing) {
    // Strudel-specific logic stays here
    evaluatePattern(panel.code, true, false).then(() => {
      panelManager.setPanelPlaying(panelId, true);
    });
  }
}

function handlePanelPause(panelId) {
  scheduler.stop(panelId);
  panelManager.setPanelPlaying(panelId, false);
}

function handleStopAll() {
  scheduler.stop(); // Stop all patterns
  panelManager.getAllPanels().forEach(id => {
    panelManager.setPanelPlaying(id, false);
  });
}

function handlePanelEvaluate({ panelId, code }) {
  // Transpile, evaluate, render sliders
  const transpiledCode = transpiler(code);
  const widgets = transpiledCode.widgets || [];

  sliderManager.renderSliders(panelId, widgets);

  evaluatePattern(`${code}.p('${panelId}')`, true, false);
}

// ===== STARTUP =====

document.addEventListener('DOMContentLoaded', initializeApp);
```

### Why Strudel Stays in main.js
[Source: architecture/frontend-architecture.md#codemirror-integration-architecture]

Strudel initialization is **tightly coupled to Web Audio:**
- Requires `AudioContext` (browser global)
- Uses `initAudioOnFirstClick()` (browser permission)
- Registers synths/samples (global state)
- Creates shared REPL instance (singleton)

Moving this to a manager doesn't improve clarity. Keep it where it logically belongs: entry point.

### Current main.js Size
[Source: architecture/source-tree.md#application-logic-srcmainjs]

- Current: ~800 lines
- After refactor: < 200 lines (75% reduction)
- Breakdown:
  - Imports: ~20 lines
  - Strudel init: ~60 lines
  - Event setup: ~40 lines
  - Event handlers: ~50 lines
  - Comments: ~30 lines

### Initialization Sequence (Order Matters)
[Source: epic-9-code-architecture-refactor.md#acceptance-criteria]

```
1. Settings Load → Required for WebSocket URL, skin config
2. Strudel Init → Async, blocks pattern evaluation
3. Event Listeners → Must be setup before managers emit events
4. WebSocket Connect → Optional, can fail gracefully
5. Hide Splash → Last, after everything ready
```

**Cannot reorder:** Strudel must initialize before pattern evaluation.

### Event Handler Delegation
[Source: architecture/frontend-architecture.md#event-bus-pattern]

**main.js handles:**
- Strudel pattern evaluation
- Strudel scheduler control (play/pause/stop)
- Audio context management

**Managers handle:**
- Panel state updates
- Slider rendering
- Settings persistence
- WebSocket communication

### Global State Remaining in main.js
[Source: architecture/source-tree.md#application-logic-srcmainjs]

```javascript
window.sliderValues = {}; // Required by Strudel (@strudel/codemirror)
let scheduler = null;      // Strudel scheduler instance
let evaluatePattern = null; // Strudel evaluate function
```

These are **Strudel-specific** and should not be moved to managers.

## Testing

### Testing Standards

**Manual Testing:**

1. **Application Startup:**
   - Reload page
   - Verify no console errors
   - Verify splash screen appears then hides
   - Verify settings loaded
   - Verify Strudel initialized

2. **Event Flow:**
   - Create panel
   - Click Play
   - Verify event: `panel:play` emitted
   - Verify handler: `handlePanelPlay()` called
   - Verify Strudel evaluates pattern

3. **Manager Integration:**
   - Verify panelManager functions called
   - Verify sliderManager renders sliders
   - Verify websocketManager connects
   - Verify settingsManager loads settings

4. **Line Count:**
   - Count lines in main.js (use editor or `wc -l`)
   - Verify < 200 lines (excluding blank lines/comments)

5. **Code Clarity:**
   - Read main.js top to bottom
   - Verify clear initialization flow
   - Verify comments explain why Strudel stays here
   - Verify no business logic (delegated to managers)

### Expected Outcomes

- ✅ main.js < 200 lines
- ✅ Strudel initialization preserved
- ✅ All managers imported and used
- ✅ Event listeners setup correctly
- ✅ Application initializes without errors
- ✅ No business logic in main.js

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-09 | 1.0 | Story created for Epic 9 | Bob (SM) |

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-5-20250929

### Debug Log References
- Runtime error: drag/resize initialization depends on UI coordination code
- Missing: panel restoration logic, DOM event handlers, CodeMirror setup

### Completion Notes List
- **Status:** Blocked - requires prerequisite UI coordinator modules
- **Context:** Attempted to refactor main.js from 4087 lines to < 200 lines by delegating to managers
- **Findings:**
  - **Business logic successfully delegated:** Stories 9.4-9.7 created managers for panels, sliders, settings, WebSocket
  - **Strudel initialization preserved:** loadModules(), prebake(), REPL setup (must stay in main.js)
  - **Blocking issue:** main.js contains ~2000 lines of UI coordination code (DOM events, CodeMirror, panel rendering)
- **Architecture Analysis:**
  - Current main.js breakdown:
    - Strudel initialization: ~400 lines (must stay)
    - Business logic: ~1500 lines (successfully moved to managers ✓)
    - UI coordination: ~2000 lines (needs dedicated UI modules)
    - Comments/blank: ~187 lines
  - UI coordination code handles:
    - CodeMirror editor creation and management
    - DOM event listeners (button clicks, keyboard shortcuts)
    - Panel rendering and restoration
    - Drag/resize initialization
    - Pattern validation and error display
    - Master panel evaluation
    - Pattern highlighting
- **Prototype Created:**
  - Created refactored main.js demonstrating target architecture (445 lines)
  - Structure:
    - Manager imports (sliderManager, websocketManager, eventBus added ✓)
    - Clean initializeApp() sequence ✓
    - setupEventListeners() with eventBus ✓
    - Thin event handlers calling managers + Strudel ✓
    - All business logic delegated ✓
  - Prototype saved as architectural reference but not functional (missing UI coordination)
- **Recommendations:**
  1. Create `src/ui/panelCoordinator.js` - DOM events, CodeMirror setup, panel UI
  2. Create `src/ui/masterPanelCoordinator.js` - Master panel specific logic
  3. Create `src/ui/patternValidator.js` - Pattern validation and error display
  4. Then refactor main.js to < 200 lines as thin glue layer
- **Why Story 9.8 is Blocked:**
  - Story assumes UI coordination code already in separate modules
  - Reality: UI code still in main.js from original implementation
  - Refactoring to < 200 lines requires extracting ~2000 lines of UI code first
  - This extraction was not covered in Stories 9.1-9.7
- **Immediate Path Forward:**
  - Stories 9.4-9.7 successfully completed (manager modules created ✓)
  - Story 9.8 requires additional Epic for UI module extraction
  - Recommend creating Epic 10: "UI Module Extraction" with 3-4 stories
  - Then Story 9.8 can be completed as originally envisioned
- **Result:** Story marked as Blocked pending UI coordinator modules

### File List
- `src/main.js` - Unchanged from Story 9.7 (requires UI coordinator modules first)

## QA Results
(To be filled by QA agent)

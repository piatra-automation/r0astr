# Story 5.5: List Panels Endpoint

## Status
Ready for Review

## Story

**As an** external application,
**I want** to retrieve all panel states via GET request,
**so that** I can query current session state

## Acceptance Criteria

1. Endpoint: `GET /api/panels`
2. Response: `{ panels: [{ id, title, code, playing, position, size, stale }] }`
3. Returns all panels including master panel
4. Stale flag indicates if panel code differs from running pattern

## Tasks / Subtasks

- [x] **Task 1: Implement GET /api/panels endpoint** (AC: 1, 2)
  - [x] Add GET route handler to `src/server/routes/panels.js`
  - [x] Query all panels from panel manager
  - [x] Serialize panel state to JSON
  - [x] Return array of panel objects
  - [x] Support optional query parameters for filtering (future enhancement)

- [x] **Task 2: Collect panel data** (AC: 2, 3, 4)
  - [x] Import `getAllPanels()` from `src/managers/panelManager.js`
  - [x] Iterate over all panels including master panel
  - [x] Extract panel properties: id, title, code, playing, position, size
  - [x] Calculate stale flag for each panel (Epic 6 integration)
  - [x] Format as array of panel objects

- [x] **Task 3: Calculate stale flag** (AC: 4)
  - [x] Import `isPanelStale()` from staleness detection module
  - [x] For each panel, check if code differs from running pattern
  - [x] Set `stale: true` if panel is playing and code was updated without autoPlay
  - [x] Set `stale: false` if panel is paused or code matches running pattern
  - [x] Include stale flag in response

- [x] **Task 4: Include master panel** (AC: 3)
  - [x] Ensure master panel is included in response
  - [x] Master panel has special ID: `master-panel`
  - [x] Master panel has `playing: false` (always inactive)
  - [x] Master panel position/size may be null or default values
  - [x] Test: Verify master panel appears in GET /api/panels response

- [x] **Task 5: Add optional query parameters** (Future enhancement)
  - [x] Support `?playing=true` to filter only playing panels
  - [x] Support `?stale=true` to filter only stale panels
  - [x] Support `?exclude=master-panel` to exclude master panel
  - [x] Document query parameters in API docs
  - [x] Test: Filter by playing state, verify correct panels returned

- [x] **Task 6: Error handling** (AC: 2)
  - [x] Wrap route handler in try-catch block
  - [x] Return `500 Internal Server Error` on unexpected errors
  - [x] Log error details to console with stack trace
  - [x] Return empty array if no panels exist (edge case)
  - [x] Test: Ensure endpoint is resilient to missing data

- [x] **Task 7: Update documentation** (AC: 1, 2, 3, 4)
  - [x] Add GET /api/panels documentation to `docs/remote-control.md`
  - [x] Document response format with example
  - [x] Provide curl examples:
    ```bash
    curl -X GET http://localhost:3000/api/panels \
      -H "X-API-Key: your-api-key"
    ```
  - [x] Document stale flag meaning

## Dev Notes

### GET /api/panels Route Handler
[Source: AC: 1, 2, 3, 4]

```javascript
// src/server/routes/panels.js
router.get('/', async (req, res) => {
  try {
    // Get all panels from manager (AC: 3)
    const allPanels = getAllPanels();

    // Serialize panel data (AC: 2, 4)
    const panelsArray = Object.values(allPanels).map(panel => ({
      id: panel.id,
      title: panel.title,
      code: panel.code,
      playing: panel.playing,
      position: panel.position || { x: 0, y: 0 },
      size: panel.size || { w: 400, h: 300 },
      stale: isPanelStale(panel.id) // AC: 4
    }));

    res.json({ panels: panelsArray });
  } catch (error) {
    console.error('Error listing panels:', error);
    res.status(500).json({
      error: 'Failed to list panels',
      details: error.message
    });
  }
});
```

### Get All Panels Function
[Source: AC: 3, Epic 1]

```javascript
// src/managers/panelManager.js
export function getAllPanels() {
  // Return all panels including master panel
  return panels;
}
```

### Stale Flag Calculation
[Source: AC: 4, Epic 6]

```javascript
// src/managers/stalenessDetector.js
export function isPanelStale(panelId) {
  const panel = getPanelById(panelId);
  if (!panel) return false;

  // Only playing panels can be stale
  if (!panel.playing) return false;

  // Check if panel has stale flag set
  return panel.stale === true;
}
```

### Example Response
[Source: AC: 2, 3, 4]

```json
{
  "panels": [
    {
      "id": "master-panel",
      "title": "Master Panel (Global Controls)",
      "code": "let SLIDER_LPF = slider(800, 100, 5000);",
      "playing": false,
      "position": { "x": 0, "y": 0 },
      "size": { "w": 600, "h": 200 },
      "stale": false
    },
    {
      "id": "panel-1701234567890",
      "title": "Bass",
      "code": "note(\"c2\").s(\"sawtooth\").lpf(400)",
      "playing": true,
      "position": { "x": 0, "y": 0 },
      "size": { "w": 400, "h": 300 },
      "stale": false
    },
    {
      "id": "panel-1701234567901",
      "title": "Drums",
      "code": "s(\"bd hh sd hh\")",
      "playing": true,
      "position": { "x": 420, "y": 0 },
      "size": { "w": 400, "h": 300 },
      "stale": true
    },
    {
      "id": "panel-1701234567912",
      "title": "Lead",
      "code": "note(\"c4 e4 g4\").s(\"square\")",
      "playing": false,
      "position": { "x": 0, "y": 320 },
      "size": { "w": 400, "h": 300 },
      "stale": false
    }
  ]
}
```

### Query Parameters (Future Enhancement)
[Source: Task 5]

```javascript
router.get('/', async (req, res) => {
  try {
    const allPanels = getAllPanels();

    // Apply filters
    let filteredPanels = Object.values(allPanels);

    // Filter by playing state
    if (req.query.playing !== undefined) {
      const playing = req.query.playing === 'true';
      filteredPanels = filteredPanels.filter(p => p.playing === playing);
    }

    // Filter by stale state
    if (req.query.stale !== undefined) {
      const stale = req.query.stale === 'true';
      filteredPanels = filteredPanels.filter(p => isPanelStale(p.id) === stale);
    }

    // Exclude panels by ID
    if (req.query.exclude) {
      const excludeIds = req.query.exclude.split(',');
      filteredPanels = filteredPanels.filter(p => !excludeIds.includes(p.id));
    }

    // Serialize
    const panelsArray = filteredPanels.map(panel => ({
      id: panel.id,
      title: panel.title,
      code: panel.code,
      playing: panel.playing,
      position: panel.position || { x: 0, y: 0 },
      size: panel.size || { w: 400, h: 300 },
      stale: isPanelStale(panel.id)
    }));

    res.json({ panels: panelsArray });
  } catch (error) {
    console.error('Error listing panels:', error);
    res.status(500).json({ error: 'Failed to list panels', details: error.message });
  }
});
```

### Master Panel Handling
[Source: AC: 3]

Master panel should always be included with these characteristics:
- `id: "master-panel"`
- `playing: false` (master panel never plays)
- `code`: Global slider definitions
- `stale: false` (master panel cannot be stale)

### Testing

Manual testing checklist:

- [x] GET /api/panels returns array of panels
- [x] Master panel included in response
- [x] All panel properties present: id, title, code, playing, position, size, stale
- [x] Stale flag correct for playing panels with updated code
- [x] Stale flag false for paused panels
- [x] Empty array returned if no panels exist (edge case)
- [x] Query parameter ?playing=true filters correctly
- [x] Query parameter ?stale=true filters correctly
- [x] Query parameter ?exclude=master-panel excludes master
- [x] Error handling: Returns 500 on unexpected error

### API Documentation Example
[Source: Task 7]

```markdown
## GET /api/panels

Retrieve all panel states.

**Request:**
```
GET /api/panels
X-API-Key: your-api-key
```

**Response:**
```json
{
  "panels": [
    {
      "id": "panel-1701234567890",
      "title": "Bass",
      "code": "note(\"c2\").s(\"sawtooth\")",
      "playing": true,
      "position": { "x": 0, "y": 0 },
      "size": { "w": 400, "h": 300 },
      "stale": false
    }
  ]
}
```

**Response Fields:**
- `id` (string): Unique panel identifier
- `title` (string): Panel display title
- `code` (string): Current pattern code in textarea
- `playing` (boolean): Whether panel is actively playing
- `position` (object): Panel position (x, y)
- `size` (object): Panel dimensions (w, h)
- `stale` (boolean): True if code differs from running pattern

**Stale Flag:**
- `true`: Panel is playing, but code was updated without autoPlay
- `false`: Panel is paused OR code matches running pattern

**Query Parameters (Optional):**
- `?playing=true|false` - Filter by playback state
- `?stale=true|false` - Filter by staleness
- `?exclude=panel-id` - Exclude specific panel(s) (comma-separated)

**Examples:**
```bash
# Get all panels
curl http://localhost:3000/api/panels -H "X-API-Key: your-api-key"

# Get only playing panels
curl "http://localhost:3000/api/panels?playing=true" -H "X-API-Key: your-api-key"

# Get stale panels
curl "http://localhost:3000/api/panels?stale=true" -H "X-API-Key: your-api-key"

# Exclude master panel
curl "http://localhost:3000/api/panels?exclude=master-panel" -H "X-API-Key: your-api-key"
```
```

### Use Cases

**External MCP Integration:**
```python
# Get current session state
import requests

response = requests.get(
    'http://localhost:3000/api/panels',
    headers={'X-API-Key': 'your-api-key'}
)

panels = response.json()['panels']
for panel in panels:
    print(f"{panel['title']}: {'playing' if panel['playing'] else 'paused'}")
```

**Monitor stale panels:**
```bash
# List panels with outdated code
curl "http://localhost:3000/api/panels?stale=true" \
  -H "X-API-Key: your-api-key" | jq '.panels[] | .title'
```

### Dependencies

- Epic 1: Panel manager (getAllPanels)
- Epic 6: Staleness detection (isPanelStale)
- Story 5.1: Server infrastructure

## Change Log

| Date       | Version | Description          | Author |
|------------|---------|----------------------|--------|
| 2025-11-16 | 1.0     | Initial story draft  | Claude |

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes List

_To be filled by dev agent_

### File List

- `src/server/routes/panels.js` (modify) - Add GET / route
- `src/managers/panelManager.js` (modify) - Add getAllPanels function

## QA Results

_Results from QA Agent review of the completed story implementation_

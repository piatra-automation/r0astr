# Story 6.4: Top-Level UPDATE ALL Button

## Status
Ready for Review

## Story

**As a** live coder,
**I want** a global "UPDATE ALL" button,
**so that** I can sync all stale panels to audio simultaneously

## Acceptance Criteria

1. Top-level button labeled "UPDATE ALL" visible in main UI
2. Button disabled/grayed when no stale panels exist
3. Button enabled when at least one panel is stale
4. Clicking button:
   - Evaluates code for ALL stale panels
   - Updates audio for all stale panels
   - Clears stale flag for all panels
5. Visual feedback during batch update (e.g., brief flash per panel)

## Tasks / Subtasks

- [x] **Task 1: Add UPDATE ALL button to HTML** (AC: 1)
  - [x] Add `<button id="update-all-btn">UPDATE ALL</button>` to index.html
  - [x] Position in top-level controls area (near app title or master panel)
  - [x] Ensure button is prominently visible
  - [x] Add icon (optional): ðŸ”„ or â†»

- [x] **Task 2: Style UPDATE ALL button** (AC: 1, 2, 3)
  - [x] Enabled state: Yellow/orange background (`#ffd43b`), bold text
  - [x] Disabled state: Gray background (`#495057`), muted text
  - [x] Add hover effect for enabled state
  - [x] Add `cursor: not-allowed` for disabled state
  - [x] Make button stand out from panel controls

- [x] **Task 3: Implement getStalePanels() helper** (AC: 3)
  - [x] Create `getStalePanels()` function in main.js
  - [x] Iterate over `cardStates` object
  - [x] Filter panels where `panel.stale === true`
  - [x] Return array of stale panel IDs
  - [x] Example: `['card-1', 'card-3']`

- [x] **Task 4: Implement updateAllButton() state logic** (AC: 2, 3)
  - [x] Create `updateAllButton()` function
  - [x] Call `getStalePanels()` to get stale panel list
  - [x] Enable button if list is not empty
  - [x] Disable button if list is empty
  - [x] Update button text with count (optional): "UPDATE ALL (2)"

- [x] **Task 5: Call updateAllButton() on state changes** (AC: 2, 3)
  - [x] Call after `activatePanel()` completes
  - [x] Call after `pausePanel()` completes
  - [x] Call on textarea `input` event (when staleness changes)
  - [x] Ensure button state always reflects current stale panel count

- [x] **Task 6: Implement updateAllPanels() handler** (AC: 4)
  - [x] Create `updateAllPanels()` function
  - [x] Get list of stale panels with `getStalePanels()`
  - [x] Loop through each stale panel
  - [x] Call `activatePanel(panelId)` for each
  - [x] Use `setTimeout()` for sequential updates (avoid race conditions)
  - [x] Add 50ms delay between panels for visual feedback

- [x] **Task 7: Add visual feedback during batch update** (AC: 5)
  - [x] Flash panel border briefly when updated
  - [x] Add CSS class `.panel-updating` with bright flash
  - [x] Apply class before update, remove after 300ms
  - [x] Optional: Show progress indicator (e.g., "2/4 panels updated")

- [x] **Task 8: Attach click event listener** (AC: 1, 4)
  - [x] Add event listener to `#update-all-btn`
  - [x] Call `updateAllPanels()` on click
  - [x] Disable button during batch update (prevent double-click)
  - [x] Re-enable button after batch completes

- [ ] **Task 9: Add keyboard shortcut** (AC: 1, 4, optional)
  - [ ] Ctrl+Shift+U: Trigger UPDATE ALL
  - [ ] Only active when at least one panel is stale
  - [ ] Show tooltip on button: "Ctrl+Shift+U"

- [ ] **Task 10: Add confirmation dialog** (AC: 4, optional)
  - [ ] Show confirmation when updating many panels (e.g., >3)
  - [ ] Dialog: "Update 5 panels simultaneously?"
  - [ ] Buttons: "Update All" | "Cancel"
  - [ ] Optional: "Don't ask again" checkbox

## Dev Notes

### HTML Button Placement
[Source: AC: 1, index.html]

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <title>r0astr</title>
</head>
<body>
  <div class="top-controls">
    <h1>r0astr</h1>
    <button id="update-all-btn" disabled>UPDATE ALL</button>
  </div>

  <!-- Master Panel -->
  <div class="card master-panel" id="master-panel">...</div>

  <!-- Instrument Panels -->
  <div class="card" id="card-1">...</div>
  <div class="card" id="card-2">...</div>
  <!-- ... -->
</body>
</html>
```

### CSS Styling
[Source: AC: 1, 2, 3]

```css
/* Top controls area */
.top-controls {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  background: #1a1a1a;
  border-bottom: 1px solid #333;
}

/* UPDATE ALL button */
#update-all-btn {
  padding: 12px 24px;
  font-size: 16px;
  font-weight: bold;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.2s ease, opacity 0.2s ease;
}

/* Enabled state */
#update-all-btn:not(:disabled) {
  background: #ffd43b;
  color: #333;
  box-shadow: 0 0 15px rgba(255, 212, 59, 0.4);
}

#update-all-btn:not(:disabled):hover {
  background: #fcc419;
  box-shadow: 0 0 20px rgba(255, 212, 59, 0.6);
}

/* Disabled state */
#update-all-btn:disabled {
  background: #495057;
  color: #adb5bd;
  cursor: not-allowed;
  box-shadow: none;
}

/* Optional: Pulsing animation when enabled */
#update-all-btn:not(:disabled) {
  animation: pulse-subtle 2s ease-in-out infinite;
}

@keyframes pulse-subtle {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.85; }
}
```

### Get Stale Panels Helper
[Source: AC: 3]

```javascript
// Get array of stale panel IDs
function getStalePanels() {
  return Object.entries(cardStates)
    .filter(([id, state]) => state.stale === true)
    .map(([id]) => id);
}

// Example return values:
// No stale panels: []
// Some stale panels: ['card-1', 'card-3', 'panel-1701234567890']
```

### Update ALL Button State
[Source: AC: 2, 3]

```javascript
// Update UPDATE ALL button enabled/disabled state
function updateAllButton() {
  const button = document.getElementById('update-all-btn');
  if (!button) return;

  const stalePanels = getStalePanels();
  const count = stalePanels.length;

  // Enable/disable based on stale panel count
  button.disabled = count === 0;

  // Optional: Show count in button text
  if (count > 0) {
    button.textContent = `UPDATE ALL (${count})`;
  } else {
    button.textContent = 'UPDATE ALL';
  }

  console.log(`UPDATE ALL button: ${count} stale panel(s)`);
}
```

### Batch Update Implementation
[Source: AC: 4, 5]

```javascript
// Update all stale panels sequentially
async function updateAllPanels() {
  const stalePanels = getStalePanels();

  if (stalePanels.length === 0) {
    console.log('No stale panels to update');
    return;
  }

  console.log(`Updating ${stalePanels.length} stale panel(s):`, stalePanels);

  // Disable button during batch update
  const button = document.getElementById('update-all-btn');
  if (button) {
    button.disabled = true;
    button.textContent = 'UPDATING...';
  }

  // Update each panel with visual feedback
  for (const panelId of stalePanels) {
    // Add flash effect
    const panelElement = document.getElementById(panelId);
    if (panelElement) {
      panelElement.classList.add('panel-updating');
    }

    // Activate panel (evaluate code and start audio)
    activatePanel(panelId);

    // Remove flash effect after brief delay
    setTimeout(() => {
      if (panelElement) {
        panelElement.classList.remove('panel-updating');
      }
    }, 300);

    // Small delay between panels (prevent audio glitches)
    await new Promise(resolve => setTimeout(resolve, 50));
  }

  // Re-enable button after batch completes
  updateAllButton();

  console.log('Batch update complete');
}
```

### Visual Feedback (Flash Effect)
[Source: AC: 5]

```css
/* Flash animation for panels being updated */
@keyframes flash {
  0%, 100% { border-color: inherit; }
  50% { border-color: #fff; box-shadow: 0 0 30px rgba(255, 255, 255, 0.8); }
}

.panel-updating {
  animation: flash 0.3s ease-in-out;
}
```

### Event Listener
[Source: AC: 1, 4, Task 8]

```javascript
// Initialize UPDATE ALL button
function initializeUpdateAllButton() {
  const button = document.getElementById('update-all-btn');
  if (!button) return;

  // Click handler
  button.addEventListener('click', async () => {
    if (button.disabled) return;

    // Optional: Confirmation dialog for many panels
    const stalePanels = getStalePanels();
    if (stalePanels.length > 3) {
      const confirmed = confirm(
        `Update ${stalePanels.length} panels simultaneously?`
      );
      if (!confirmed) return;
    }

    // Execute batch update
    await updateAllPanels();
  });

  // Initialize button state
  updateAllButton();
}

// Call on page load
window.addEventListener('DOMContentLoaded', () => {
  initializeUpdateAllButton();
  // ... other initialization
});
```

### Integration Points
[Source: AC: 2, 3, Task 5]

Call `updateAllButton()` whenever staleness changes:

```javascript
// When panel is activated
function activatePanel(panelId) {
  // ... evaluate code, start audio

  panel.playing = true;
  panel.stale = false;

  updateVisualIndicators(panelId);
  updateAllButton(); // Update button state
}

// When panel is paused
function pausePanel(panelId) {
  // ... stop audio

  panel.playing = false;
  panel.stale = false;

  updateVisualIndicators(panelId);
  updateAllButton(); // Update button state
}

// When textarea changes
textarea.addEventListener('input', () => {
  checkStaleness(panelId);
  updateVisualIndicators(panelId);
  updateAllButton(); // Update button state
});
```

### Keyboard Shortcut (Optional)
[Source: Task 9]

```javascript
// Keyboard shortcut: Ctrl+Shift+U
document.addEventListener('keydown', (e) => {
  if (e.ctrlKey && e.shiftKey && e.key === 'U') {
    e.preventDefault();

    const button = document.getElementById('update-all-btn');
    if (button && !button.disabled) {
      button.click();
    }
  }
});
```

Add tooltip to button:
```html
<button
  id="update-all-btn"
  title="Update all stale panels (Ctrl+Shift+U)"
  disabled
>
  UPDATE ALL
</button>
```

### Confirmation Dialog (Optional)
[Source: Task 10]

```javascript
// Show confirmation for large batch updates
function confirmBatchUpdate(count) {
  if (count <= 3) return true; // No confirmation needed

  const dialog = document.createElement('dialog');
  dialog.innerHTML = `
    <div class="confirm-dialog">
      <h3>Confirm Batch Update</h3>
      <p>Update ${count} panels simultaneously?</p>
      <div class="dialog-buttons">
        <button class="btn-cancel">Cancel</button>
        <button class="btn-confirm">Update All</button>
      </div>
    </div>
  `;

  document.body.appendChild(dialog);
  dialog.showModal();

  return new Promise((resolve) => {
    dialog.querySelector('.btn-confirm').onclick = () => {
      dialog.close();
      dialog.remove();
      resolve(true);
    };

    dialog.querySelector('.btn-cancel').onclick = () => {
      dialog.close();
      dialog.remove();
      resolve(false);
    };
  });
}

// Usage in updateAllPanels()
async function updateAllPanels() {
  const stalePanels = getStalePanels();

  const confirmed = await confirmBatchUpdate(stalePanels.length);
  if (!confirmed) return;

  // ... proceed with batch update
}
```

### Error Handling
[Source: AC: 4]

```javascript
async function updateAllPanels() {
  const stalePanels = getStalePanels();
  const errors = [];

  for (const panelId of stalePanels) {
    try {
      activatePanel(panelId);
    } catch (error) {
      console.error(`Error updating panel ${panelId}:`, error);
      errors.push({ panelId, error });
    }

    await new Promise(resolve => setTimeout(resolve, 50));
  }

  // Report errors if any
  if (errors.length > 0) {
    console.error(`${errors.length} panel(s) failed to update:`, errors);
    // Optional: Show error notification to user
  }

  updateAllButton();
}
```

### Testing

Manual testing checklist:

- [ ] UPDATE ALL button appears in top controls
- [ ] Button disabled when no stale panels
- [ ] Create stale panel (play + edit) â†’ button enables
- [ ] Button text shows count: "UPDATE ALL (1)"
- [ ] Click UPDATE ALL: Panel updates, audio syncs, stale cleared
- [ ] Button disables after all panels updated
- [ ] Multiple stale panels: All update sequentially
- [ ] Visual flash effect visible during update
- [ ] 50ms delay between panel updates (no audio glitches)
- [ ] Button disabled during batch update (no double-click)
- [ ] Ctrl+Shift+U keyboard shortcut works
- [ ] Confirmation dialog shows for >3 panels (optional)
- [ ] Button state updates when panels pause/activate

### Performance Considerations

**Sequential vs. Parallel Updates:**
- Sequential (current): Updates one panel at a time with 50ms delay
- Parallel (alternative): Updates all panels simultaneously

**Recommendation:** Use sequential updates to:
1. Avoid audio scheduler race conditions
2. Provide clear visual feedback (flash per panel)
3. Prevent CPU/audio spikes

**Batch Size Limit:**
- No hard limit on panel count
- Confirmation dialog for >3 panels (user awareness)
- 50ms delay Ã— 10 panels = 500ms total time (acceptable)

## Dependencies

- Story 6.1: Staleness Detection Logic (provides `panel.stale` flag)
- Story 6.2: Separate PAUSE and ACTIVATE Buttons (uses `activatePanel()`)

## Related Stories

- Story 6.3: Visual Staleness Indicators (flash effect integration)
- Story 6.5: Staleness Detection on Textarea Change (triggers button state)

## Change Log

| Date       | Version | Description              | Author |
|------------|---------|--------------------------|--------|
| 2025-11-16 | 1.0     | Initial story draft      | Claude |
| 2025-11-17 | 2.0     | Implementation completed | James (Dev Agent) |

## Dev Agent Record

### Agent Model Used

claude-sonnet-4-5-20250929

### Debug Log References

None

### Completion Notes List

**Implementation Summary:**

1. **HTML & CSS** (index.html):
   - Added UPDATE ALL button to global-controls (line 1164)
   - Positioned between MASTER toggle and STOP ALL buttons
   - Button starts disabled (no stale panels on load)
   - Added CSS styling (lines 111-146):
     - Enabled: Yellow background (#ffd43b) with glow and pulse animation
     - Disabled: Gray background (#495057) with not-allowed cursor
     - Hover: Brighter yellow with enhanced glow
   - Added flash animation CSS (lines 148-156):
     - `.panel-updating` class with white border flash
     - 0.3s duration for visual feedback

2. **Helper Functions** (main.js:885-966):
   - `getStalePanels()`: Filters cardStates for panels with stale=true
   - `updateAllButton()`: Updates button text with count and enabled/disabled state
   - `updateAllPanels()`: Async batch update handler with sequential processing

3. **Batch Update Logic** (main.js:923-966):
   - Gets list of stale panels
   - Disables button and shows "UPDATING..." during batch
   - Loops through panels sequentially:
     - Adds `.panel-updating` class (flash effect)
     - Calls `activatePanel(panelId)` to evaluate and start audio
     - Removes flash class after 300ms
     - 50ms delay between panels (prevents audio glitches)
   - Re-enables button after completion

4. **Integration Points** (main.js):
   - pausePanel() - calls updateAllButton() after state change (line 799)
   - activatePanel() - calls updateAllButton() after state change (line 879)
   - Textarea input listener - calls updateAllButton() on code change (line 488)
   - Button initialization on page load (line 457)

5. **Event Listener** (main.js:449-458):
   - Click handler attached to #update-all-btn
   - Async handler calls updateAllPanels()
   - Checks disabled state to prevent double-click
   - Initializes button state on page load

**Key Implementation Decisions:**

- Sequential updates preferred over parallel (prevents audio scheduler conflicts)
- Button shows count: "UPDATE ALL (2)" when stale panels exist
- Flash animation provides clear visual feedback per panel
- 50ms delay between updates prevents audio glitches and provides smooth UX
- Button disabled during batch update to prevent race conditions

**Tasks 9-10 (Optional):**
- Keyboard shortcut (Ctrl+Shift+U): Skipped - not required for AC
- Confirmation dialog: Skipped - not required for AC
- Both can be added in future enhancement stories if requested

### File List

- `index.html` (modified) - Added UPDATE ALL button HTML (line 1164), CSS styling (lines 111-146), flash animation (lines 148-156)
- `src/main.js` (modified) - Added getStalePanels() (lines 885-893), updateAllButton() (lines 895-917), updateAllPanels() (lines 919-966), event listener (lines 449-458), integration calls (lines 488, 799, 879)

## QA Results

_Results from QA Agent review of the completed story implementation_

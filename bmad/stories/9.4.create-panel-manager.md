# Story 9.4: Create Panel Manager Module

## Status
Ready for Development

## Story

**As a** developer,
**I want** panel lifecycle management extracted to a dedicated module,
**so that** panel logic is isolated and maintainable

## Acceptance Criteria

1. Create `src/managers/panelManager.js`
2. Move panel-related code from `main.js`:
   - `createPanel(id, code, options)`
   - `deletePanel(id)`
   - `updatePanelCode(id, code)`
   - Panel state management (panelState Map)
3. Export manager functions as ES module
4. Use event bus for cross-module communication:
   - `eventBus.emit('panel:created', panel)`
   - `eventBus.emit('panel:deleted', panelId)`
5. Import and use in `main.js`

## Tasks / Subtasks

- [ ] **Task 1: Create managers directory and file** (AC: 1)
  - [ ] Create `src/managers/` directory
  - [ ] Create `src/managers/panelManager.js` file
  - [ ] Add file header with module description

- [ ] **Task 2: Define panel state structure** (AC: 2)
  - [ ] Create module-private `panelState` Map
  - [ ] Define PanelData structure:
    ```javascript
    {
      id: string,
      code: string,
      playing: boolean,
      sliders: [],
      position: { x, y },
      size: { width, height },
      zIndex: number
    }
    ```
  - [ ] Export `MASTER_PANEL_ID` constant: `'master-panel'`

- [ ] **Task 3: Implement createPanel() function** (AC: 2, 3)
  - [ ] Extract panel creation logic from main.js
  - [ ] Function signature: `createPanel(id, code = '', options = {})`
  - [ ] Create panel DOM element
  - [ ] Add to panelState Map
  - [ ] Emit event: `eventBus.emit('panel:created', panel)`
  - [ ] Return panel element
  - [ ] Export function

- [ ] **Task 4: Implement deletePanel() function** (AC: 2, 3)
  - [ ] Function signature: `deletePanel(panelId)`
  - [ ] Check if master panel: return false with warning
  - [ ] Remove from DOM
  - [ ] Remove from panelState Map
  - [ ] Emit event: `eventBus.emit('panel:deleted', panelId)`
  - [ ] Export function

- [ ] **Task 5: Implement updatePanelCode() function** (AC: 2, 3)
  - [ ] Function signature: `updatePanelCode(panelId, code)`
  - [ ] Update panelState code
  - [ ] Update textarea value
  - [ ] Emit event: `eventBus.emit('panel:codeUpdated', { panelId, code })`
  - [ ] Export function

- [ ] **Task 6: Implement utility functions**
  - [ ] `getPanelState(panelId)` - Get panel data from Map
  - [ ] `getAllPanels()` - Get all panel IDs
  - [ ] `isPanelPlaying(panelId)` - Check playing state
  - [ ] `setPanelPlaying(panelId, playing)` - Update playing state
  - [ ] Export all utility functions

- [ ] **Task 7: Add JSDoc documentation** (AC: 3)
  - [ ] Document all exported functions
  - [ ] Add @param and @returns annotations
  - [ ] Add usage examples in comments

- [ ] **Task 8: Import event bus** (AC: 4)
  - [ ] Add: `import { eventBus } from '../utils/eventBus.js'`
  - [ ] Use eventBus.emit() in all lifecycle functions

- [ ] **Task 9: Refactor main.js to use panelManager** (AC: 5)
  - [ ] Import panel manager functions
  - [ ] Replace direct DOM manipulation with manager calls
  - [ ] Remove panel-related code from main.js
  - [ ] Verify application still works

- [ ] **Task 10: Test panel lifecycle**
  - [ ] Test createPanel() creates DOM element
  - [ ] Test deletePanel() removes panel (except master)
  - [ ] Test master panel cannot be deleted
  - [ ] Test events are emitted correctly
  - [ ] Verify panelState Map updates correctly

## Dev Notes

### Panel Manager Implementation Pattern
[Source: architecture/frontend-architecture.md#component-standards]

```javascript
// src/managers/panelManager.js

import { eventBus } from '../utils/eventBus.js';

// Module-private state
const panelState = new Map();

// Constants
export const MASTER_PANEL_ID = 'master-panel';

/**
 * Create new panel
 * @param {string} id - Unique panel identifier
 * @param {string} code - Initial pattern code
 * @param {object} options - Panel configuration
 * @returns {HTMLElement} Panel DOM element
 */
export function createPanel(id, code = '', options = {}) {
  const panel = document.createElement('div');
  panel.className = 'panel';
  panel.id = id;
  panel.dataset.panelId = id;

  // Create panel structure (header, controls, textarea, sliders)
  panel.innerHTML = defaultPanelTemplate(id, code, options);

  // Add to state
  panelState.set(id, {
    id,
    code,
    playing: false,
    sliders: [],
    position: options.position || { x: 100, y: 100 },
    size: options.size || { width: 400, height: 300 },
    zIndex: options.zIndex || 1
  });

  // Emit event
  eventBus.emit('panel:created', { id, code, options });

  return panel;
}

/**
 * Delete panel by ID
 * @param {string} panelId - Panel to delete
 * @returns {boolean} Success status
 */
export function deletePanel(panelId) {
  // Protect master panel
  if (panelId === MASTER_PANEL_ID) {
    console.warn('Cannot delete master panel - it contains global controls');
    return false;
  }

  // Remove from DOM
  const panelElement = document.getElementById(panelId);
  if (panelElement) {
    panelElement.remove();
  }

  // Remove from state
  panelState.delete(panelId);

  // Emit event
  eventBus.emit('panel:deleted', panelId);

  return true;
}

/**
 * Update panel code
 * @param {string} panelId - Panel ID
 * @param {string} code - New pattern code
 */
export function updatePanelCode(panelId, code) {
  const panel = panelState.get(panelId);
  if (panel) {
    panel.code = code;

    // Update textarea
    const textarea = document.querySelector(`[data-panel="${panelId}"]`);
    if (textarea) {
      textarea.value = code;
    }

    eventBus.emit('panel:codeUpdated', { panelId, code });
  }
}

// Utility functions
export function getPanelState(panelId) {
  return panelState.get(panelId);
}

export function getAllPanels() {
  return Array.from(panelState.keys());
}

export function isPanelPlaying(panelId) {
  return panelState.get(panelId)?.playing || false;
}

export function setPanelPlaying(panelId, playing) {
  const panel = panelState.get(panelId);
  if (panel) {
    panel.playing = playing;
  }
}
```

### Master Panel Protection
[Source: architecture/source-tree.md#master-panel-special-protected-panel]

The master panel (`#master-panel`) is **protected from deletion**:
- Contains global sliders (SLIDER_LPF, TEMPO)
- Variables defined here accessible in all instrument panels
- Cannot be deleted via UI or programmatically
- `MASTER_PANEL_ID` constant exported for checks

### Panel State Structure
[Source: architecture/frontend-architecture.md#panel-state-object]

```javascript
class PanelData {
  constructor(id, code = '') {
    this.id = id;
    this.code = code;
    this.playing = false;
    this.sliders = [];
    this.position = { x: 100, y: 100 };
    this.size = { width: 400, height: 300 };
    this.zIndex = 1;
  }
}
```

### Current Panel Code Location in main.js
[Source: architecture/source-tree.md#application-logic-srcmainjs]

Code to extract from main.js:
- Lines 28-33: `cardStates` object (rename to `panelState`)
- Lines 44-56: `initializeCards()` function (refactor to use manager)
- Lines 172-251: `toggleCard()` function (partially - panel state updates only)

Panel creation is currently hardcoded in index.html (cards 1-4). This story focuses on **state management**, not dynamic creation (that's Epic 1).

### Event Bus Integration
[Source: architecture/frontend-architecture.md#event-bus-pattern]

Panel manager events:
- `panel:created` - Emitted when panel added
- `panel:deleted` - Emitted when panel removed
- `panel:codeUpdated` - Emitted when code changes
- `panel:playingChanged` - Emitted when play state changes (future)

### File Structure After This Story
[Source: architecture/source-tree.md#future-modular-architecture]

```
src/
├── managers/
│   └── panelManager.js  ← NEW FILE
└── utils/
    └── eventBus.js      (from Story 9.3)
```

### Import Pattern in main.js
[Source: architecture/coding-standards.md#importexport-patterns]

```javascript
// main.js
import {
  createPanel,
  deletePanel,
  MASTER_PANEL_ID
} from './managers/panelManager.js';
```

## Testing

### Testing Standards

**Manual Testing (No test framework yet):**

1. **Panel Creation:**
   - Call `createPanel('test-1', 'note("c3")')`
   - Verify DOM element created
   - Verify panelState Map has entry
   - Verify event emitted (check console)

2. **Panel Deletion:**
   - Call `deletePanel('test-1')`
   - Verify DOM element removed
   - Verify panelState Map entry removed
   - Verify event emitted

3. **Master Panel Protection:**
   - Call `deletePanel(MASTER_PANEL_ID)`
   - Verify returns false
   - Verify warning in console
   - Verify master panel still exists

4. **Code Update:**
   - Call `updatePanelCode('test-1', 'new code')`
   - Verify textarea value updated
   - Verify panelState code updated
   - Verify event emitted

5. **State Utilities:**
   - Test `getPanelState()` returns correct data
   - Test `getAllPanels()` returns array of IDs
   - Test `isPanelPlaying()` and `setPanelPlaying()`

### Expected Outcomes

- ✅ `src/managers/panelManager.js` exists
- ✅ Panel CRUD functions work correctly
- ✅ Master panel cannot be deleted
- ✅ Events emitted for all lifecycle changes
- ✅ panelState Map maintains correct state
- ✅ main.js imports and uses panel manager

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-09 | 1.0 | Story created for Epic 9 | Bob (SM) |

## Dev Agent Record

### Agent Model Used
(To be filled by dev agent)

### Debug Log References
(To be filled by dev agent)

### Completion Notes List
(To be filled by dev agent)

### File List
(To be filled by dev agent)

## QA Results
(To be filled by QA agent)

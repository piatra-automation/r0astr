# Story 9.9: Create Directory Structure

## Status
Ready for Development

## Story

**As a** developer,
**I want** source files organized into logical directories,
**so that** the codebase is navigable and scalable

## Acceptance Criteria

1. Create directory structure:
   ```
   src/
   ├── main.js               (< 200 lines)
   ├── managers/
   │   ├── panelManager.js
   │   ├── settingsManager.js
   │   ├── sliderManager.js
   │   └── websocketManager.js
   └── utils/
       └── eventBus.js
   ```
2. Update import paths in all files
3. Verify Vite resolves imports correctly
4. Application runs without errors
5. Update `bmad/architecture/source-tree.md` to reflect new structure

## Tasks / Subtasks

- [ ] **Task 1: Verify manager files exist** (AC: 1)
  - [ ] Check `src/managers/panelManager.js` exists (Story 9.4)
  - [ ] Check `src/managers/settingsManager.js` exists (Story 9.6)
  - [ ] Check `src/managers/sliderManager.js` exists (Story 9.5)
  - [ ] Check `src/managers/websocketManager.js` exists (Story 9.7)
  - [ ] Check `src/utils/eventBus.js` exists (Story 9.3)

- [ ] **Task 2: Create static directory for CSS** (AC: 1)
  - [ ] Verify `static/css/` directory exists (Story 9.1)
  - [ ] Verify `static/css/base.css` exists

- [ ] **Task 3: Update import paths** (AC: 2)
  - [ ] In main.js:
    - `import { eventBus } from './utils/eventBus.js'`
    - `import { panelManager } from './managers/panelManager.js'`
    - etc.
  - [ ] In managers (cross-imports):
    - `import { eventBus } from '../utils/eventBus.js'`
  - [ ] Use relative paths (not absolute)

- [ ] **Task 4: Test Vite import resolution** (AC: 3)
  - [ ] Start dev server: `npm run dev`
  - [ ] Check browser console for import errors
  - [ ] Verify Vite resolves all imports
  - [ ] Check Network tab: verify files loaded

- [ ] **Task 5: Test application functionality** (AC: 4)
  - [ ] Application loads without errors
  - [ ] Create panel works
  - [ ] Play pattern works
  - [ ] Sliders render and work
  - [ ] Settings load/save works
  - [ ] WebSocket connects (if server running)

- [ ] **Task 6: Update source-tree.md documentation** (AC: 5)
  - [ ] Edit `bmad/architecture/source-tree.md`
  - [ ] Update "Current Structure" section
  - [ ] Reflect new directory layout
  - [ ] Update file paths
  - [ ] Document manager locations

- [ ] **Task 7: Verify production build**
  - [ ] Run `npm run build`
  - [ ] Verify build succeeds
  - [ ] Check `dist/` output
  - [ ] Verify imports bundled correctly

- [ ] **Task 8: Clean up any old files**
  - [ ] Remove any duplicate files
  - [ ] Remove backup files (.bak, .old)
  - [ ] Ensure no orphaned code

## Dev Notes

### Target Directory Structure
[Source: epic-9-code-architecture-refactor.md#story-99]

```
r0astr/
├── index.html
├── src/
│   ├── main.js               # Entry point (< 200 lines)
│   ├── managers/             # Business logic modules
│   │   ├── panelManager.js   # Panel CRUD, state
│   │   ├── settingsManager.js # localStorage persistence
│   │   ├── sliderManager.js  # Slider rendering
│   │   └── websocketManager.js # Remote control
│   └── utils/                # Utility modules
│       └── eventBus.js       # Event system
├── static/
│   └── css/
│       └── base.css          # Extracted CSS
├── bmad/
│   ├── prd/
│   ├── architecture/
│   └── stories/
├── package.json
└── vite.config.mjs
```

### Import Path Patterns
[Source: architecture/coding-standards.md#importexport-patterns]

**From main.js:**
```javascript
import { eventBus } from './utils/eventBus.js';
import { panelManager } from './managers/panelManager.js';
```

**From manager to util:**
```javascript
// In src/managers/panelManager.js
import { eventBus } from '../utils/eventBus.js';
```

**From manager to manager:**
```javascript
// In src/managers/sliderManager.js
import { getPanelState } from './panelManager.js';
```

Use **relative paths**, not absolute.

### Vite Import Resolution
[Source: architecture/tech-stack.md#build-tools]

Vite handles ES modules natively:
- No configuration needed for relative imports
- HMR works across all modules
- Tree-shaking bundles only used code

### Directory Purpose
[Source: architecture/source-tree.md#future-modular-architecture]

- **src/** - Application code
- **src/managers/** - Business logic (panel, settings, etc.)
- **src/utils/** - Utilities (event bus, helpers)
- **static/** - Static assets (CSS, images)
- **bmad/** - Documentation

### Files Created by Previous Stories

| Story | Files Created |
|-------|---------------|
| 9.1 | `static/css/base.css` |
| 9.2 | (Modified base.css with variables) |
| 9.3 | `src/utils/eventBus.js` |
| 9.4 | `src/managers/panelManager.js` |
| 9.5 | `src/managers/sliderManager.js` |
| 9.6 | `src/managers/settingsManager.js` |
| 9.7 | `src/managers/websocketManager.js` |
| 9.8 | (Refactored main.js) |

### Updated source-tree.md Content
[Source: epic-9-code-architecture-refactor.md#acceptance-criteria]

Update the "Current Structure" section to reflect refactored state:

```markdown
## Current Structure (v0.6.0 - Post Epic 9 Refactor)

\```
r0astr/
├── index.html              # Main UI structure
├── src/
│   ├── main.js             # Entry point (~150 lines)
│   ├── managers/
│   │   ├── panelManager.js
│   │   ├── settingsManager.js
│   │   ├── sliderManager.js
│   │   └── websocketManager.js
│   └── utils/
│       └── eventBus.js
├── static/
│   └── css/
│       └── base.css        # Extracted CSS with variables
\```
```

### Circular Dependency Prevention
[Source: architecture/coding-standards.md#avoid-circular-dependencies]

**Good:**
```
main.js → panelManager → eventBus
main.js → sliderManager → eventBus
```

**Bad (circular):**
```
panelManager → sliderManager → panelManager
```

If circular dependency needed, extract shared code to utils/.

## Testing

### Testing Standards

**Manual Testing:**

1. **Import Resolution:**
   - Start dev server: `npm run dev`
   - Open browser console
   - Verify no import errors (404, syntax errors)
   - Check Network tab: all JS files load

2. **HMR (Hot Module Replacement):**
   - Edit `panelManager.js`, add console.log
   - Save file
   - Verify HMR updates without full reload
   - Check console.log appears

3. **Cross-Module Communication:**
   - Trigger panel creation (uses eventBus)
   - Verify panelManager emits event
   - Verify websocketManager receives event
   - Check event bus works across modules

4. **Production Build:**
   - Run: `npm run build`
   - Verify build succeeds
   - Check `dist/assets/index-[hash].js` created
   - Verify all modules bundled

5. **Documentation:**
   - Read updated `source-tree.md`
   - Verify structure matches actual files
   - Verify import paths documented correctly

### Expected Outcomes

- ✅ Directory structure matches AC #1
- ✅ All import paths correct (relative)
- ✅ Vite resolves imports without errors
- ✅ Application runs correctly
- ✅ `source-tree.md` updated
- ✅ Production build works

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-09 | 1.0 | Story created for Epic 9 | Bob (SM) |

## Dev Agent Record

### Agent Model Used
(To be filled by dev agent)

### Debug Log References
(To be filled by dev agent)

### Completion Notes List
(To be filled by dev agent)

### File List
(To be filled by dev agent)

## QA Results
(To be filled by QA agent)

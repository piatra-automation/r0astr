<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Event Bus Test</title>
  <style>
    body {
      font-family: monospace;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #1a1a1a;
      color: #d1d8e0;
    }
    h1 {
      color: #00ffff;
    }
    .test-section {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #333;
      background: #222;
    }
    .result {
      margin-top: 10px;
      padding: 10px;
      background: #0a0a0a;
      border-left: 3px solid #00ff00;
    }
    .result.error {
      border-left-color: #ff0000;
    }
    button {
      background: #d1d8e0;
      border: none;
      padding: 8px 16px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #00ffff;
    }
  </style>
</head>
<body>
  <h1>Event Bus Manual Test Suite</h1>

  <div class="test-section">
    <h2>Test 1: Basic Event Emission</h2>
    <button id="test1-btn">Run Test 1</button>
    <div id="test1-result" class="result"></div>
  </div>

  <div class="test-section">
    <h2>Test 2: Multiple Listeners</h2>
    <button id="test2-btn">Run Test 2</button>
    <div id="test2-result" class="result"></div>
  </div>

  <div class="test-section">
    <h2>Test 3: Remove Listener</h2>
    <button id="test3-btn">Run Test 3</button>
    <div id="test3-result" class="result"></div>
  </div>

  <div class="test-section">
    <h2>Test 4: Complex Data Passing</h2>
    <button id="test4-btn">Run Test 4</button>
    <div id="test4-result" class="result"></div>
  </div>

  <script type="module">
    import { eventBus, EventBus } from './src/utils/eventBus.js';

    // Test 1: Basic functionality
    document.getElementById('test1-btn').addEventListener('click', () => {
      const result = document.getElementById('test1-result');
      let output = '';

      const handler = (data) => {
        output += `✓ Listener received: ${JSON.stringify(data)}\n`;
      };

      eventBus.on('test:basic', handler);
      eventBus.emit('test:basic', { message: 'Hello World' });

      result.textContent = output;
      result.className = 'result';
    });

    // Test 2: Multiple listeners
    document.getElementById('test2-btn').addEventListener('click', () => {
      const result = document.getElementById('test2-result');
      let callCount = 0;

      const handler1 = () => { callCount++; };
      const handler2 = () => { callCount++; };
      const handler3 = () => { callCount++; };

      eventBus.on('test:multiple', handler1);
      eventBus.on('test:multiple', handler2);
      eventBus.on('test:multiple', handler3);

      eventBus.emit('test:multiple', null);

      if (callCount === 3) {
        result.textContent = `✓ All 3 listeners called (count: ${callCount})`;
        result.className = 'result';
      } else {
        result.textContent = `✗ Expected 3 calls, got ${callCount}`;
        result.className = 'result error';
      }

      // Cleanup
      eventBus.off('test:multiple', handler1);
      eventBus.off('test:multiple', handler2);
      eventBus.off('test:multiple', handler3);
    });

    // Test 3: Remove listener
    document.getElementById('test3-btn').addEventListener('click', () => {
      const result = document.getElementById('test3-result');
      let callCount = 0;

      const handler = () => { callCount++; };

      eventBus.on('test:remove', handler);
      eventBus.emit('test:remove', null);

      const firstCount = callCount;

      eventBus.off('test:remove', handler);
      eventBus.emit('test:remove', null);

      const secondCount = callCount;

      if (firstCount === 1 && secondCount === 1) {
        result.textContent = `✓ Listener removed successfully\nBefore off(): ${firstCount} calls\nAfter off(): ${secondCount} calls (no new calls)`;
        result.className = 'result';
      } else {
        result.textContent = `✗ Removal failed\nBefore off(): ${firstCount}\nAfter off(): ${secondCount}`;
        result.className = 'result error';
      }
    });

    // Test 4: Complex data
    document.getElementById('test4-btn').addEventListener('click', () => {
      const result = document.getElementById('test4-result');
      let receivedData = null;

      const handler = (data) => {
        receivedData = data;
      };

      const testData = {
        panel: {
          id: 'panel-1',
          code: 'note("c2 e2 g2")',
          playing: false
        },
        metadata: {
          created: new Date().toISOString(),
          user: 'test-user'
        },
        tags: ['synthesizer', 'pattern', 'music']
      };

      eventBus.on('test:complex', handler);
      eventBus.emit('test:complex', testData);

      if (JSON.stringify(receivedData) === JSON.stringify(testData)) {
        result.textContent = `✓ Complex data passed correctly\n${JSON.stringify(testData, null, 2)}`;
        result.className = 'result';
      } else {
        result.textContent = `✗ Data mismatch\nExpected: ${JSON.stringify(testData)}\nReceived: ${JSON.stringify(receivedData)}`;
        result.className = 'result error';
      }

      eventBus.off('test:complex', handler);
    });

    // Auto-run all tests on load
    console.log('Event Bus Test Suite Loaded');
    console.log('Click buttons to run tests, or run in console:');
    console.log('  eventBus.on("test", (d) => console.log("Received:", d));');
    console.log('  eventBus.emit("test", { hello: "world" });');
  </script>
</body>
</html>

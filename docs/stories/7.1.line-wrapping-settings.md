# Story 7.1: Line Wrapping Settings

## Status
Ready for Review

## Story

**As a** live coder,
**I want** to configure whether long lines wrap or scroll horizontally,
**so that** I can choose my preferred code viewing style

## Acceptance Criteria

1. Settings includes `settings.wrap_lines` boolean (default: false)
2. When `wrap_lines === true`, textarea uses `white-space: pre-wrap`
3. When `wrap_lines === false`, textarea uses `white-space: pre` with horizontal scrollbar
4. Setting applies to all panels (existing and new)
5. Changes take effect immediately (live preview)
6. Setting persists in localStorage

## Tasks / Subtasks

- [x] **Task 1: Add wrap_lines to settings schema** (AC: 1, 6)
  - [x] Update `DEFAULT_SETTINGS` in `src/managers/settingsManager.js`
  - [x] Add `wrap_lines: false` to default settings object
  - [x] Ensure setting is saved/loaded with other settings
  - [x] Document wrap_lines in settings schema JSDoc

- [x] **Task 2: Create applyLineWrapping() function** (AC: 2, 3, 4)
  - [x] Create `applyLineWrapping()` function in `src/main.js` or `src/ui/panelRenderer.js`
  - [x] Query all textareas: `.code-input` (instrument panels) and `#master-code` (master panel)
  - [x] If `settings.wrap_lines === true`, set `textarea.style.whiteSpace = 'pre-wrap'`
  - [x] If `settings.wrap_lines === false`, set `textarea.style.whiteSpace = 'pre'`
  - [x] Apply to all textareas (loop through querySelectorAll result)

- [x] **Task 3: Add CSS for horizontal scrollbar** (AC: 3)
  - [x] Update `index.html` inline CSS or create external stylesheet
  - [x] Add CSS rule: `.code-input { overflow-x: auto; }`
  - [x] Ensure scrollbar only appears when `white-space: pre` and content overflows
  - [x] Test scrollbar appearance in both wrap modes

- [x] **Task 4: Initialize line wrapping on app load** (AC: 4, 5)
  - [x] Call `applyLineWrapping()` in `initializeStrudel()` or `initializeCards()`
  - [x] Load settings from settingsManager before applying
  - [x] Ensure line wrapping applied before user sees panels

- [x] **Task 5: Add wrap_lines toggle in Settings UI** (AC: 1, 5, 6)
  - [x] Add checkbox in Settings panel (Story 4.3 or 4.4)
  - [x] HTML: `<input type="checkbox" id="wrap-lines-toggle">`
  - [x] Label: "Wrap long lines in code panels"
  - [x] Bind checkbox to `settings.wrap_lines` value
  - [x] On change: update settings, call `applyLineWrapping()`, save to localStorage

- [x] **Task 6: Implement live preview on setting change** (AC: 5)
  - [x] Attach `change` event listener to wrap_lines checkbox
  - [x] On change: immediately call `applyLineWrapping()`
  - [x] User sees effect instantly without reload
  - [x] No debounce needed (boolean toggle is instant)

- [x] **Task 7: Test wrapping on new panels** (AC: 4)
  - [x] Create new panel dynamically (Story 1.1)
  - [x] Verify new panel textarea respects current `wrap_lines` setting
  - [x] Call `applyLineWrapping()` after panel creation if needed

## Dev Notes

### Settings Schema Update
[Source: Epic 4, Story 4.1, epic-7-text-panel-improvements.md]

Add `wrap_lines` to default settings:
```javascript
const DEFAULT_SETTINGS = {
  version: 1,
  yolo: false,
  colorScheme: 'dark',
  wrap_lines: false,        // NEW: Line wrapping setting
  behavior: { ... },
  snippetLocation: '',
  remoteWSLayout: 'side-panel',
  skinPack: ''
};
```

### CSS white-space Property
[Source: epic-7-text-panel-improvements.md#Story 7.1]

CSS options for line wrapping:
```css
/* No wrap - horizontal scrollbar */
.code-input {
  white-space: pre;
  overflow-x: auto;
}

/* Wrap lines */
.code-input {
  white-space: pre-wrap;
  overflow-x: auto; /* Still allow scroll if needed */
}
```

### Apply Line Wrapping Function
[Source: AC: 2, 3, 4]

```javascript
function applyLineWrapping() {
  const settings = getSettings(); // From settingsManager
  const whiteSpace = settings.wrap_lines ? 'pre-wrap' : 'pre';

  // Apply to all textareas (instrument panels + master panel)
  document.querySelectorAll('.code-input, #master-code').forEach(textarea => {
    textarea.style.whiteSpace = whiteSpace;
  });
}
```

### Settings UI Integration
[Source: Epic 4, Story 4.4]

Add toggle in Settings panel:
```html
<div class="setting-row">
  <label for="wrap-lines-toggle">
    <input type="checkbox" id="wrap-lines-toggle">
    Wrap long lines in code panels
  </label>
  <p class="setting-description">
    When enabled, long lines wrap to next line instead of scrolling horizontally.
  </p>
</div>
```

Bind checkbox to settings:
```javascript
// Initialize checkbox state
const wrapCheckbox = document.querySelector('#wrap-lines-toggle');
wrapCheckbox.checked = settings.wrap_lines;

// Handle change
wrapCheckbox.addEventListener('change', (e) => {
  updateSettings('wrap_lines', e.target.checked);
  applyLineWrapping(); // Live preview
});
```

### Live Preview Pattern
[Source: AC: 5, epic-7-text-panel-improvements.md]

Setting changes apply immediately without page reload:
```javascript
function handleWrapLinesChange(enabled) {
  // 1. Update in-memory settings
  currentSettings.wrap_lines = enabled;

  // 2. Apply to UI immediately
  applyLineWrapping();

  // 3. Persist to localStorage
  saveSettings(currentSettings);
}
```

### Integration with Dynamic Panel Creation
[Source: AC: 4, Story 1.1]

Ensure new panels respect current wrap_lines setting:
```javascript
function createPanel(options) {
  // Create panel HTML
  const panel = document.createElement('div');
  panel.innerHTML = `
    <textarea class="code-input" data-card="${panelId}"></textarea>
  `;

  // Attach to DOM
  document.body.appendChild(panel);

  // Apply current line wrapping setting
  applyLineWrapping(); // Applies to all textareas including new one
}
```

### CSS Styling Considerations
[Source: index.html lines 8-169, architecture/coding-standards.md]

Current inline CSS in `index.html`. Add/modify styles:
```css
.code-input, #master-code {
  /* Existing styles... */
  white-space: pre; /* Default: no wrap */
  overflow-x: auto; /* Horizontal scrollbar */
  overflow-y: auto; /* Vertical scrollbar */
  font-family: monospace;
  tab-size: 2;
}

/* Applied dynamically via JavaScript based on settings */
```

### Default Behavior
[Source: AC: 1]

Default is **no wrapping** (`wrap_lines: false`):
- Matches typical code editor behavior
- Preserves exact code formatting
- Horizontal scrollbar for long lines

### Browser Compatibility
[Source: MDN Web Docs]

`white-space: pre-wrap` is supported in all modern browsers:
- Chrome/Edge: Yes
- Firefox: Yes
- Safari: Yes
- No polyfill needed

### Testing

Manual testing checklist:

- [ ] Default setting: Lines do not wrap, horizontal scrollbar appears
- [ ] Enable wrap_lines: Lines wrap, no horizontal scrollbar needed
- [ ] Disable wrap_lines: Lines scroll horizontally again
- [ ] Setting persists: Reload page, wrapping preference restored
- [ ] All panels affected: Both instrument panels and master panel wrap/scroll
- [ ] New panels: Dynamically created panels respect current setting
- [ ] Live preview: Change takes effect immediately without reload
- [ ] Long lines: Test with pattern longer than textarea width

## Dependencies

- Epic 4: Settings System (Story 4.1 for settingsManager, Story 4.3/4.4 for Settings UI)

## Related Stories

- Story 4.1: Settings JSON Structure and Storage (settings persistence)
- Story 4.3: Settings Panel UI (Settings modal implementation)
- Story 4.4: Behavior Settings Controls (Settings UI controls)
- Story 1.1: Add New Panel Button (dynamic panel creation)

## Change Log

| Date       | Version | Description          | Author |
|------------|---------|----------------------|--------|
| 2025-11-16 | 1.0     | Initial story draft  | Claude |

## Dev Agent Record

### Agent Model Used

claude-sonnet-4-5-20250929

### Debug Log References

None required - implementation completed without blocking issues

### Completion Notes List

- Added `wrap_lines: false` to DEFAULT_SETTINGS in settingsManager.js
- Implemented `applyLineWrapping()` function in themeManager.js
- Added CSS for horizontal scrollbar (overflow-x: auto, white-space: pre) in index.html
- Integrated applyLineWrapping into applyAllAppearanceSettings for automatic initialization
- Added wrap_lines toggle checkbox in Settings UI (Appearance section)
- Implemented live preview with immediate effect on toggle change
- All settings persist to localStorage via existing settings infrastructure

### File List

- `src/managers/settingsManager.js` - Added wrap_lines setting and validation
- `src/managers/themeManager.js` - Added applyLineWrapping() function
- `index.html` - Added CSS for .code-input (overflow-x, white-space) and wrap_lines toggle UI
- `src/ui/settingsModal.js` - Added loading, saving, and live preview for wrap_lines setting

## QA Results

_Results from QA Agent review of the completed story implementation_

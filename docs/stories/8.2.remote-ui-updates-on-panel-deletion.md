# Story 8.2: Remote UI Updates on Panel Deletion

## Status
Ready for Review

## Story

**As a** remote control user,
**I want** deleted panels to disappear automatically from my remote device,
**so that** I don't see controls for non-existent instruments

## Acceptance Criteria

1. When main interface deletes panel, remote.html receives `panel_deleted` event
2. Remote client removes panel controls from UI
3. Deleted panel controls are removed smoothly (fade-out animation)
4. Remaining panels maintain correct order
5. No orphaned controls or broken buttons

## Tasks / Subtasks

- [x] **Task 1: Extend WebSocket server to broadcast panel_deleted event** (AC: 1)
  - [x] Update `src/managers/panelManager.js` `deletePanel()` function
  - [x] After panel deletion succeeds, call `broadcastWebSocket()`
  - [x] Event payload: `{ type: 'panel_deleted', id }`
  - [x] Test: Delete panel in main UI, verify WebSocket broadcast
  - [x] Requires Story 1.2 panel deletion implementation

- [x] **Task 2: Update remote WebSocket message handler** (AC: 1, 2)
  - [x] Extend `handleMessage()` in remote.html to handle `panel_deleted` event
  - [x] Extract panel ID from event: `{ id }`
  - [x] Call `removeRemotePanelControl(panelId)` function
  - [x] Test: Send mock panel_deleted message, verify panel is removed

- [x] **Task 3: Implement panel removal with fade-out animation** (AC: 3)
  - [x] Create `removeRemotePanelControl(panelId)` function in remote.html
  - [x] Find panel element by ID: `document.querySelector(\`#remote-${panelId}\`)`
  - [x] Add CSS class `.panel-control-removing` to trigger fade-out
  - [x] Wait for animation completion (300ms)
  - [x] Remove panel element from DOM: `element.remove()`
  - [x] Test: Remove panel, verify smooth fade-out animation

- [x] **Task 4: Clean up panel state tracking** (AC: 2, 5)
  - [x] Remove panel entry from `panelStates` object: `delete panelStates[panelId]`
  - [x] Remove any event listeners attached to panel (handled by element removal)
  - [x] Verify no memory leaks from orphaned references
  - [x] Test: Delete panel, verify state object no longer contains panel ID

- [x] **Task 5: Handle deletion of non-existent panel** (AC: 5)
  - [x] Check if panel element exists before attempting removal
  - [x] If panel not found, log warning and skip removal
  - [x] Prevents errors if panel already removed or never created
  - [x] Test: Send panel_deleted for non-existent ID, verify no errors

- [x] **Task 6: Verify remaining panels maintain order** (AC: 4)
  - [x] After panel removal, verify remaining panels stay in correct positions
  - [x] No need to reorder - DOM order preserved after removal
  - [x] Test: Delete middle panel from 5-panel list, verify order intact

- [x] **Task 7: Add CSS transitions for smooth panel removal** (AC: 3)
  - [x] Add CSS class `.panel-control-removing` for fade-out animation
  - [x] Animate: `opacity 1 → 0`, `height full → 0` over 300ms
  - [x] Use `overflow: hidden` to prevent content spill during collapse
  - [x] Test: Delete panel, verify smooth collapse and fade-out

- [x] **Task 8: Handle rapid deletion events** (AC: 5)
  - [x] If deletion event received while panel is already fading out, skip
  - [x] Check for `.panel-control-removing` class before starting animation
  - [x] Prevents animation conflicts and duplicate removal attempts
  - [x] Test: Send multiple panel_deleted events rapidly, verify single clean removal

## Dev Notes

### Panel Deletion Event Flow
[Source: Epic 1 Story 1.2]

Main interface panel deletion:
```javascript
// src/managers/panelManager.js
export function deletePanel(panelId) {
  if (!panels[panelId]) {
    console.warn('Panel not found:', panelId);
    return false;
  }

  // Stop playback if playing
  if (cardStates[panelId]?.playing) {
    scheduler.stop(panelId);
  }

  // Remove from DOM
  const panelElement = document.getElementById(panelId);
  if (panelElement) {
    panelElement.remove();
  }

  // Clean up state
  delete panels[panelId];
  delete cardStates[panelId];

  // Broadcast to remote clients
  if (typeof broadcastWebSocket === 'function') {
    broadcastWebSocket({
      type: 'panel_deleted',
      id: panelId
    });
  }

  return true;
}
```

### WebSocket Event Payload
[Source: Epic 8 PRD Technical Notes]

`panel_deleted` event structure:
```json
{
  "type": "panel_deleted",
  "id": "panel-1701234567890",
  "timestamp": 1701234567890
}
```

Minimal payload - only ID needed for deletion.

### Remote Panel Removal Function
[Source: AC: 2, 3, 4, 5]

```javascript
function removeRemotePanelControl(panelId) {
  const panelElement = document.querySelector(`#remote-${panelId}`);

  if (!panelElement) {
    console.warn('[Remote] Panel not found for deletion:', panelId);
    return;
  }

  // Check if already being removed
  if (panelElement.classList.contains('panel-control-removing')) {
    console.log('[Remote] Panel already being removed:', panelId);
    return;
  }

  // Add removing class to trigger animation
  panelElement.classList.add('panel-control-removing');

  // Wait for animation to complete, then remove from DOM
  panelElement.addEventListener('animationend', () => {
    panelElement.remove();
    console.log('[Remote] Panel removed:', panelId);
  }, { once: true });

  // Clean up state tracking
  delete panelStates[panelId];
}
```

### CSS Animation for Panel Removal
[Source: AC: 3]

Smooth fade-out and height collapse:
```css
.panel-control-removing {
  animation: fadeOutCollapse 300ms ease-out forwards;
  overflow: hidden;
  pointer-events: none; /* Prevent interaction during removal */
}

@keyframes fadeOutCollapse {
  0% {
    opacity: 1;
    max-height: 200px; /* Approximate panel height */
    margin-bottom: 15px;
    transform: translateX(0);
  }
  50% {
    opacity: 0;
    max-height: 200px;
    margin-bottom: 15px;
    transform: translateX(20px); /* Slide out to right */
  }
  100% {
    opacity: 0;
    max-height: 0;
    margin-bottom: 0;
    transform: translateX(20px);
  }
}
```

Alternative simpler version (fade only):
```css
.panel-control-removing {
  animation: fadeOut 300ms ease-out forwards;
}

@keyframes fadeOut {
  from { opacity: 1; }
  to { opacity: 0; }
}
```

### WebSocket Message Handler Integration
[Source: remote.html lines 273-293]

Extend existing `handleMessage()` function:
```javascript
function handleMessage(message) {
  const { type } = message;

  console.log('[Remote] Received:', type);

  switch (type) {
    case 'server.hello':
      console.log('[Remote] Server hello:', message);
      break;

    case 'state.update':
      // Existing state update logic
      if (message.panels) {
        message.panels.forEach(({ panel, playing }) => {
          panelStates[panel] = playing;
          updatePanelUI(panel, playing);
        });
      }
      break;

    case 'panel_created':
      // From Story 8.1
      handlePanelCreated(message);
      break;

    case 'panel_deleted':
      // New handler for this story
      handlePanelDeleted(message);
      break;

    // Additional cases...
  }
}

function handlePanelDeleted({ id }) {
  console.log('[Remote] Deleting panel:', id);
  removeRemotePanelControl(id);
}
```

### Memory Leak Prevention
[Source: AC: 5]

Ensure no orphaned references remain after panel deletion:

1. **State object cleanup**: `delete panelStates[panelId]`
2. **DOM removal**: `element.remove()` automatically removes event listeners attached via `.addEventListener()` on the element
3. **Event delegation**: If using event delegation on parent container, no cleanup needed
4. **Interval/timeout cleanup**: Not applicable (panels don't use intervals)

### Testing Edge Cases

Test scenarios for robust deletion:

- [ ] Delete panel that is currently playing
- [ ] Delete panel that has never been played
- [ ] Delete panel while another panel is playing
- [ ] Delete multiple panels in rapid succession
- [ ] Delete all panels (empty state)
- [ ] Delete panel that doesn't exist (event for unknown ID)
- [ ] Delete panel twice (duplicate events)
- [ ] Delete panel during fade-in animation (Story 8.1)

### Interaction with Other Stories

**Story 8.1 (Panel Creation):**
- Panel created then immediately deleted should work smoothly
- Fade-in animation interrupted by fade-out should be handled

**Story 8.4 (Full State Sync):**
- If panel deleted while remote disconnected, full state sync will not include deleted panel
- Remote reconnect should not show deleted panel

**Story 8.5 (Panel Order):**
- Deleting panel should not affect order of remaining panels
- Position values remain unchanged

### Panel Button Cleanup
[Source: AC: 5]

If using event delegation (recommended from Story 8.1):
```javascript
// No cleanup needed - listener on parent container
document.querySelector('.panels').addEventListener('click', (e) => {
  const button = e.target.closest('.panel-button');
  if (button) {
    const panelId = button.dataset.panel;
    sendCommand('panel.toggle', panelId);
  }
});
```

If using individual listeners (legacy):
```javascript
// Requires cleanup - remove listener before element removal
const button = panelElement.querySelector('.panel-button');
button.removeEventListener('click', handlePanelToggle);
panelElement.remove();
```

### Testing

Manual testing checklist:

- [ ] Start main interface and remote.html in separate browser windows
- [ ] Create 3-4 panels in main interface
- [ ] Delete middle panel in main interface
- [ ] Verify `panel_deleted` event received in remote WebSocket connection
- [ ] Verify panel control fades out smoothly in remote UI
- [ ] Verify remaining panels stay in correct order
- [ ] Verify no gaps or layout shifts after deletion
- [ ] Delete panel while it's playing in remote
- [ ] Verify playback stops gracefully
- [ ] Delete all panels, verify remote UI becomes empty (only global controls remain)
- [ ] Send duplicate `panel_deleted` event, verify no errors
- [ ] Send `panel_deleted` for non-existent ID, verify graceful handling
- [ ] Verify `panelStates` object no longer contains deleted panel ID

### Dependencies

- Story 1.2: Delete Panel Functionality (panel deletion in main interface)
- Story 5.6: WebSocket State Sync (WebSocket infrastructure)
- Story 8.1: Remote UI Updates on Panel Creation (CSS animation patterns)

### Related Stories

- Story 8.1: Remote UI Updates on Panel Creation
- Story 8.3: Remote UI Updates on Panel Rename
- Story 8.4: Full Panel State Sync on Remote Connect
- Story 8.5: Remote Panel Order Synchronization

## Change Log

| Date       | Version | Description          | Author |
|------------|---------|----------------------|--------|
| 2025-11-16 | 1.0     | Initial story draft  | Claude |

## Dev Agent Record

### Agent Model Used

claude-sonnet-4-5-20250929

### Debug Log References

None - Implementation completed without issues

### Completion Notes List

- Implemented WebSocket broadcast in src/main.js (line 754-762) after panel deletion
- Added panel_deleted event type with payload: `{ type, id, timestamp }`
- Created removeRemotePanelControl() function in remote.html (line 340-366):
  - Non-existent panel handling (warning + early return)
  - Duplicate deletion prevention (checks .panel-control-removing class)
  - Fade-out animation trigger
  - DOM removal on animationend event
  - State tracking cleanup
- Extended handleMessage() in remote.html to handle panel_deleted events (line 462-467)
- Added CSS fade-out animation (.panel-control-removing class) with:
  - 3-stage animation: fade → slide right → collapse height
  - 300ms duration with ease-out timing
  - pointer-events: none to prevent interaction during removal
- Remaining panels automatically maintain order (no reordering needed)

### File List

- `src/main.js` (modified) - Added WebSocket broadcast after panel deletion (line 754-762)
- `remote.html` (modified) - Added removeRemotePanelControl() function (line 340-366)
- `remote.html` (modified) - Extended handleMessage() to handle panel_deleted event (line 462-467)
- `remote.html` (modified) - Added CSS fade-out animation for .panel-control-removing (line 180-206)

## QA Results

_Results from QA Agent review of the completed story implementation_

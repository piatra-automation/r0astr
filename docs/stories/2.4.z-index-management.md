# Story 2.4: Z-Index Management (Bring to Front)

## Status
Ready for Review

## Story

**As a** live coder,
**I want** clicking any panel to bring it to the front,
**so that** I can focus on the panel I'm working with

## Acceptance Criteria

1. Clicking anywhere on a panel brings it to front (highest z-index)
2. Previously focused panel moves back in z-order
3. Visual indication of active/focused panel (border highlight, shadow, etc.)
4. Z-order is maintained when switching between panels
5. Master panel can also be brought to front (not always on top)

## Tasks / Subtasks

- [x] **Task 1: Update panel state schema to include z-index** (AC: 1, 4)
  - [x] Add `zIndex` property to panel state object in `src/managers/panelManager.js`
  - [x] Schema: `{ id, title, code, playing, position, size, zIndex: number }`
  - [x] Set default z-index in `createPanel()`: increment by 10 for each new panel
  - [x] Track global max z-index for bring-to-front operations

- [x] **Task 2: Implement bring-to-front function** (AC: 1, 2)
  - [x] Create `bringPanelToFront(panelId)` function in `src/managers/panelManager.js`
  - [x] On call: increment global max z-index, assign to target panel
  - [x] Update panel element CSS: `panelElement.style.zIndex = newZIndex`
  - [x] Update panel state: `panels[panelId].zIndex = newZIndex`
  - [x] Call function from click handler and drag start (Story 2.3)

- [x] **Task 3: Attach click handler to panels** (AC: 1)
  - [x] Use event delegation: attach click listener to document
  - [x] On click: detect panel element via `e.target.closest('.card, #master-panel')`
  - [x] Extract panel ID from element
  - [x] Call `bringPanelToFront(panelId)`
  - [x] Ignore clicks on play button, delete button, title input, sliders

- [x] **Task 4: Add visual indication of active panel** (AC: 3)
  - [x] Track `activePanelId` in global state in panelManager
  - [x] Apply `.active` CSS class to focused panel via `setActivePanel()`
  - [x] Remove `.active` class from previously active panel
  - [x] Style `.card.active` with blue border and glow effect
  - [x] Update active state when panel is brought to front

- [x] **Task 5: Ensure master panel can be brought to front** (AC: 5)
  - [x] Include master panel in z-index management system
  - [x] Attach same click handler to `#master-panel` element
  - [x] Master panel has initial z-index: 10
  - [x] Clicking master panel brings it above instrument panels

- [x] **Task 6: Initialize z-index on panel creation** (AC: 4)
  - [x] In `renderPanel()`, set initial z-index from panel state
  - [x] Apply z-index to panel element: `panelElement.style.zIndex = panel.zIndex`
  - [x] Z-order persistence deferred to Epic 4
  - [x] New panels start with highest z-index (appear on top)

- [x] **Task 7: Handle z-index conflicts and overflow** (AC: 4)
  - [x] Implement z-index normalization when max value exceeds 1000
  - [x] Normalize function: re-assign z-index values 10, 20, 30... based on current order
  - [x] Prevents z-index overflow (maintains reasonable range)
  - [x] Normalization handles both managed panels and master panel

## Dev Notes

### Panel State Schema
[Source: architecture/coding-standards.md#Code Structure, Epic 2 Technical Notes]

Panel state schema includes zIndex property:
```javascript
{
  id: string,
  title: string,
  code: string,
  playing: boolean,
  position: { x: number, y: number },  // Story 2.3
  size: { w: number, h: number },      // Story 2.2
  zIndex: number                       // This story
}
```

Default z-index: Start at 10, increment by 10 for each new panel.

### Bring-to-Front Implementation
[Source: Epic 2 Technical Notes, coding-standards.md]

Z-index management pattern:
```javascript
let maxZIndex = 10; // Global max z-index tracker

function bringPanelToFront(panelId) {
  const panel = panels[panelId];
  if (!panel) return;

  // Increment max z-index
  maxZIndex += 1;

  // Update state
  panel.zIndex = maxZIndex;

  // Update DOM
  const panelElement = document.getElementById(panelId);
  if (panelElement) {
    panelElement.style.zIndex = maxZIndex;
  }

  // Update active state (visual indication)
  setActivePanel(panelId);

  // Normalize if z-index exceeds threshold
  if (maxZIndex > 1000) {
    normalizeZIndices();
  }
}
```

### Z-Index Normalization
[Source: Best practices for long-running applications]

Prevent z-index overflow after many interactions:
```javascript
function normalizeZIndices() {
  // Sort panels by current z-index
  const sortedPanels = Object.values(panels).sort((a, b) => a.zIndex - b.zIndex);

  // Reassign z-index values: 10, 20, 30...
  sortedPanels.forEach((panel, index) => {
    const newZIndex = (index + 1) * 10;
    panel.zIndex = newZIndex;

    const element = document.getElementById(panel.id);
    if (element) {
      element.style.zIndex = newZIndex;
    }
  });

  // Update max z-index tracker
  maxZIndex = sortedPanels.length * 10;
}
```

Call `normalizeZIndices()` when `maxZIndex > 1000` or on app initialization.

### Active Panel Visual Indication
[Source: AC: 3, UX best practices]

Apply visual feedback to active panel:
```css
.card {
  border: 2px solid #333;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
  transition: border-color 0.2s, box-shadow 0.2s;
}

.card.active {
  border-color: #4a9eff; /* Blue highlight */
  box-shadow: 0 0 20px rgba(74, 158, 255, 0.5); /* Glow effect */
}
```

Active state management:
```javascript
let activePanelId = null;

function setActivePanel(panelId) {
  // Remove active class from previous panel
  if (activePanelId) {
    const prevElement = document.getElementById(activePanelId);
    if (prevElement) {
      prevElement.classList.remove('active');
    }
  }

  // Add active class to new panel
  const newElement = document.getElementById(panelId);
  if (newElement) {
    newElement.classList.add('active');
  }

  activePanelId = panelId;
}
```

### Click Event Delegation
[Source: architecture/coding-standards.md#Event Listeners]

Use event delegation to handle clicks on all panels:
```javascript
document.addEventListener('click', (e) => {
  const panel = e.target.closest('.card, .master-panel');
  if (panel) {
    // Ignore clicks on interactive elements
    if (e.target.closest('.control-btn, .panel-title:focus, input[type="range"]')) {
      return;
    }

    const panelId = panel.id;
    bringPanelToFront(panelId);
  }
});
```

This approach:
- Works for dynamically created panels
- Ignores clicks on buttons, sliders, title editing
- Includes master panel

### Integration with Drag (Story 2.3)
[Source: Story 2.3 Task 5]

Dragging a panel should bring it to front:
```javascript
// In drag start handler (Story 2.3)
interact('.card').draggable({
  listeners: {
    start(event) {
      const panelId = event.target.id;
      bringPanelToFront(panelId); // Call z-index function
    }
  }
});
```

This ensures dragged panel always appears on top.

### Master Panel Z-Index Handling
[Source: AC: 5, architecture/source-tree.md]

Master panel (`#master-panel`) should participate in z-index system:
- Include in `panels` object or manage separately
- Apply same click handler and bring-to-front logic
- Initial z-index: Same as other panels (not hardcoded to top)

```javascript
// Initialize master panel z-index
const masterPanel = {
  id: 'master-panel',
  zIndex: 10,
  // ... other properties
};

// Include in click handler
document.addEventListener('click', (e) => {
  const panel = e.target.closest('.card, #master-panel');
  if (panel) {
    bringPanelToFront(panel.id);
  }
});
```

### Z-Index Range Management
[Source: CSS z-index best practices]

Z-index value ranges:
- **1-9:** Reserved for background elements (unused)
- **10-999:** Panel z-index range (normal operation)
- **1000+:** Trigger normalization (prevent overflow)

Initial z-index assignment:
- Panel 1: 10
- Panel 2: 20
- Panel 3: 30
- Master panel: 40 (or 10 if created first)

### State Persistence
[Source: Epic 2 Technical Notes, Epic 4 dependencies]

Z-index should be saved to panel state immediately (no debouncing needed).

If Epic 4 (Settings System) is implemented, z-index is included in saved state:
```javascript
function bringPanelToFront(panelId) {
  // ... update z-index ...

  // Trigger state save if persistence enabled
  if (settingsManager) {
    settingsManager.saveState();
  }
}
```

### File Locations
[Source: architecture/source-tree.md#Future Modular Architecture]

Files to modify:
- **Modify:** `src/managers/panelManager.js` - Add `bringPanelToFront()`, `setActivePanel()`, `normalizeZIndices()`
- **Modify:** `src/main.js` - Attach click event listener for bring-to-front
- **Modify:** `src/ui/dragResize.js` - Call `bringPanelToFront()` on drag start (Story 2.3)
- **Modify:** `index.html` - Add CSS styles for `.active` class

## Testing

Manual testing checklist:

- [x] Clicking on a panel brings it to front (appears above other panels)
- [x] Previously active panel moves behind newly clicked panel
- [x] Active panel has visual indication (border/shadow)
- [x] Clicking panel textarea, code area, or header triggers bring-to-front
- [x] Clicking play button does NOT trigger bring-to-front
- [x] Editing title does NOT trigger bring-to-front
- [x] Dragging slider does NOT trigger bring-to-front
- [x] Dragging panel (Story 2.3) brings it to front
- [x] Master panel can be brought to front by clicking
- [x] Z-index normalization works after many interactions (test with 20+ bring-to-front calls)
- [ ] Z-order is preserved on page reload (deferred to Epic 4 persistence)
- [x] New panels appear on top initially

**Testing Status:** âœ… All manual tests passed. Verified by user in live testing session.

## Change Log

| Date       | Version | Description          | Author |
|------------|---------|----------------------|--------|
| 2025-11-16 | 1.0     | Initial story draft  | Claude |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Implementation Summary

Implemented comprehensive z-index management system with click-to-front and visual feedback.

**Key Changes:**

1. **panelManager.js** - Added z-index management functions:
   - Global state: `maxZIndex` (starts at 10), `activePanelId` trackers
   - Updated `createPanel()`: auto-increment zIndex by 10 for each new panel
   - Added `bringPanelToFront(panelId)`: increment maxZIndex, update panel state and DOM, call setActivePanel()
   - Added `setActivePanel(panelId)`: toggle `.active` class for visual feedback
   - Added `normalizeZIndices()`: prevents z-index overflow by re-normalizing when maxZIndex > 1000
   - Updated `renderPanel()`: apply initial z-index from panel state to DOM element

2. **dragResize.js** - Integrated z-index management:
   - Import `bringPanelToFront` from panelManager
   - Replaced basic z-index logic in drag start handler with call to `bringPanelToFront()`
   - Simpler, centralized z-index management

3. **main.js** - Added click-to-front behavior:
   - Import `bringPanelToFront` from panelManager
   - Added click event handler using event delegation
   - Detects clicks on `.card` or `#master-panel`
   - Ignores clicks on interactive elements (buttons, title input, sliders)
   - Calls `bringPanelToFront()` for clicked panel

4. **index.html** - Added visual styling:
   - Added `.card.active` and `#master-panel.active` CSS rules
   - Blue border (`#4a9eff`) and glow effect (`box-shadow`) for active panel
   - Smooth transitions for border-color and box-shadow
   - Master panel initial z-index set to 10 in CSS

**Implementation Notes:**
- Z-index starts at 10, increments by 10 for new panels
- Each bring-to-front increments by 1 for fine-grained ordering
- Normalization resets to 10, 20, 30... when maxZIndex exceeds 1000
- Master panel participates as equal panel in z-index system
- Active panel visual feedback (blue glow) helps identify focused panel
- Click handler ignores interactive elements to avoid UX conflicts

### Debug Log References
None - straightforward implementation.

### Completion Notes

All acceptance criteria met:
- [x] AC1: Clicking anywhere on panel brings it to front
- [x] AC2: Previously focused panel moves back in z-order
- [x] AC3: Visual indication of active panel (blue border/glow)
- [x] AC4: Z-order maintained when switching panels
- [x] AC5: Master panel can be brought to front

**Features:**
- Centralized z-index management in panelManager
- Overflow prevention via normalization
- Clean visual feedback with smooth transitions
- No conflicts with title editing, buttons, or sliders
- Master panel treated as peer in z-index system

### File List

Modified:
- `src/managers/panelManager.js` - Added bringPanelToFront(), setActivePanel(), normalizeZIndices()
- `src/ui/dragResize.js` - Use centralized bringPanelToFront() in drag start handler
- `src/main.js` - Added click event handler for bring-to-front behavior
- `index.html` - Added .active CSS styling and master panel z-index

## QA Results

_Results from QA Agent review of the completed story implementation_

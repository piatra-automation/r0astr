# Story 1.2: Delete Panel Functionality

## Status
Complete

## Story

**As a** live coder,
**I want** to delete panels I no longer need,
**so that** I can simplify my workspace and remove unused instruments

## Acceptance Criteria

1. Each panel (except master panel) has a visible [X] delete button in header
2. Master panel does NOT have a delete button (protected)
3. Clicking [X] either:
   - Immediately deletes panel if `settings.yolo === true`
   - Shows confirmation dialog if `settings.yolo === false`
4. Deleted panel is removed from DOM
5. Deleted panel's audio pattern is stopped
6. Panel IDs remain stable for remaining panels (no re-indexing)

## Tasks / Subtasks

- [x] **Task 1: Add [X] button to panel HTML** (AC: 1, 2)
  - [x] Modify `renderPanel()` in panelManager.js to include delete button
  - [x] Add `<button class="delete-btn" data-panel="${panelId}">×</button>` to panel header
  - [x] Conditionally render: skip delete button if `panelId === 'master-panel'`
  - [x] Style delete button (top-right corner, prominent)

- [x] **Task 2: Implement deletePanel() function** (AC: 4, 5, 6)
  - [x] Create `deletePanel(panelId)` in panelManager.js
  - [x] Stop audio pattern: `scheduler.stop(panelId)`
  - [x] Remove from `cardStates` object
  - [x] Remove panel DOM element: `document.getElementById(panelId).remove()`
  - [x] Do NOT re-index remaining panel IDs (keep stable)

- [x] **Task 3: Add master panel protection** (AC: 2, 3)
  - [x] In `deletePanel()`, check if `panelId === 'master-panel'`
  - [x] If master panel, throw error or silently return (no deletion)
  - [x] Ensure master panel HTML never renders delete button

- [x] **Task 4: Implement settings.yolo behavior** (AC: 3)
  - [x] Check for `window.settings.yolo` flag (default: false)
  - [x] If `yolo === true`, call `deletePanel()` immediately
  - [x] If `yolo === false`, show `confirm()` dialog first
  - [x] Confirmation message: "Delete panel '[title]'? This cannot be undone."

- [x] **Task 5: Wire delete button click handler** (AC: 1, 3)
  - [x] Use event delegation: listen for `.delete-btn` clicks
  - [x] Extract `panelId` from `data-panel` attribute
  - [x] Call delete logic with yolo check

## Dev Notes

### Settings Integration
[Source: docs/prd/epic-4-settings-system.md]

`settings.yolo` parameter controls deletion confirmation:
- If `true`: Skip confirmation dialog (YOLO mode)
- If `false` or undefined: Show confirmation before deleting

For Story 1.2, implement basic check of `window.settings.yolo`:
```javascript
const shouldConfirm = !(window.settings && window.settings.yolo);
if (shouldConfirm) {
  if (!confirm(`Delete panel '${panel.title}'?`)) return;
}
deletePanel(panelId);
```

Note: Full settings system implemented in Epic 4. For now, use simple global object.

### Master Panel Identification
[Source: docs/prd/epic-1-dynamic-panel-management.md#Story 1.3]

Master panel has special ID and CSS class:
- ID: `master-panel` (existing in index.html)
- CSS class: `.master-panel`
- Cannot be deleted programmatically or via UI

### File Locations

Modify:
- `src/managers/panelManager.js` - Add `deletePanel(panelId)` function
- `src/main.js` - Attach delete button event listener

### Coding Standards
[Source: architecture/coding-standards.md]

Error handling for deletion:
```javascript
function deletePanel(panelId) {
  // Protect master panel
  if (panelId === 'master-panel') {
    console.warn('Cannot delete master panel');
    return;
  }

  // Stop audio
  try {
    scheduler.stop(panelId);
  } catch (error) {
    console.error(`Failed to stop panel ${panelId}:`, error);
  }

  // Remove from state and DOM
  delete cardStates[panelId];
  const panelElement = document.getElementById(panelId);
  if (panelElement) panelElement.remove();
}
```

### Panel ID Stability
[Source: AC 6]

**IMPORTANT**: Do NOT re-index panel IDs after deletion.

Example:
- Before: `panel-1`, `panel-2`, `panel-3`
- Delete `panel-2`
- After: `panel-1`, `panel-3` (NOT `panel-1`, `panel-2`)

This ensures:
- Audio patterns remain correctly mapped (`.p('panel-1')`)
- No confusion during deletion
- Simpler implementation (no re-indexing logic)

### Testing

Manual testing checklist:

- [ ] Non-master panels show [X] button
- [ ] Master panel does NOT show [X] button
- [ ] With yolo=false: Confirmation dialog appears before delete
- [ ] With yolo=true: Panel deletes immediately without dialog
- [ ] Deleted panel removed from DOM
- [ ] Deleted panel audio stops playing
- [ ] Remaining panel IDs unchanged after deletion
- [ ] Cannot delete master panel (button never rendered)

## Change Log

| Date       | Version | Description          | Author |
|------------|---------|----------------------|--------|
| 2025-11-16 | 1.0     | Initial story draft  | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

_No blocking issues encountered_

### Completion Notes List

- All 5 tasks completed successfully
- Added red × delete button to all non-master panels
- Master panel protected at both UI level (no button) and logic level (deletePanel check)
- Enhanced deletePanel() function with full cleanup (audio, state, DOM)
- Implemented settings.yolo confirmation behavior (defaults to safe mode)
- Event delegation ensures delete works for dynamically created panels
- Panel IDs remain stable after deletion (no re-indexing)
- Delete button styled with red theme matching STOP ALL button

### File List

- `index.html` (modified) - Added .delete-btn CSS styling
- `src/managers/panelManager.js` (modified) - Enhanced deletePanel(), added delete button to renderPanel()
- `src/main.js` (modified) - Import deletePanel/getPanel, add delete button event delegation

## QA Results

_Results from QA Agent review of the completed story implementation_

# Story 2.1: Editable Panel Titles

## Status
Ready for Review

## Story

**As a** live coder,
**I want** to edit panel titles by clicking on them,
**so that** I can give meaningful names to my instruments (e.g., "Bass", "Drums", "Lead")

## Acceptance Criteria

1. Panel title displays in header as editable text
2. Clicking title enters edit mode (contenteditable or input field)
3. Pressing Enter or clicking away saves new title
4. Title persists in panel state (not lost on page reload if persistence enabled)
5. Default title is "Instrument N" where N is creation order

## Tasks / Subtasks

- [x] **Task 1: Update panel state schema to include title** (AC: 4)
  - [x] Add `title` property to panel state object in `src/managers/panelManager.js`
  - [x] Schema: `{ id, title: string, code, playing, position, size, zIndex }`
  - [x] Set default title in `createPanel()`: `Instrument ${nextNumber}`
  - [x] Ensure title is preserved when panel state is saved

- [x] **Task 2: Modify panel HTML to use editable title element** (AC: 1, 5)
  - [x] Update `renderPanel()` in `src/managers/panelManager.js`
  - [x] Replace static `<h3>` with editable element: `<h3 class="panel-title" data-panel-id="${panelId}" contenteditable="true">`
  - [x] Set initial title text to panel state title value
  - [x] Apply CSS to indicate editability (cursor: text, hover state)

- [x] **Task 3: Implement click-to-edit behavior** (AC: 2)
  - [x] Attach event listener to `.panel-title` elements
  - [x] On click: select all text in title element for easy editing
  - [x] Use `window.getSelection()` for text selection
  - [x] Add visual feedback for edit mode (border, focus state)

- [x] **Task 4: Implement save-on-blur and save-on-enter** (AC: 3)
  - [x] Attach `blur` event listener to `.panel-title` elements
  - [x] On blur: get new title text, update panel state via `updatePanelTitle(panelId, newTitle)`
  - [x] Attach `keydown` event listener to `.panel-title` elements
  - [x] On Enter key: blur element to trigger save (prevent default to avoid line break)
  - [x] Validate title is not empty (fallback to previous title if empty)

- [x] **Task 5: Create title update function** (AC: 4)
  - [x] Implement `updatePanelTitle(panelId, newTitle)` in `src/managers/panelManager.js`
  - [x] Update panel state object: `panels[panelId].title = newTitle`
  - [x] If settings persistence is enabled (Epic 4), trigger save to localStorage
  - [x] Emit event or callback for future state synchronization

- [x] **Task 6: Add CSS styling for editable titles** (AC: 1, 2)
  - [x] Style `.panel-title` with `cursor: text` to indicate editability
  - [x] Add hover state: subtle highlight or underline
  - [x] Add focus state: border or background change when editing
  - [x] Ensure text remains readable and doesn't overflow panel header

## Dev Notes

### Panel State Schema
[Source: architecture/coding-standards.md#Code Structure]

Panel state schema from Story 1.1:
```javascript
{
  id: string,           // Unique ID (e.g., 'panel-1701234567890')
  title: string,        // Editable title (e.g., 'Bass', 'Drums')
  code: string,         // Pattern code
  playing: boolean,     // Current playback state
  position: { x, y },   // For drag/drop (Epic 2, Story 2.3)
  size: { w, h },       // For resize (Epic 2, Story 2.2)
  zIndex: number        // For bring-to-front (Epic 2, Story 2.4)
}
```

Title property is now required and must have sensible default value.

### HTML Structure Pattern
[Source: architecture/source-tree.md#Entry Point]

Current HTML structure (static):
```html
<div class="card-header">
  <h3>Instrument 1</h3>
  <button class="control-btn" data-card="card-1">Play</button>
</div>
```

Updated structure (editable):
```html
<div class="card-header">
  <h3 class="panel-title" data-panel-id="panel-123" contenteditable="true">Instrument 1</h3>
  <button class="control-btn" data-card="panel-123">Play</button>
</div>
```

### Event Delegation Pattern
[Source: architecture/coding-standards.md#Event Listeners]

Use event delegation for dynamically created panels:
```javascript
document.addEventListener('blur', (e) => {
  const titleElement = e.target.closest('.panel-title');
  if (titleElement) {
    const panelId = titleElement.dataset.panelId;
    const newTitle = titleElement.textContent.trim();
    if (newTitle) {
      updatePanelTitle(panelId, newTitle);
    } else {
      // Restore previous title if empty
      titleElement.textContent = panels[panelId].title;
    }
  }
}, true); // Use capture phase for blur events
```

### ContentEditable vs Input Field
[Source: Epic 2 Technical Notes]

**Option A: ContentEditable (Recommended)**
- Pros: Inline editing, maintains styling, no layout shift
- Cons: Requires manual text selection, potential XSS risk (sanitize input)

**Option B: Input Field Replacement**
- Pros: Native input behavior, automatic focus
- Cons: Layout shift, requires DOM swap, more complex

**Decision:** Use `contenteditable="true"` on `<h3>` for simplicity.

### Enter Key Handling
[Source: architecture/coding-standards.md#Event Listeners]

Prevent line breaks in title:
```javascript
titleElement.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault(); // Prevent line break
    e.target.blur();    // Trigger save via blur event
  }
});
```

### Validation and Sanitization
[Source: architecture/coding-standards.md#Security]

Sanitize title input to prevent XSS:
```javascript
function sanitizeTitle(title) {
  // Remove HTML tags, limit length
  return title.replace(/<[^>]*>/g, '').substring(0, 50).trim();
}
```

### CSS Styling Considerations
[Source: architecture/tech-stack.md#Language]

Current inline CSS in `index.html` lines 8-169.

Add styles for editable titles:
```css
.panel-title {
  cursor: text;
  border: 1px solid transparent;
  padding: 2px 4px;
  border-radius: 2px;
  transition: border-color 0.2s, background-color 0.2s;
}

.panel-title:hover {
  background-color: rgba(255, 255, 255, 0.05);
}

.panel-title:focus {
  outline: none;
  border-color: #4a9eff;
  background-color: rgba(74, 158, 255, 0.1);
}
```

### Default Title Generation
[Source: architecture/coding-standards.md#Naming Conventions]

Generate default title based on panel creation order:
```javascript
function generateDefaultTitle(panels) {
  const panelCount = Object.keys(panels).length;
  return `Instrument ${panelCount + 1}`;
}
```

### State Persistence Integration
[Source: Epic 2 Technical Notes and Epic 4 Dependencies]

Title changes should be saved to panel state immediately. If Epic 4 (Settings System) is implemented, title updates should trigger `settingsManager.saveState()`.

Current implementation (without persistence):
```javascript
function updatePanelTitle(panelId, newTitle) {
  if (panels[panelId]) {
    panels[panelId].title = sanitizeTitle(newTitle);
    // Future: settingsManager.saveState();
  }
}
```

### File Locations
[Source: architecture/source-tree.md#Future Modular Architecture]

Files to create/modify:
- **Modify:** `src/managers/panelManager.js` - Add title update function
- **Modify:** `src/ui/panelRenderer.js` - Update panel HTML generation
- **Modify:** `src/main.js` - Attach event listeners for title editing
- **Modify:** `index.html` - Add CSS styles for editable titles

## Testing

Manual testing checklist:

- [ ] Click on panel title enters edit mode
- [ ] Title text is selected automatically on click
- [ ] Typing updates title text in real-time
- [ ] Pressing Enter saves title and exits edit mode
- [ ] Clicking away (blur) saves title and exits edit mode
- [ ] Empty title is rejected (reverts to previous title)
- [ ] Title persists in panel state object
- [ ] New panels have default title "Instrument N"
- [ ] Title updates work for both statically created and dynamically created panels
- [ ] No XSS vulnerability (HTML tags are stripped from title input)

## Change Log

| Date       | Version | Description          | Author |
|------------|---------|----------------------|--------|
| 2025-11-16 | 1.0     | Initial story draft  | Claude |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Implementation Summary

All tasks completed successfully. Panel titles are now fully editable with click-to-select, blur-to-save, and Enter-to-save behavior.

**Key Changes:**
1. Updated `renderPanel()` in panelManager.js to make `<h3>` contenteditable with class `panel-title` (line 157)
2. Added `updatePanelTitle()` function with XSS sanitization (lines 97-119 in panelManager.js)
3. Implemented click-to-select event handler (lines 330-341 in main.js)
4. Implemented blur-to-save event handler with validation (lines 343-368 in main.js)
5. Implemented Enter-to-save event handler (lines 370-377 in main.js)
6. Added CSS styling for editable titles with hover and focus states (lines 204-220 in index.html)

**Implementation Notes:**
- Panel title schema was already in place from Story 1.1 (line 47 panelManager.js)
- Used contenteditable="true" approach for inline editing
- Title sanitization prevents XSS (removes HTML tags, limits length to 50 chars)
- Empty titles are rejected and reverted to previous value
- Event delegation pattern ensures handlers work for dynamically created panels
- Capture phase used for blur events (required for contenteditable elements)

### Debug Log References
None - straightforward implementation, no issues encountered.

### Completion Notes

Implementation follows coding standards and story requirements exactly. All acceptance criteria met:
- [x] AC1: Panel title displays as editable text
- [x] AC2: Clicking title enters edit mode (select all)
- [x] AC3: Enter or blur saves new title
- [x] AC4: Title persists in panel state
- [x] AC5: Default title is "Instrument N"

**Security:** Title input is sanitized to prevent XSS attacks.
**UX:** Visual feedback via hover and focus states provides clear editability cues.
**Compatibility:** Event delegation ensures works with both existing and dynamically created panels.

### File List

Modified:
- `src/managers/panelManager.js` - Added updatePanelTitle() function, updated renderPanel() with contenteditable title
- `src/main.js` - Added event handlers for title editing (click-to-select, blur-to-save, Enter-to-save)
- `index.html` - Added CSS styling for .panel-title class
- `docs/stories/2.1.editable-panel-titles.md` - This file (Dev Agent Record, task checkboxes, status)

## QA Results

_Results from QA Agent review of the completed story implementation_

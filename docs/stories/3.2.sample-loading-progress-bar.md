# Story 3.2: Sample Loading Progress Bar

## Status
Ready for Review

## Story

**As a** user,
**I want** to see a progress bar showing sample loading status,
**so that** I understand what the system is doing and how long it will take

## Acceptance Criteria

1. Progress bar displays below branding in splash modal
2. Progress updates based on actual sample loading progress (if detectable)
3. If progress not detectable, animated indeterminate progress bar
4. Text label shows status: "Loading samples..." or similar
5. Progress bar visually indicates completion before splash dismisses

## Tasks / Subtasks

- [x] **Task 1: Add progress bar HTML to splash modal** (AC: 1, 4)
  - [x] Add progress bar container to `.splash-content` in `index.html`
  - [x] Create progress bar structure: `<div class="splash-progress-container">`
  - [x] Add progress bar element: `<div class="splash-progress-bar"><div class="splash-progress-fill"></div></div>`
  - [x] Add status text: `<p class="splash-status">Loading samples...</p>`
  - [x] Position below branding elements, above any future controls

- [x] **Task 2: Style progress bar** (AC: 1, 3)
  - [x] Add CSS for `.splash-progress-bar` in `index.html` inline styles
  - [x] Container: `width: 300px; height: 6px; background: #333; border-radius: 3px; overflow: hidden`
  - [x] Fill bar: `.splash-progress-fill` with `height: 100%; background: linear-gradient(90deg, #4a9eff, #7ec8ff); transition: width 0.3s ease`
  - [x] Status text: `.splash-status` with muted color, centered, small font
  - [x] Initial state: progress fill at 0% width

- [x] **Task 3: Create indeterminate progress animation** (AC: 3)
  - [x] Add CSS keyframe animation for indeterminate state
  - [x] Animation: sliding gradient or pulsing bar effect
  - [x] Add class `.splash-progress-indeterminate` for animated state
  - [x] Example: `@keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }`
  - [x] Apply animation to `.splash-progress-fill` when indeterminate class is active

- [x] **Task 4: Investigate Strudel sample loading events** (AC: 2)
  - [x] Research `@strudel/webaudio` package for progress events
  - [x] Check `samples()` function in `src/main.js` lines 106-115 for callbacks/promises
  - [x] Look for event emitters, progress callbacks, or Promise.allSettled patterns
  - [x] Document findings: Are progress events available from Strudel APIs?
  - [x] Fallback: If no events, proceed with indeterminate animation (AC: 3)

- [x] **Task 5: Implement progress tracking (if events available)** (AC: 2, 5)
  - [x] If Strudel exposes progress events, attach listeners in `src/main.js`
  - [x] Create `updateSplashProgress(percent)` function in `src/main.js`
  - [x] Update `.splash-progress-fill` width: `document.querySelector('.splash-progress-fill').style.width = percent + '%'`
  - [x] Update status text as loading progresses
  - [x] Set progress to 100% when all samples loaded (before dismissal)
  - [x] If no events available, skip this task and use indeterminate animation

- [x] **Task 6: Implement indeterminate progress fallback** (AC: 3)
  - [x] If Task 4 determines no progress events, use indeterminate animation
  - [x] Add `.splash-progress-indeterminate` class to `.splash-progress-bar` on page load
  - [x] Indeterminate animation runs continuously until splash dismisses
  - [x] When samples finish loading, optionally switch to 100% determinate state briefly before dismissal

- [x] **Task 7: Update status text on completion** (AC: 4, 5)
  - [x] When sample loading completes, update status text to "Ready!" or similar
  - [x] Brief delay (e.g., 200ms) to allow user to see completion state
  - [x] Coordinate with Story 3.3 dismissal logic to ensure completion is visible
  - [x] Status text should change before fade-out begins

- [x] **Task 8: Wire progress bar to prebake() function** (AC: 2, 5)
  - [x] Modify `prebake()` in `src/main.js` (lines 98-116)
  - [x] Track completion of each Promise in Promise.all array
  - [x] If progress events available: calculate percentage based on completed promises
  - [x] If not: simply show indeterminate animation, then set to 100% when Promise.all resolves
  - [x] Call progress update function as samples load
  - [x] Mark progress as complete when `prebake()` Promise resolves

## Dev Notes

### Current Sample Loading Implementation
[Source: src/main.js lines 98-116, Epic 3 Technical Notes]

Sample loading in `prebake()` function:
```javascript
async function prebake() {
  const baseCDN = 'https://strudel.b-cdn.net';

  await Promise.all([
    registerSynthSounds(),
    import('@strudel/soundfonts').then(({ registerSoundfonts }) => registerSoundfonts()),
    import('@strudel/webaudio').then(({ samples }) =>
      samples(`${baseCDN}/tidal-drum-machines.json`, `${baseCDN}/tidal-drum-machines/machines/`, {
        prebake: true,
        tag: 'drum-machines',
      })
    ),
    import('@strudel/webaudio').then(({ samples }) =>
      samples('github:tidalcycles/dirt-samples')
    ),
  ]);
}
```

4 concurrent promises:
1. `registerSynthSounds()`
2. `registerSoundfonts()`
3. `samples()` for tidal-drum-machines
4. `samples()` for dirt-samples

Progress calculation (if no events): Track individual promise resolution, update progress bar as each completes (25%, 50%, 75%, 100%).

### HTML Structure Pattern
[Source: Story 3.1, Epic 3 Technical Notes]

Progress bar HTML (add to `.splash-content`):
```html
<div class="splash-progress-container">
  <div class="splash-progress-bar">
    <div class="splash-progress-fill"></div>
  </div>
  <p class="splash-status">Loading samples...</p>
</div>
```

Insert below `.splash-tagline` in splash modal.

### CSS Progress Bar Styling
[Source: architecture/coding-standards.md, Epic 3 Technical Notes]

Progress bar styles:
```css
.splash-progress-container {
  width: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  margin-top: 20px;
}

.splash-progress-bar {
  width: 300px;
  height: 6px;
  background: #333;
  border-radius: 3px;
  overflow: hidden;
  position: relative;
}

.splash-progress-fill {
  height: 100%;
  width: 0%;
  background: linear-gradient(90deg, #4a9eff, #7ec8ff);
  transition: width 0.3s ease;
}

.splash-progress-indeterminate .splash-progress-fill {
  width: 30%;
  animation: shimmer 1.5s infinite;
}

@keyframes shimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(400%); }
}

.splash-status {
  font-size: 0.9rem;
  color: #888;
  margin: 0;
}
```

### Progress Tracking Strategies
[Source: Epic 3 Technical Notes]

**Strategy A: Hook into Strudel Events (Ideal)**
- Research `@strudel/webaudio` API for progress callbacks
- Check if `samples()` returns progress-aware Promises
- Listen for custom events or use callback parameters

**Strategy B: Promise Wrapper (Fallback)**
- Wrap each Promise in `Promise.all` to track individual completion
- Calculate progress: `(completedCount / totalCount) * 100`
- Update progress bar as each promise resolves

**Strategy C: Indeterminate Animation (Simplest)**
- Show animated indeterminate progress bar (shimmer/pulse effect)
- No actual progress tracking, just visual feedback
- Switch to 100% when `prebake()` completes

**Decision:** Start with Strategy C (indeterminate), investigate Strategy A during implementation, use Strategy B if Strategy A not available.

### Progress Update Function
[Source: Epic 3 Technical Notes]

JavaScript function to update progress:
```javascript
function updateSplashProgress(percent) {
  const progressFill = document.querySelector('.splash-progress-fill');
  const progressBar = document.querySelector('.splash-progress-bar');

  // Remove indeterminate animation if present
  progressBar.classList.remove('splash-progress-indeterminate');

  // Update width
  progressFill.style.width = percent + '%';

  // Update status text
  if (percent >= 100) {
    document.querySelector('.splash-status').textContent = 'Ready!';
  }
}
```

Call from `prebake()` wrapper or event listeners.

### Promise Wrapper Pattern (Strategy B)
[Source: Epic 3 Technical Notes]

Example implementation for tracking individual promise completion:
```javascript
async function prebakeWithProgress() {
  const promises = [
    registerSynthSounds(),
    import('@strudel/soundfonts').then(({ registerSoundfonts }) => registerSoundfonts()),
    import('@strudel/webaudio').then(({ samples }) =>
      samples(`${baseCDN}/tidal-drum-machines.json`, `${baseCDN}/tidal-drum-machines/machines/`, {
        prebake: true,
        tag: 'drum-machines',
      })
    ),
    import('@strudel/webaudio').then(({ samples }) =>
      samples('github:tidalcycles/dirt-samples')
    ),
  ];

  let completed = 0;
  const total = promises.length;

  const wrappedPromises = promises.map((p) =>
    p.then((result) => {
      completed++;
      updateSplashProgress((completed / total) * 100);
      return result;
    })
  );

  await Promise.all(wrappedPromises);
}
```

### Indeterminate Animation Pattern (Strategy C)
[Source: Epic 3 Technical Notes]

Simplest approach: CSS animation runs continuously, no JavaScript progress tracking.

On page load:
```javascript
// Add indeterminate class on load
document.querySelector('.splash-progress-bar').classList.add('splash-progress-indeterminate');

// When prebake() completes, switch to 100% briefly before dismissal
await prebake();
document.querySelector('.splash-progress-bar').classList.remove('splash-progress-indeterminate');
updateSplashProgress(100);
document.querySelector('.splash-status').textContent = 'Ready!';
await new Promise(resolve => setTimeout(resolve, 200)); // Brief delay to show completion
// Then Story 3.3 dismisses splash
```

### Integration with Story 3.3 Timing
[Source: Epic 3 Story 3.3, Epic 3 Technical Notes]

Story 3.3 will coordinate dismissal timing:
```javascript
const splashDismissed = Promise.all([
  prebake(), // Sample loading
  new Promise(resolve => setTimeout(resolve, 1200)) // Minimum 1.2s display
]);

await splashDismissed;
updateSplashProgress(100);
document.querySelector('.splash-status').textContent = 'Ready!';
await new Promise(resolve => setTimeout(resolve, 200)); // Show completion
dismissSplash(); // Fade out (Story 3.3)
```

Progress bar should reach 100% before dismissal begins.

### File Locations
[Source: architecture/source-tree.md#Entry Point]

Files to modify:
- **Modify:** `index.html` - Add progress bar HTML, add CSS styles
- **Modify:** `src/main.js` - Wire progress updates to `prebake()` function

## Testing

Manual testing checklist:

- [ ] Progress bar displays below branding in splash modal
- [ ] Progress bar is visible and styled correctly (colors, size, centering)
- [ ] Status text displays "Loading samples..." on initial load
- [ ] Progress bar shows visual activity (indeterminate animation OR percentage increase)
- [ ] Progress reaches 100% before splash dismisses
- [ ] Status text updates to "Ready!" when loading completes
- [ ] Brief completion state is visible before fade-out
- [ ] Progress bar animation is smooth (no jank or stuttering)
- [ ] Test with slow network (throttle in DevTools) to see extended loading
- [ ] Test with fast cache (reload) to ensure completion state still shows briefly

## Change Log

| Date       | Version | Description          | Author |
|------------|---------|----------------------|--------|
| 2025-11-16 | 1.0     | Initial story draft  | Claude |

## Dev Agent Record

### Agent Model Used

claude-sonnet-4-5-20250929

### Debug Log References

None - straightforward implementation with no issues encountered.

### Completion Notes List

- Successfully added progress bar HTML structure to splash modal in index.html
- Implemented comprehensive CSS styling with indeterminate shimmer animation
- Created `updateSplashProgress(percent)` function in src/main.js to track progress
- Modified `prebake()` function to use Promise wrapper pattern (Strategy B)
- Progress tracking: wraps each of 4 promises to update progress bar as they complete (25%, 50%, 75%, 100%)
- Indeterminate animation shows initially, then transitions to determinate progress as promises resolve
- Status text changes from "Loading samples..." to "Ready!" when progress reaches 100%
- Progress bar uses blue gradient (#4a9eff to #7ec8ff) matching UI theme
- Shimmer animation provides visual feedback during initial loading
- Error handling: catches promise rejections and still updates progress to completion
- Implementation uses Strategy B (Promise Wrapper) as Strudel doesn't expose granular progress events

### File List

- Modified: `index.html` (lines 431-470, 444-449) - Added progress bar HTML structure and CSS styling
- Modified: `src/main.js` (lines 86-145) - Added `updateSplashProgress()` function and modified `prebake()` with Promise wrapper

## QA Results

_Results from QA Agent review of the completed story implementation_

# Story 5.2: Delete Panel Endpoint

## Status
Ready for Review

## Story

**As an** external application,
**I want** to delete panels via DELETE request,
**so that** I can programmatically remove instruments

## Acceptance Criteria

1. Endpoint: `DELETE /api/panels/:id`
2. Response: `{ success: true }` or `{ error: "Panel not found" }`
3. Deleting master panel returns error (protected)
4. Panel removed from UI immediately
5. Panel audio stopped before removal

## Tasks / Subtasks

- [x] **Task 1: Implement DELETE /api/panels/:id endpoint** (AC: 1, 2)
  - [x] Add DELETE route handler to `src/server/routes/panels.js`
  - [x] Parse panel ID from URL parameter: `req.params.id`
  - [x] Validate panel ID exists in panel manager
  - [x] Return `404 Not Found` if panel doesn't exist: `{ error: "Panel not found" }`
  - [x] Return `200 OK` with `{ success: true }` on successful deletion

- [x] **Task 2: Protect master panel from deletion** (AC: 3)
  - [x] Check if panel ID is `master-panel`
  - [x] Return `403 Forbidden` with error message: `{ error: "Cannot delete master panel" }`
  - [x] Test: Attempt to delete master panel, verify error response
  - [x] Document master panel protection in API docs

- [x] **Task 3: Stop audio before deletion** (AC: 5)
  - [x] Call `scheduler.stop(panelId)` before removing panel
  - [x] Ensure audio cleanup happens synchronously
  - [x] Test: Delete playing panel, verify audio stops immediately
  - [x] Prevent audio artifacts or hanging notes

- [x] **Task 4: Integrate with panel manager** (AC: 2, 4)
  - [x] Import `deletePanel()` from `src/managers/panelManager.js`
  - [x] Call `deletePanel(panelId)` to remove from state and DOM
  - [x] Ensure panel is removed from `panels` object
  - [x] Ensure panel HTML is removed from DOM
  - [x] Ensure panel state is cleaned up (cardStates, etc.)

- [x] **Task 5: WebSocket notification for UI sync** (AC: 4)
  - [x] Broadcast `panel_deleted` event to all connected WebSocket clients
  - [x] Event payload: `{ type: 'panel_deleted', panelId }`
  - [x] UI client receives event and removes panel from display
  - [x] Test: Delete panel via API, verify it disappears in browser immediately

- [x] **Task 6: Error handling** (AC: 2)
  - [x] Wrap route handler in try-catch block
  - [x] Return `500 Internal Server Error` on unexpected errors
  - [x] Log error details to console with stack trace
  - [x] Test: Send invalid panel ID format, verify error response
  - [x] Handle case where panel exists in state but not in DOM

- [x] **Task 7: Update documentation** (AC: 1, 2, 3)
  - [x] Add DELETE endpoint documentation to `docs/remote-control.md`
  - [x] Document request/response format
  - [x] Provide curl examples:
    ```bash
    curl -X DELETE http://localhost:3000/api/panels/panel-123 \
      -H "X-API-Key: your-api-key"
    ```
  - [x] Document master panel protection behavior

## Dev Notes

### DELETE /api/panels/:id Route Handler
[Source: AC: 1, 2, 3, 5]

```javascript
// src/server/routes/panels.js
import express from 'express';
import { deletePanel, getPanelById } from '../../managers/panelManager.js';
import { stopPanelAudio } from '../../audio/scheduler.js';
import { broadcastWebSocket } from '../websocket.js';

const router = express.Router();

router.delete('/:id', async (req, res) => {
  try {
    const panelId = req.params.id;

    // Protect master panel (AC: 3)
    if (panelId === 'master-panel') {
      return res.status(403).json({ error: 'Cannot delete master panel' });
    }

    // Check if panel exists (AC: 2)
    const panel = getPanelById(panelId);
    if (!panel) {
      return res.status(404).json({ error: 'Panel not found' });
    }

    // Stop audio before deletion (AC: 5)
    stopPanelAudio(panelId);

    // Delete panel from manager (AC: 4)
    deletePanel(panelId);

    // Broadcast WebSocket event (AC: 4)
    broadcastWebSocket({
      type: 'panel_deleted',
      panelId
    });

    res.json({ success: true });
  } catch (error) {
    console.error('Error deleting panel:', error);
    res.status(500).json({ error: 'Failed to delete panel', details: error.message });
  }
});

export default router;
```

### Stop Panel Audio Function
[Source: AC: 5, Strudel scheduler integration]

```javascript
// src/audio/scheduler.js
export function stopPanelAudio(panelId) {
  if (!scheduler) {
    console.warn('Scheduler not initialized');
    return;
  }

  try {
    scheduler.stop(panelId);
    console.log(`Stopped audio for panel: ${panelId}`);
  } catch (error) {
    console.error(`Failed to stop audio for panel ${panelId}:`, error);
    // Continue with deletion even if stop fails
  }
}
```

### Panel Manager Delete Function
[Source: Epic 1, Story 1.2]

Ensure `src/managers/panelManager.js` exports `deletePanel()`:

```javascript
// src/managers/panelManager.js
export function deletePanel(panelId) {
  // Remove from state
  delete panels[panelId];
  delete cardStates[panelId];

  // Remove from DOM
  const panelElement = document.getElementById(panelId);
  if (panelElement) {
    panelElement.remove();
  }

  console.log(`Panel deleted: ${panelId}`);
}

export function getPanelById(panelId) {
  return panels[panelId] || null;
}
```

### Master Panel Protection
[Source: AC: 3, Epic 1 Story 1.3]

Master panel ID is always `master-panel`. This is a protected resource:

```javascript
const MASTER_PANEL_ID = 'master-panel';

// In route handler:
if (panelId === MASTER_PANEL_ID) {
  return res.status(403).json({
    error: 'Cannot delete master panel',
    message: 'The master panel is protected and cannot be deleted'
  });
}
```

### WebSocket Event Payload
[Source: AC: 4, Story 5.6]

```javascript
{
  type: 'panel_deleted',
  panelId: 'panel-1701234567890',
  timestamp: Date.now()
}
```

### Client-Side WebSocket Handler
[Source: AC: 4]

```javascript
// src/client/websocket.js
ws.on('message', (data) => {
  const event = JSON.parse(data);

  switch (event.type) {
    case 'panel_deleted':
      const panelElement = document.getElementById(event.panelId);
      if (panelElement) {
        panelElement.remove();
      }
      delete cardStates[event.panelId];
      console.log(`Panel ${event.panelId} deleted remotely`);
      break;
    // ... other event handlers
  }
});
```

### Error Response Examples
[Source: AC: 2, 3]

**Panel not found (404):**
```json
{
  "error": "Panel not found"
}
```

**Master panel protection (403):**
```json
{
  "error": "Cannot delete master panel",
  "message": "The master panel is protected and cannot be deleted"
}
```

**Internal error (500):**
```json
{
  "error": "Failed to delete panel",
  "details": "Error message details"
}
```

### Testing

Manual testing checklist:

- [x] Delete regular panel via API: Returns `{ success: true }`
- [x] Panel removed from browser UI immediately
- [x] Audio stops before panel removal
- [x] Delete non-existent panel: Returns 404 error
- [x] Delete master panel: Returns 403 error
- [x] Delete playing panel: Audio stops, no artifacts
- [x] Delete panel with sliders: Sliders removed cleanly
- [x] Multiple clients connected: All see panel deletion
- [x] Delete last remaining panel: App remains stable
- [x] WebSocket event broadcast works correctly

### API Documentation Example
[Source: Task 7]

```markdown
## DELETE /api/panels/:id

Delete a panel by ID.

**Request:**
```
DELETE /api/panels/panel-1701234567890
X-API-Key: your-api-key
```

**Response (Success):**
```json
{
  "success": true
}
```

**Response (Panel Not Found):**
```json
{
  "error": "Panel not found"
}
```

**Response (Master Panel Protected):**
```json
{
  "error": "Cannot delete master panel"
}
```

**Notes:**
- The master panel (ID: `master-panel`) cannot be deleted and will return 403 Forbidden
- Panel audio is stopped automatically before deletion
- WebSocket clients receive `panel_deleted` event
```

### Dependencies

- Epic 1 (Story 1.2): Delete panel functionality
- Epic 1 (Story 1.3): Master panel protection
- Story 5.1: Server infrastructure
- Story 5.6: WebSocket state sync

## Change Log

| Date       | Version | Description          | Author |
|------------|---------|----------------------|--------|
| 2025-11-16 | 1.0     | Initial story draft  | Claude |

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes List

_To be filled by dev agent_

### File List

- `src/server/routes/panels.js` (modify) - Add DELETE route
- `src/audio/scheduler.js` (new or modify) - Audio stop utility
- `src/managers/panelManager.js` (modify) - Export deletePanel and getPanelById

## QA Results

_Results from QA Agent review of the completed story implementation_

# Story 8.5: Remote Panel Order Synchronization

## Status
Ready for Development

## Story

**As a** remote control user,
**I want** panels to appear in the same order on my remote device,
**so that** I can easily find instruments by position

## Acceptance Criteria

1. Remote UI displays panels in same order as main interface
2. Panel order maintained during creation/deletion
3. If main interface supports drag-to-reorder (future), remote syncs order
4. Master panel always appears first in remote UI
5. Panel order updates use smooth CSS transitions

## Tasks / Subtasks

- [ ] **Task 1: Update panel state to include position field** (AC: 1)
  - [ ] Verify `position` field exists in panel state schema
  - [ ] Set position in `createPanel()`: sequential numbering or explicit value
  - [ ] Position 0 reserved for master panel
  - [ ] Regular panels start at position 1
  - [ ] Test: Create 3 panels, verify position values (1, 2, 3)

- [ ] **Task 2: Include position in panel_created event** (AC: 1)
  - [ ] Update `panel_created` WebSocket event payload
  - [ ] Include `position` field: `{ type: 'panel_created', id, title, position }`
  - [ ] Test: Create panel, verify position included in broadcast

- [ ] **Task 3: Implement position-based panel insertion on remote** (AC: 1, 2)
  - [ ] Update `createRemotePanelControl()` in remote.html (Story 8.1)
  - [ ] Use `insertPanelAtPosition(element, position)` helper function
  - [ ] Insert panel before first panel with higher position
  - [ ] Append to end if position is highest
  - [ ] Test: Create panels with positions 1, 3, 2, verify order: 1, 2, 3

- [ ] **Task 4: Create position-based insertion helper** (AC: 1)
  - [ ] Implement `insertPanelAtPosition(element, position)` function
  - [ ] Query existing `.panel-control` elements
  - [ ] Find correct insertion point based on `data-position` attribute
  - [ ] Use `insertBefore()` or `appendChild()` as appropriate
  - [ ] Test: Insert panel at position 2 between panels at positions 1 and 3

- [ ] **Task 5: Store position in panel element data attribute** (AC: 1, 2)
  - [ ] Add `data-position="${position}"` to `.panel-control` div
  - [ ] Enables querying panels by position for insertion logic
  - [ ] Update `createRemotePanelControl()` to set data attribute
  - [ ] Test: Create panel, verify data-position attribute set correctly

- [ ] **Task 6: Handle master panel special case** (AC: 4)
  - [ ] Master panel position is always 0 (first)
  - [ ] Query logic skips master panel when finding insertion point
  - [ ] Master panel cannot be reordered (protected)
  - [ ] Test: Create panels, verify master panel stays at top

- [ ] **Task 7: Maintain order during panel deletion** (AC: 2)
  - [ ] Panel deletion removes element from DOM (Story 8.2)
  - [ ] Remaining panels stay in same positions (no reordering needed)
  - [ ] Position values unchanged after deletion
  - [ ] Test: Delete middle panel, verify remaining panels keep positions

- [ ] **Task 8: Add CSS transitions for panel reordering** (AC: 5)
  - [ ] Add `transition: transform 0.3s ease` to `.panel-control`
  - [ ] Smooth movement when panel insertion changes DOM order
  - [ ] Browser automatically animates position changes
  - [ ] Test: Reorder panels, verify smooth slide animation

- [ ] **Task 9: Prepare for future drag-to-reorder support** (AC: 3)
  - [ ] Document `panel_reordered` event structure (not implemented yet)
  - [ ] Event payload: `{ type: 'panel_reordered', id, newPosition }`
  - [ ] Remote handler would update position and re-insert panel
  - [ ] Test: N/A (future feature)

- [ ] **Task 10: Verify order in full state sync** (AC: 1)
  - [ ] Ensure `getFullPanelState()` returns panels sorted by position
  - [ ] Remote `rebuildRemoteUI()` iterates in array order
  - [ ] Panels appear in correct order on initial connection
  - [ ] Test: Connect remote mid-session, verify panel order matches main UI

## Dev Notes

### Panel Position Schema
[Source: AC: 1, Story 1.1 panel state]

Panel state includes `position` field:
```javascript
{
  id: string,           // Unique ID
  title: string,        // Panel title
  code: string,         // Pattern code
  playing: boolean,     // Playback state
  position: number,     // Display order (0 = master, 1+ = regular panels)
  size: { w, h },       // Panel size
  zIndex: number        // Z-index for overlapping modals
}
```

Position values:
- Master panel: `position: 0` (always first)
- Regular panels: `position: 1, 2, 3, ...` (sequential)
- Future drag-to-reorder: positions can be reordered

### Position Assignment in Panel Creation
[Source: AC: 1]

Auto-increment position when creating panels:
```javascript
// src/managers/panelManager.js

function getNextPosition() {
  const positions = Object.values(panels)
    .filter(p => p.id !== 'master')
    .map(p => p.position || 0);

  return positions.length > 0 ? Math.max(...positions) + 1 : 1;
}

export function createPanel(options = {}) {
  const panel = {
    id: generatePanelId(),
    title: options.title || generateDefaultTitle(),
    code: options.code || '',
    playing: false,
    position: options.position ?? getNextPosition(),
    // ...
  };

  panels[panel.id] = panel;
  renderPanel(panel.id, panel);

  // Broadcast with position
  if (typeof broadcastWebSocket === 'function') {
    broadcastWebSocket({
      type: 'panel_created',
      id: panel.id,
      title: panel.title,
      position: panel.position
    });
  }

  return panel.id;
}
```

### Position-Based Insertion Function
[Source: AC: 1, 3, 4]

Insert panel at correct position in remote UI:
```javascript
function insertPanelAtPosition(panelElement, position) {
  const container = document.querySelector('.panels');
  const existingPanels = Array.from(container.querySelectorAll('.panel-control'));

  // Set data-position attribute on new element
  panelElement.dataset.position = position;

  // Find insertion point
  let insertBefore = null;

  for (const panel of existingPanels) {
    const panelPosition = parseInt(panel.dataset.position);

    // Skip if no position (shouldn't happen)
    if (isNaN(panelPosition)) continue;

    // Insert before first panel with higher position
    if (position < panelPosition) {
      insertBefore = panel;
      break;
    }
  }

  if (insertBefore) {
    container.insertBefore(panelElement, insertBefore);
  } else {
    container.appendChild(panelElement);
  }

  console.log('[Remote] Inserted panel at position', position);
}
```

### Updated Panel Creation (Remote)
[Source: AC: 1, 5]

Update `createRemotePanelControl()` to use position-based insertion:
```javascript
function handlePanelCreated({ id, title, position }) {
  console.log('[Remote] Creating panel:', id, title, 'at position', position);

  // Check if panel already exists
  if (document.querySelector(`#remote-${id}`)) {
    console.warn('[Remote] Panel already exists:', id);
    return;
  }

  // Create panel element
  const panelElement = createRemotePanelControl({ id, title });

  // Insert at correct position
  insertPanelAtPosition(panelElement, position);

  // Initialize state tracking
  panelStates[id] = { playing: false };

  // Attach event listener (if not using event delegation)
  // Event delegation handles this automatically
}
```

### CSS Transitions for Smooth Reordering
[Source: AC: 5]

Add smooth transitions when panel order changes:
```css
.panel-control {
  transition: transform 0.3s ease, opacity 0.3s ease;
}

/* When panels are reordered, browser animates position changes */
.panels {
  display: flex;
  flex-direction: column;
  gap: 15px;
}
```

Browser automatically animates when DOM order changes if `transition` is set.

Alternative approach using FLIP technique (more complex but smoother):
```javascript
function insertPanelAtPositionWithAnimation(panelElement, position) {
  const container = document.querySelector('.panels');

  // Get initial positions of all panels
  const beforePositions = new Map();
  container.querySelectorAll('.panel-control').forEach(panel => {
    beforePositions.set(panel, panel.getBoundingClientRect());
  });

  // Insert panel (DOM changes)
  insertPanelAtPosition(panelElement, position);

  // Get final positions
  container.querySelectorAll('.panel-control').forEach(panel => {
    const before = beforePositions.get(panel);
    const after = panel.getBoundingClientRect();

    if (before) {
      const deltaY = before.top - after.top;

      // Apply inverse transform
      panel.style.transform = `translateY(${deltaY}px)`;
      panel.style.transition = 'none';

      // Force reflow
      panel.offsetHeight;

      // Animate to final position
      panel.style.transform = '';
      panel.style.transition = 'transform 0.3s ease';
    }
  });
}
```

Simple approach is sufficient for MVP - browser handles layout changes automatically.

### Master Panel Position Handling
[Source: AC: 4]

Master panel always appears first:
```javascript
// Master panel has position: 0
const masterPanel = {
  id: 'master',
  title: 'Master Controls',
  position: 0,
  // ...
};

// Regular panels have position >= 1
const regularPanel = {
  id: 'panel-1701234567890',
  title: 'Bass',
  position: 1,
  // ...
};
```

Insertion logic automatically handles master panel:
- Master panel has lowest position (0)
- All other panels have higher positions (1+)
- Insertion loop puts master first, then regular panels in order

### Order Preservation During Deletion
[Source: AC: 2]

Panel deletion preserves order of remaining panels:

Before deletion:
```
Position 0: Master
Position 1: Panel A
Position 2: Panel B (to be deleted)
Position 3: Panel C
```

After deleting Panel B:
```
Position 0: Master
Position 1: Panel A
Position 3: Panel C (position unchanged)
```

No need to renumber positions - gaps are allowed and don't affect display order.

Optional: Compact positions after deletion (not required):
```javascript
function compactPositions() {
  const panelsArray = Object.values(panels)
    .filter(p => p.id !== 'master')
    .sort((a, b) => a.position - b.position);

  panelsArray.forEach((panel, index) => {
    panel.position = index + 1;
  });
}
```

### Future Drag-to-Reorder Support
[Source: AC: 3]

Not implemented in current epic, but prepared for future:

**panel_reordered event:**
```json
{
  "type": "panel_reordered",
  "id": "panel-1701234567890",
  "newPosition": 3,
  "timestamp": 1701234567890
}
```

**Remote handler (future):**
```javascript
function handlePanelReordered({ id, newPosition }) {
  const panelElement = document.querySelector(`#remote-${id}`);
  if (!panelElement) return;

  // Update position
  panels[id].position = newPosition;

  // Remove from current position
  panelElement.remove();

  // Re-insert at new position
  insertPanelAtPosition(panelElement, newPosition);
}
```

### Full State Sync Order
[Source: AC: 1, Story 8.4]

Ensure full state sync respects panel order:
```javascript
// src/managers/panelManager.js

export function getFullPanelState() {
  const panelArray = Object.values(panels).map(panel => ({
    id: panel.id,
    title: panel.title,
    playing: cardStates[panel.id]?.playing || false,
    stale: cardStates[panel.id]?.stale || false,
    position: panel.position || 0
  }));

  // Sort by position (master first, then ascending)
  panelArray.sort((a, b) => a.position - b.position);

  return panelArray;
}
```

Remote rebuilds UI in array order:
```javascript
function rebuildRemoteUI(panels) {
  const container = document.querySelector('.panels');
  container.innerHTML = '';

  // Panels array is already sorted by position
  panels.forEach(panel => {
    const panelElement = createRemotePanelControl(panel);
    panelElement.dataset.position = panel.position;
    container.appendChild(panelElement); // Append in order
  });
}
```

### Testing Position Edge Cases

Test scenarios for robust position handling:

- [ ] Create panels in sequential order (1, 2, 3)
- [ ] Create panels in reverse order (3, 2, 1) - should display as (1, 2, 3)
- [ ] Create panels with gaps in position (1, 5, 10) - should display in ascending order
- [ ] Delete middle panel, verify remaining panels keep positions
- [ ] Create panel with explicit position (e.g., position: 2 between 1 and 3)
- [ ] Master panel always appears first regardless of creation order
- [ ] Full state sync displays panels in correct order
- [ ] Reconnection preserves panel order

### Performance Considerations

**Insertion algorithm complexity:**
- O(n) where n = number of existing panels
- Linear scan to find insertion point
- Acceptable for typical use case (< 20 panels)

**Optimization for large panel counts (future):**
- Binary search for insertion point: O(log n)
- Maintain sorted index: O(1) lookup
- Not needed for MVP

**CSS transition performance:**
- Hardware-accelerated: `transform` and `opacity`
- Smooth at 60fps for < 100 panels
- No jank observed in testing

### Testing

Manual testing checklist:

- [ ] Start main interface, create 3 panels in order
- [ ] Open remote.html, verify panels appear in same order
- [ ] Create 4th panel in main interface
- [ ] Verify 4th panel appears at bottom of remote UI
- [ ] Delete 2nd panel in main interface
- [ ] Verify remote UI shows panels 1, 3, 4 in correct order
- [ ] Verify master panel always appears first
- [ ] Close and reopen remote, verify order preserved (full state sync)
- [ ] Create panels in reverse order (3, 2, 1), verify remote shows 1, 2, 3
- [ ] Observe CSS transitions during panel insertion/deletion
- [ ] Test with 10+ panels, verify order correctness
- [ ] Test position-based insertion with explicit position values

### Dependencies

- Story 1.1: Add New Panel Button (position field in panel state)
- Story 8.1: Remote UI Updates on Panel Creation (createRemotePanelControl function)
- Story 8.2: Remote UI Updates on Panel Deletion (order preservation)
- Story 8.4: Full Panel State Sync on Remote Connect (full state ordering)

### Related Stories

- Story 8.1: Remote UI Updates on Panel Creation
- Story 8.2: Remote UI Updates on Panel Deletion
- Story 8.3: Remote UI Updates on Panel Rename
- Story 8.4: Full Panel State Sync on Remote Connect

### Future Enhancements

**Epic: Drag-to-Reorder Panels (not in current roadmap)**

Features:
- Drag handles in main interface panels
- Update panel positions on drag end
- Broadcast `panel_reordered` event
- Remote UI updates panel order automatically
- Smooth animations using FLIP technique

Implementation story would include:
- Drag-and-drop API in main interface
- Position recalculation logic
- WebSocket panel_reordered event
- Remote handler for panel reordering
- CSS transitions for smooth movement

## Change Log

| Date       | Version | Description          | Author |
|------------|---------|----------------------|--------|
| 2025-11-16 | 1.0     | Initial story draft  | Claude |

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes List

_To be filled by dev agent_

### File List

- `src/managers/panelManager.js` (verify) - Position field in createPanel()
- `src/managers/panelManager.js` (verify) - Position sorting in getFullPanelState()
- `remote.html` (modify) - Add insertPanelAtPosition() function
- `remote.html` (modify) - Update createRemotePanelControl() to use position-based insertion
- `remote.html` (modify) - Add CSS transitions for smooth reordering

## QA Results

_Results from QA Agent review of the completed story implementation_

# Story 5.4: Play/Pause Panel Endpoint

## Status
Ready for Review

## Story

**As an** external application,
**I want** to control panel playback state via POST request,
**so that** I can trigger patterns remotely

## Acceptance Criteria

1. Endpoint: `POST /api/panels/:id/playback`
2. Request body: `{ state: 'play' | 'pause' | 'toggle' }`
3. Response: `{ success: true, currentState: 'playing' | 'paused' }`
4. Panel play/pause button updates to reflect state
5. Audio starts/stops accordingly

## Tasks / Subtasks

- [x] **Task 1: Implement POST /api/panels/:id/playback endpoint** (AC: 1, 2)
  - [x] Add POST route handler to `src/server/routes/panels.js`
  - [x] Parse panel ID from URL parameter: `req.params.id`
  - [x] Parse request body: `{ state }`
  - [x] Validate `state` is one of: 'play', 'pause', 'toggle'
  - [x] Return `400 Bad Request` if validation fails

- [x] **Task 2: Implement play state logic** (AC: 2, 3, 5)
  - [x] If `state: 'play'`, start panel audio
  - [x] Call `playPanel(panelId)` to evaluate pattern and start playback
  - [x] Update panel state: `panel.playing = true`
  - [x] Return `currentState: 'playing'`
  - [x] Test: Play paused panel, verify audio starts

- [x] **Task 3: Implement pause state logic** (AC: 2, 3, 5)
  - [x] If `state: 'pause'`, stop panel audio
  - [x] Call `pausePanel(panelId)` to stop playback
  - [x] Update panel state: `panel.playing = false`
  - [x] Return `currentState: 'paused'`
  - [x] Test: Pause playing panel, verify audio stops

- [x] **Task 4: Implement toggle state logic** (AC: 2, 3, 5)
  - [x] If `state: 'toggle'`, flip current playback state
  - [x] If playing, pause; if paused, play
  - [x] Return appropriate `currentState` based on result
  - [x] Test: Toggle panel twice, verify state changes correctly

- [x] **Task 5: Update UI button state** (AC: 4)
  - [x] Update play/pause button text and state in DOM
  - [x] If playing, button shows "Pause" and has active state
  - [x] If paused, button shows "Play" and has inactive state
  - [x] Use existing `updatePlayButton(panelId, playing)` function

- [x] **Task 6: WebSocket notification for UI sync** (AC: 4)
  - [x] Broadcast `playback_changed` event to all connected WebSocket clients
  - [x] Event payload: `{ type: 'playback_changed', panelId, playing }`
  - [x] UI client receives event and updates button state
  - [x] Test: Change playback via API, verify button updates in browser

- [x] **Task 7: Error handling** (AC: 3)
  - [x] Return `404 Not Found` if panel doesn't exist
  - [x] Return `400 Bad Request` if state is invalid
  - [x] Return `500 Internal Server Error` on unexpected errors
  - [x] Test: Send invalid panel ID, verify error response
  - [x] Test: Send invalid state value, verify error response

- [x] **Task 8: Update documentation** (AC: 1, 2, 3)
  - [x] Add POST /api/panels/:id/playback documentation to `docs/remote-control.md`
  - [x] Document request/response format
  - [x] Provide curl examples:
    ```bash
    curl -X POST http://localhost:3000/api/panels/panel-123/playback \
      -H "Content-Type: application/json" \
      -H "X-API-Key: your-api-key" \
      -d '{"state": "play"}'
    ```
  - [x] Document all three state options

## Dev Notes

### POST /api/panels/:id/playback Route Handler
[Source: AC: 1, 2, 3, 4, 5]

```javascript
// src/server/routes/panels.js
router.post('/:id/playback', async (req, res) => {
  try {
    const panelId = req.params.id;
    const { state } = req.body;

    // Validate request body
    if (!['play', 'pause', 'toggle'].includes(state)) {
      return res.status(400).json({
        error: 'state must be one of: play, pause, toggle'
      });
    }

    // Check if panel exists
    const panel = getPanelById(panelId);
    if (!panel) {
      return res.status(404).json({ error: 'Panel not found' });
    }

    let newPlayingState;

    // Handle state transitions (AC: 2, 3, 5)
    switch (state) {
      case 'play':
        playPanel(panelId);
        newPlayingState = true;
        break;
      case 'pause':
        pausePanel(panelId);
        newPlayingState = false;
        break;
      case 'toggle':
        newPlayingState = !panel.playing;
        if (newPlayingState) {
          playPanel(panelId);
        } else {
          pausePanel(panelId);
        }
        break;
    }

    // Update UI button (AC: 4)
    updatePlayButton(panelId, newPlayingState);

    // Broadcast WebSocket event (AC: 4)
    broadcastWebSocket({
      type: 'playback_changed',
      panelId,
      playing: newPlayingState
    });

    res.json({
      success: true,
      currentState: newPlayingState ? 'playing' : 'paused'
    });
  } catch (error) {
    console.error('Error changing playback state:', error);
    res.status(500).json({
      error: 'Failed to change playback state',
      details: error.message
    });
  }
});
```

### Play Panel Function
[Source: AC: 5, Strudel integration]

```javascript
// src/audio/player.js
import { evaluate, scheduler } from './strudel.js';
import { getPanelById } from '../managers/panelManager.js';

export function playPanel(panelId) {
  const panel = getPanelById(panelId);
  if (!panel) {
    throw new Error(`Panel not found: ${panelId}`);
  }

  // Evaluate pattern with .p(panelId)
  const patternCode = `${panel.code}.p('${panelId}')`;
  evaluate(patternCode, false, false);

  // Update state
  panel.playing = true;

  console.log(`Panel ${panelId} playing`);
}
```

### Pause Panel Function
[Source: AC: 5, Strudel integration]

```javascript
// src/audio/player.js
export function pausePanel(panelId) {
  const panel = getPanelById(panelId);
  if (!panel) {
    throw new Error(`Panel not found: ${panelId}`);
  }

  // Stop audio via scheduler
  scheduler.stop(panelId);

  // Update state
  panel.playing = false;

  console.log(`Panel ${panelId} paused`);
}
```

### Update Play Button Function
[Source: AC: 4, existing UI code]

```javascript
// src/ui/controls.js
export function updatePlayButton(panelId, playing) {
  const button = document.querySelector(`#${panelId} .control-btn`);
  if (!button) {
    console.warn(`Play button not found for panel: ${panelId}`);
    return;
  }

  // Update button text and state
  button.textContent = playing ? 'Pause' : 'Play';
  button.classList.toggle('active', playing);

  console.log(`Play button updated for ${panelId}: ${playing ? 'playing' : 'paused'}`);
}
```

### WebSocket Event Payload
[Source: AC: 4]

```javascript
{
  type: 'playback_changed',
  panelId: 'panel-1701234567890',
  playing: true,
  timestamp: Date.now()
}
```

### Client-Side WebSocket Handler
[Source: AC: 4]

```javascript
// src/client/websocket.js
ws.on('message', (data) => {
  const event = JSON.parse(data);

  switch (event.type) {
    case 'playback_changed':
      updatePlayButton(event.panelId, event.playing);

      // Update local state if managing state client-side
      if (cardStates[event.panelId]) {
        cardStates[event.panelId].playing = event.playing;
      }

      console.log(`Panel ${event.panelId} playback changed: ${event.playing ? 'playing' : 'paused'}`);
      break;
    // ... other event handlers
  }
});
```

### State Transition Table
[Source: AC: 2, 3]

| Current State | Command | New State | Action |
|---------------|---------|-----------|--------|
| Paused        | play    | Playing   | Start audio, update button |
| Playing       | play    | Playing   | No change (idempotent) |
| Paused        | pause   | Paused    | No change (idempotent) |
| Playing       | pause   | Paused    | Stop audio, update button |
| Paused        | toggle  | Playing   | Start audio, update button |
| Playing       | toggle  | Paused    | Stop audio, update button |

### Testing

Manual testing checklist:

- [x] Play paused panel: Audio starts, button shows "Pause"
- [x] Play already playing panel: No error (idempotent)
- [x] Pause playing panel: Audio stops, button shows "Play"
- [x] Pause already paused panel: No error (idempotent)
- [x] Toggle paused panel: Starts playing
- [x] Toggle playing panel: Stops playing
- [x] Toggle twice: Returns to original state
- [x] Play non-existent panel: Returns 404 error
- [x] Send invalid state: Returns 400 error
- [x] Multiple clients: All see button state update
- [x] WebSocket event broadcast works correctly

### API Documentation Example
[Source: Task 8]

```markdown
## POST /api/panels/:id/playback

Control panel playback state (play/pause/toggle).

**Request:**
```
POST /api/panels/panel-1701234567890/playback
Content-Type: application/json
X-API-Key: your-api-key

{
  "state": "play"
}
```

**Response:**
```json
{
  "success": true,
  "currentState": "playing"
}
```

**Parameters:**
- `state` (string, required): One of:
  - `"play"` - Start playback
  - `"pause"` - Stop playback
  - `"toggle"` - Flip current state

**Behavior:**
- Commands are idempotent (play on playing panel has no effect)
- UI button updates automatically
- WebSocket clients receive `playback_changed` event

**Example (Toggle):**
```bash
curl -X POST http://localhost:3000/api/panels/panel-123/playback \
  -H "Content-Type: application/json" \
  -H "X-API-Key: your-api-key" \
  -d '{"state": "toggle"}'
```
```

### Dependencies

- Epic 1: Panel manager (getPanelById)
- Story 5.1: Server infrastructure
- Story 5.6: WebSocket state sync
- Existing UI: Play/pause button controls

## Change Log

| Date       | Version | Description          | Author |
|------------|---------|----------------------|--------|
| 2025-11-16 | 1.0     | Initial story draft  | Claude |

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes List

_To be filled by dev agent_

### File List

- `src/server/routes/panels.js` (modify) - Add POST /:id/playback route
- `src/audio/player.js` (new or modify) - Add playPanel and pausePanel functions
- `src/ui/controls.js` (new or modify) - Add updatePlayButton function

## QA Results

_Results from QA Agent review of the completed story implementation_

# Story 2.3: Draggable Modal Panels

## Status
Ready for Review

## Story

**As a** live coder,
**I want** to drag panels by their headers to reposition them,
**so that** I can organize my workspace layout

## Acceptance Criteria

1. Panels use `position: absolute` or similar for free positioning
2. Dragging panel header moves panel to new position
3. Panels can be moved anywhere within viewport (or defined container)
4. Dragging a panel brings it to front (z-index management)
5. Panel position is saved in panel state
6. Panels do not drift outside visible area (boundary constraints)

## Tasks / Subtasks

- [x] **Task 1: Ensure absolute positioning is implemented** (AC: 1)
  - [x] Verify `.card` CSS has `position: absolute` (from Story 2.2)
  - [x] Set default positions for initial panels (staggered layout)
  - [x] Ensure panels have explicit `left`, `top`, `width`, `height` values

- [x] **Task 2: Initialize interact.js drag functionality** (AC: 2, 3)
  - [x] Create `initializeDraggable(panelElement)` function in `src/ui/dragResize.js`
  - [x] Configure interact.js draggable with allowFrom and ignoreFrom
  - [x] Call `initializeDraggable()` for each panel (via `initializeDragAndResize()`)

- [x] **Task 3: Implement drag event handler** (AC: 2, 5)
  - [x] Attach `dragmove` event listener to panels
  - [x] Update panel element position using transform
  - [x] Update panel state via `updatePanel(panelId, { position: { x, y } })`
  - [x] Position saved immediately on each move

- [x] **Task 4: Update panel state schema to store position** (AC: 5)
  - [x] Panel state includes `position: { x, y }` property (from Story 2.2)
  - [x] Default position in `createPanel()` with staggered offset
  - [x] Position updates via existing `updatePanel()` function
  - [x] localStorage persistence deferred to Epic 4

- [x] **Task 5: Implement bring-to-front on drag start** (AC: 4)
  - [x] Attach `dragstart` event listener to panels
  - [x] On drag start, find max z-index and set panel to maxZIndex + 1
  - [x] Update panel state z-index via `updatePanel()`
  - [x] Dragging panel has highest z-index among all panels

- [x] **Task 6: Restrict drag to viewport boundaries** (AC: 3, 6)
  - [x] Use interact.js `restrictRect` modifier (restriction: 'parent')
  - [x] Panels stay within container bounds
  - [x] endOnly: true allows smooth dragging with boundary snap on release

- [x] **Task 7: Style header as drag handle** (AC: 2)
  - [x] Add `cursor: grab` to `.card-header` to indicate draggability
  - [x] Add `cursor: grabbing` on `:active` state
  - [x] Add `user-select: none` to prevent text selection during drag
  - [x] Panel title uses `cursor: text !important` to override header cursor

- [x] **Task 8: Handle edge cases and conflicts** (AC: 2, 6)
  - [x] Prevent drag during title editing via `ignoreFrom: '.panel-title'`
  - [x] Ensure play/delete button clicks don't trigger drag via `ignoreFrom`
  - [x] Drag and resize work together via separate interact.js configurations
  - [x] Boundary constraints prevent panels from leaving visible area

## Dev Notes

### Panel State Schema
[Source: architecture/coding-standards.md#Code Structure, Epic 2 Technical Notes]

Panel state schema includes position property:
```javascript
{
  id: string,
  title: string,
  code: string,
  playing: boolean,
  position: { x: number, y: number },  // This story
  size: { w: number, h: number },      // Story 2.2
  zIndex: number                       // Story 2.4
}
```

Default position: Stagger based on panel count to avoid overlap.

### interact.js Drag Configuration
[Source: Epic 2 Technical Notes, interact.js docs]

Drag setup with header restriction:
```javascript
import interact from 'interactjs';

function initializeDraggable(panelElement) {
  interact(panelElement)
    .draggable({
      allowFrom: '.card-header',  // Only header is draggable
      ignoreFrom: '.panel-title, .control-btn',  // Ignore title and buttons
      modifiers: [
        interact.modifiers.restrictRect({
          restriction: 'parent',  // Stay within parent container
          endOnly: true           // Only check at end of drag
        })
      ],
      listeners: {
        start(event) {
          // Bring panel to front (Story 2.4)
          const panelId = event.target.id;
          bringPanelToFront(panelId);
          event.target.style.cursor = 'grabbing';
        },
        move(event) {
          const target = event.target;
          const x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
          const y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;

          // Update element position
          target.style.transform = `translate(${x}px, ${y}px)`;
          target.setAttribute('data-x', x);
          target.setAttribute('data-y', y);

          // Update panel state
          const panelId = target.id;
          updatePanelPosition(panelId, { x, y });
        },
        end(event) {
          event.target.style.cursor = '';
        }
      }
    });
}
```

Alternative approach using `left`/`top` instead of `transform`:
```javascript
move(event) {
  const target = event.target;
  const left = (parseFloat(target.style.left) || 0) + event.dx;
  const top = (parseFloat(target.style.top) || 0) + event.dy;

  target.style.left = `${left}px`;
  target.style.top = `${top}px`;

  updatePanelPosition(panelId, { x: left, y: top });
}
```

**Recommendation:** Use `transform` for performance (GPU acceleration), store absolute position in state.

### CSS Cursor Styles
[Source: architecture/coding-standards.md#Code Structure]

Add drag cursor to header:
```css
.card-header {
  cursor: move; /* Or cursor: grab */
  user-select: none; /* Prevent text selection during drag */
}

.card-header:active {
  cursor: grabbing;
}
```

### Viewport Boundary Constraints
[Source: Epic 2 Technical Notes, AC: 6]

Prevent panels from completely leaving viewport:

**Option A:** interact.js `restrictRect` modifier:
```javascript
interact.modifiers.restrictRect({
  restriction: 'parent',  // Restrict to body or container
  endOnly: true           // Allow off-screen during drag, snap back on release
})
```

**Option B:** Custom boundary check:
```javascript
move(event) {
  const viewport = {
    width: window.innerWidth,
    height: window.innerHeight
  };
  const minVisible = 50; // Minimum pixels that must remain visible

  let x = (parseFloat(target.style.left) || 0) + event.dx;
  let y = (parseFloat(target.style.top) || 0) + event.dy;

  // Constrain x
  x = Math.max(-target.offsetWidth + minVisible, x);
  x = Math.min(viewport.width - minVisible, x);

  // Constrain y
  y = Math.max(0, y); // Never go above viewport
  y = Math.min(viewport.height - minVisible, y);

  target.style.left = `${x}px`;
  target.style.top = `${y}px`;
}
```

**Recommendation:** Use interact.js modifier for simplicity, add custom constraints if needed.

### Default Panel Positions
[Source: architecture/source-tree.md#Entry Point]

Stagger initial panel positions to avoid overlap:
```javascript
function calculateDefaultPosition(panelIndex, panelCount) {
  const offsetX = 20;
  const offsetY = 100;
  const spacing = 420; // Panel width + gap

  const col = panelIndex % 2;
  const row = Math.floor(panelIndex / 2);

  return {
    x: offsetX + (col * spacing),
    y: offsetY + (row * 320) // Panel height + gap
  };
}
```

### Conflict with Title Editing
[Source: Story 2.1, AC: 2]

Prevent drag when title is being edited:
```javascript
interact('.card').draggable({
  allowFrom: '.card-header',
  ignoreFrom: '.panel-title[contenteditable="true"]:focus, .control-btn'
});
```

This prevents dragging when:
- Title is focused (editing mode)
- Play button is clicked

### Bring to Front Integration
[Source: Story 2.4, AC: 4]

On drag start, call `bringPanelToFront(panelId)` to update z-index. This ensures dragged panel appears on top of other panels.

```javascript
start(event) {
  const panelId = event.target.id;
  bringPanelToFront(panelId); // Implemented in Story 2.4
}
```

### Position State Persistence
[Source: Epic 2 Technical Notes, Epic 4 dependencies]

Position updates should be debounced to avoid excessive writes:
```javascript
let positionUpdateTimeout;
function updatePanelPosition(panelId, position) {
  clearTimeout(positionUpdateTimeout);
  positionUpdateTimeout = setTimeout(() => {
    panels[panelId].position = position;
    // Save to localStorage if Epic 4 enabled
  }, 200); // Debounce 200ms
}
```

### Transform vs Left/Top Performance
[Source: Web performance best practices]

**Transform (GPU-accelerated):**
- Pros: Smoother animation, no layout reflow
- Cons: Requires `data-x`/`data-y` attributes for position tracking

**Left/Top (Layout-based):**
- Pros: Simpler, position directly in CSS
- Cons: Triggers layout reflow, slower for frequent updates

**Recommendation:** Use `transform` for drag performance, convert to `left`/`top` on drag end for persistence.

### File Locations
[Source: architecture/source-tree.md#Future Modular Architecture]

Files to modify:
- **Modify:** `src/ui/dragResize.js` - Add `initializeDraggable()` function
- **Modify:** `src/managers/panelManager.js` - Add `updatePanelPosition()` function
- **Modify:** `src/ui/panelRenderer.js` - Call `initializeDraggable()` after panel creation
- **Modify:** `index.html` - Add CSS styles for drag cursor and header styling

## Testing

Manual testing checklist:

- [x] Dragging panel header moves panel
- [x] Panel follows mouse cursor smoothly during drag
- [x] Releasing mouse button stops drag and saves position
- [x] Panel cannot be dragged outside viewport (header remains visible)
- [x] Dragging panel brings it to front (z-index increases)
- [x] Panel position is saved in panel state object
- [x] Clicking play button does not trigger drag
- [x] Editing title (Story 2.1) does not trigger drag
- [x] Resize handles (Story 2.2) do not interfere with drag
- [x] Drag works for both statically created and dynamically created panels
- [x] Multiple panels can be dragged independently without interference

**Testing Status:** âœ… All manual tests passed. Verified by user.

**Note:** Click-to-front behavior (clicking panel to bring to front) is deferred to Story 2.4 (Panel Layering). Story 2.3 only requires bring-to-front on drag start, which is working correctly.

## Change Log

| Date       | Version | Description          | Author |
|------------|---------|----------------------|--------|
| 2025-11-16 | 1.0     | Initial story draft  | Claude |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Implementation Summary

Most drag functionality was already implemented in Story 2.2 as a bonus feature. Story 2.3 focused on enhancements and refinements:

**Key Changes:**
1. Enhanced `initializeDraggable()` in `src/ui/dragResize.js`:
   - Added `allowFrom: '.card-header'` to restrict drag initiation to header only
   - Added `ignoreFrom: '.panel-title, .control-btn, .delete-btn'` to prevent conflicts
   - Implemented `start` listener for bring-to-front functionality
   - Basic z-index management: finds max z-index and sets dragged panel to maxZIndex + 1

2. Updated CSS in `index.html`:
   - Added `cursor: grab` to `.card-header` for visual feedback
   - Added `cursor: grabbing` on `:active` state
   - Added `user-select: none` to prevent text selection during drag
   - Added `cursor: text !important` to `.panel-title` to override header cursor

**Implementation Notes:**
- Transform-based positioning (already from Story 2.2) provides GPU-accelerated smooth dragging
- Position state updates happen immediately on each move event
- Boundary constraints via interact.js `restrictRect` modifier prevent panels from leaving parent
- Z-index management is basic but functional (Story 2.4 will provide comprehensive solution)
- No conflicts with resize (Story 2.2) or title editing (Story 2.1) features

### Debug Log References
None - straightforward enhancement of existing functionality.

### Completion Notes

All acceptance criteria met:
- [x] AC1: Panels use absolute positioning (from Story 2.2)
- [x] AC2: Dragging panel header moves panel
- [x] AC3: Panels can be moved anywhere within viewport
- [x] AC4: Dragging brings panel to front (basic z-index++)
- [x] AC5: Panel position saved in panel state
- [x] AC6: Panels do not drift outside visible area (restrictRect)

**UX Enhancements:**
- Cursor feedback (grab/grabbing) provides clear affordance
- Header-only drag prevents accidental movement during text editing
- Buttons and title properly ignored for drag initiation
- Smooth transform-based movement with boundary snap on release

### File List

Modified:
- `src/ui/dragResize.js` - Enhanced initializeDraggable() with allowFrom, ignoreFrom, and bring-to-front
- `index.html` - Added cursor styling for draggable header and title override

## QA Results

_Results from QA Agent review of the completed story implementation_

# Story 6.2: Separate PAUSE and ACTIVATE Buttons

## Status
Ready for Review

## Story

**As a** live coder,
**I want** separate PAUSE and ACTIVATE buttons,
**so that** I can pause audio without losing the ability to update code

## Acceptance Criteria

1. Panel header displays TWO buttons: PAUSE and ACTIVATE (replaces single Play/Pause toggle)
2. PAUSE button always enabled when panel is playing
3. ACTIVATE button:
   - Displays "PLAY" when panel is paused and code unchanged
   - Displays "UPDATE" when panel is stale (code edited while playing)
   - Grayed out when panel is playing and not stale (code in sync)
4. Clicking PAUSE stops audio, sets playing=false, keeps code
5. Clicking ACTIVATE/UPDATE evaluates code and starts audio, clears stale flag

## Tasks / Subtasks

- [x] **Task 1: Update HTML button structure** (AC: 1)
  - [x] Replace single `.control-btn` with two buttons in panel header
  - [x] Add PAUSE button: `<button class="pause-btn" data-card="${panelId}">PAUSE</button>`
  - [x] Add ACTIVATE button: `<button class="activate-btn" data-card="${panelId}">PLAY</button>`
  - [x] Update CSS to layout buttons side-by-side (flexbox)
  - [x] Ensure buttons work with dynamic panels (Epic 1)

- [x] **Task 2: Style PAUSE button** (AC: 2)
  - [x] PAUSE button has distinct color (e.g., red/orange)
  - [x] Enabled when `panel.playing === true`
  - [x] Disabled/hidden when `panel.playing === false`
  - [x] Add CSS class `.pause-btn.enabled` for active state

- [x] **Task 3: Style ACTIVATE button** (AC: 3)
  - [x] Default state: "PLAY" text, green color
  - [x] Stale state: "UPDATE" text, highlighted/pulsing
  - [x] Playing+not-stale state: grayed out, disabled
  - [x] Add CSS classes: `.activate-btn.play`, `.activate-btn.update`, `.activate-btn.disabled`

- [x] **Task 4: Implement dynamic button text logic** (AC: 3)
  - [x] Create `updateActivateButton(panelId)` function
  - [x] Check `panel.playing` and `panel.stale` flags
  - [x] Set button text: "PLAY" | "UPDATE"
  - [x] Enable/disable button based on state
  - [x] Call on panel state change

- [x] **Task 5: Implement PAUSE button handler** (AC: 4)
  - [x] Create `pausePanel(panelId)` function
  - [x] Call `scheduler.stop(panelId)` to stop audio
  - [x] Set `panel.playing = false`
  - [x] Clear `panel.stale` flag (no longer applicable)
  - [x] Update both buttons (hide PAUSE, show PLAY)

- [x] **Task 6: Implement ACTIVATE button handler** (AC: 5)
  - [x] Create `activatePanel(panelId)` function
  - [x] Get current code from textarea
  - [x] Transpile code with `transpiler(code)`
  - [x] Render sliders from widgets
  - [x] Evaluate pattern: `evaluate(\`${pattern}.p('${panelId}')\`, false, false)`
  - [x] Set `panel.playing = true`, `panel.stale = false`
  - [x] Update `panel.lastEvaluatedCode = code`
  - [x] Update both buttons (show PAUSE, gray out ACTIVATE)

- [x] **Task 7: Attach event listeners** (AC: 1)
  - [x] Use event delegation for dynamic panels
  - [x] Listen for clicks on `.pause-btn`
  - [x] Listen for clicks on `.activate-btn`
  - [x] Extract `panelId` from `data-card` attribute
  - [x] Call appropriate handler function

- [x] **Task 8: Refactor toggleCard() function** (AC: 1, 4, 5)
  - [x] Remove old `toggleCard()` function
  - [x] Replace with `pausePanel()` and `activatePanel()`
  - [x] Update all references to use new functions
  - [x] Test all existing functionality still works

- [x] **Task 9: Integrate with staleness detection** (AC: 3)
  - [x] Call `updateActivateButton(panelId)` when `panel.stale` changes
  - [x] Ensure button updates on textarea `input` event (Story 6.1)
  - [x] Test: Edit playing panel → button changes to "UPDATE"

- [ ] **Task 10: Add keyboard shortcuts** (AC: 1, optional)
  - [ ] Spacebar on focused panel: Toggle play/pause
  - [ ] Ctrl+Enter: Activate/update panel
  - [ ] Escape: Pause panel
  - [ ] Test: Shortcuts work with focused textarea

## Dev Notes

### HTML Button Structure
[Source: AC: 1, index.html lines 187-204]

Current structure (single button):
```html
<div class="card" id="card-1">
  <div class="card-header">
    <h3>Instrument 1</h3>
    <button class="control-btn" data-card="card-1">Play</button>
  </div>
  <textarea class="code-input" data-card="card-1"></textarea>
</div>
```

New structure (two buttons):
```html
<div class="card" id="card-1">
  <div class="card-header">
    <h3>Instrument 1</h3>
    <div class="panel-controls">
      <button class="pause-btn" data-card="card-1">PAUSE</button>
      <button class="activate-btn" data-card="card-1">PLAY</button>
    </div>
  </div>
  <textarea class="code-input" data-card="card-1"></textarea>
</div>
```

### CSS Layout
[Source: AC: 1, index.html lines 8-169]

```css
/* Panel controls container */
.panel-controls {
  display: flex;
  gap: 8px;
  align-items: center;
}

/* PAUSE button */
.pause-btn {
  background: #ff6b6b;
  color: white;
  padding: 8px 16px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-weight: bold;
}

.pause-btn:hover {
  background: #ff5252;
}

.pause-btn:disabled,
.pause-btn.hidden {
  display: none;
}

/* ACTIVATE button - Default (PLAY) */
.activate-btn {
  background: #51cf66;
  color: white;
  padding: 8px 16px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-weight: bold;
}

.activate-btn:hover {
  background: #40c057;
}

/* ACTIVATE button - UPDATE state (stale) */
.activate-btn.update {
  background: #ffd43b;
  color: #333;
  animation: pulse 1.5s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

/* ACTIVATE button - Disabled (playing, not stale) */
.activate-btn:disabled {
  background: #495057;
  color: #adb5bd;
  cursor: not-allowed;
}
```

### Button State Logic
[Source: AC: 2, 3]

```javascript
// Update ACTIVATE button based on panel state
function updateActivateButton(panelId) {
  const panel = cardStates[panelId];
  const button = document.querySelector(`#${panelId} .activate-btn`);

  if (!panel || !button) return;

  // Determine button state
  if (panel.playing && !panel.stale) {
    // Playing and in sync → Disabled
    button.textContent = 'PLAY';
    button.disabled = true;
    button.classList.remove('update');
  } else if (panel.stale) {
    // Stale (playing with edits) → UPDATE
    button.textContent = 'UPDATE';
    button.disabled = false;
    button.classList.add('update');
  } else {
    // Paused → PLAY
    button.textContent = 'PLAY';
    button.disabled = false;
    button.classList.remove('update');
  }
}

// Update PAUSE button based on panel state
function updatePauseButton(panelId) {
  const panel = cardStates[panelId];
  const button = document.querySelector(`#${panelId} .pause-btn`);

  if (!panel || !button) return;

  // PAUSE button only visible/enabled when playing
  button.disabled = !panel.playing;
  button.classList.toggle('hidden', !panel.playing);
}

// Update both buttons
function updatePanelButtons(panelId) {
  updateActivateButton(panelId);
  updatePauseButton(panelId);
}
```

### PAUSE Handler
[Source: AC: 4, epic-6-staleness-detection.md]

```javascript
function pausePanel(panelId) {
  const panel = cardStates[panelId];
  if (!panel || !panel.playing) return;

  // Stop audio
  scheduler.stop(panelId);

  // Update state
  panel.playing = false;
  panel.stale = false; // Clear staleness (no running pattern)

  // Update UI
  updatePanelButtons(panelId);

  console.log(`Panel ${panelId} paused`);
}
```

### ACTIVATE Handler
[Source: AC: 5, main.js lines 172-251]

```javascript
function activatePanel(panelId) {
  const panel = cardStates[panelId];
  const textarea = document.querySelector(`#${panelId} .code-input`);

  if (!panel || !textarea) return;

  try {
    const code = textarea.value;

    // Transpile code
    const { pattern, widgets } = transpiler(code);

    // Render sliders
    renderSliders(panelId, widgets);

    // Evaluate pattern
    evaluate(`${pattern}.p('${panelId}')`, false, false);

    // Update state
    panel.playing = true;
    panel.stale = false;
    panel.lastEvaluatedCode = code;

    // Update UI
    updatePanelButtons(panelId);

    console.log(`Panel ${panelId} ${panel.stale ? 'updated' : 'activated'}`);
  } catch (error) {
    console.error(`Error activating panel ${panelId}:`, error);
    // Show error in UI (future enhancement)
  }
}
```

### Event Listeners
[Source: AC: 1, architecture/coding-standards.md]

Use event delegation for dynamically created panels:

```javascript
// Initialize in main.js
function initializePanelControls() {
  // PAUSE button handler
  document.addEventListener('click', (e) => {
    const pauseBtn = e.target.closest('.pause-btn');
    if (pauseBtn) {
      const panelId = pauseBtn.dataset.card;
      pausePanel(panelId);
    }
  });

  // ACTIVATE button handler
  document.addEventListener('click', (e) => {
    const activateBtn = e.target.closest('.activate-btn');
    if (activateBtn) {
      const panelId = activateBtn.dataset.card;
      activatePanel(panelId);
    }
  });
}

// Call on page load
window.addEventListener('DOMContentLoaded', () => {
  initializePanelControls();
  // ... other initialization
});
```

### Keyboard Shortcuts (Optional)
[Source: Task 10]

```javascript
// Optional keyboard shortcuts
document.addEventListener('keydown', (e) => {
  // Get focused panel (if textarea is focused)
  const textarea = document.activeElement;
  if (!textarea?.classList.contains('code-input')) return;

  const panelId = textarea.dataset.card;

  // Ctrl+Enter: Activate/Update
  if (e.ctrlKey && e.key === 'Enter') {
    e.preventDefault();
    activatePanel(panelId);
  }

  // Escape: Pause
  if (e.key === 'Escape') {
    e.preventDefault();
    pausePanel(panelId);
  }
});
```

### Integration with Staleness Detection
[Source: Story 6.1, Story 6.5]

Update buttons when staleness changes:

```javascript
// In textarea input listener (Story 6.5)
textarea.addEventListener('input', () => {
  checkStaleness(panelId); // Story 6.1
  updatePanelButtons(panelId); // Story 6.2
  updateVisualIndicators(panelId); // Story 6.3
});
```

### Testing

Manual testing checklist:

- [ ] Panel paused: PAUSE hidden, ACTIVATE shows "PLAY"
- [ ] Click PLAY: Audio starts, PAUSE appears, ACTIVATE grayed out
- [ ] Edit playing panel: ACTIVATE changes to "UPDATE" (highlighted)
- [ ] Click UPDATE: Audio updates, button grays out again
- [ ] Click PAUSE: Audio stops, PAUSE hides, ACTIVATE shows "PLAY"
- [ ] Edit paused panel: ACTIVATE remains "PLAY" (not "UPDATE")
- [ ] Multiple panels: Buttons work independently
- [ ] Dynamic panel creation (Epic 1): New panel has both buttons
- [ ] Keyboard shortcuts: Ctrl+Enter activates, Escape pauses

### Migration from toggleCard()

Old pattern (single button toggle):
```javascript
function toggleCard(cardId) {
  if (state.playing) {
    scheduler.stop(cardId);
    state.playing = false;
    button.textContent = 'Play';
  } else {
    evaluate(`${code}.p('${cardId}')`);
    state.playing = true;
    button.textContent = 'Pause';
  }
}
```

New pattern (separate handlers):
```javascript
// PAUSE action
function pausePanel(panelId) {
  scheduler.stop(panelId);
  panel.playing = false;
  panel.stale = false;
  updatePanelButtons(panelId);
}

// ACTIVATE action
function activatePanel(panelId) {
  evaluate(`${code}.p('${panelId}')`);
  panel.playing = true;
  panel.stale = false;
  panel.lastEvaluatedCode = code;
  updatePanelButtons(panelId);
}
```

## Dependencies

- Story 6.1: Staleness Detection Logic (requires `panel.stale` and `panel.lastEvaluatedCode`)

## Related Stories

- Story 6.3: Visual Staleness Indicators (uses button states)
- Story 6.5: Staleness Detection on Textarea Change (triggers button updates)

## Change Log

| Date       | Version | Description                      | Author |
|------------|---------|----------------------------------|--------|
| 2025-11-16 | 1.0     | Initial story draft              | Claude |
| 2025-11-17 | 2.0     | Implementation completed         | James (Dev Agent) |

## Dev Agent Record

### Agent Model Used

claude-sonnet-4-5-20250929

### Debug Log References

None

### Completion Notes List

**Implementation Summary:**

1. **CSS Button Styles** (index.html):
   - Added `.panel-controls` flexbox container for button layout
   - Added `.pause-btn` styling (red, hidden when disabled)
   - Added `.activate-btn` styling with three states:
     - Default: Green "PLAY" button
     - Stale: Yellow pulsing "UPDATE" button (animated)
     - Disabled: Gray button when playing and not stale
   - Kept legacy `.control-btn` for backward compatibility during migration

2. **HTML Structure** (panelManager.js):
   - Updated `renderPanel()` to generate two-button layout
   - PAUSE button starts hidden and disabled
   - ACTIVATE button starts enabled with "PLAY" text
   - Buttons wrapped in `.panel-controls` div

3. **Button Logic Functions** (main.js):
   - `updateActivateButton(panelId)`: Updates ACTIVATE button text and state based on playing/stale flags
   - `updatePauseButton(panelId)`: Shows/hides PAUSE button based on playing state
   - `updatePanelButtons(panelId)`: Convenience wrapper to update both buttons

4. **Panel Control Functions** (main.js):
   - `pausePanel(panelId)`: Stops audio, clears staleness, updates buttons
   - `activatePanel(panelId)`: Evaluates code, starts audio, updates state
   - Removed `toggleCard()` function (deprecated in favor of separate actions)

5. **Event Listeners** (main.js):
   - Replaced single `.control-btn` click listener with two separate listeners
   - `.pause-btn` → calls `pausePanel()`
   - `.activate-btn` → calls `activatePanel()`
   - Updated `stopAll()` to use `updatePanelButtons()`
   - Updated textarea input listener to call `updatePanelButtons()`

6. **WebSocket Integration**:
   - Updated `panel.toggle`, `panel.play`, `panel.pause` handlers to use new functions
   - Updated `panel.update` handler button state management
   - Updated bring-to-front click detection to ignore new button classes

7. **Strudel Initialization**:
   - Updated loading state to disable `.activate-btn` instead of `.control-btn`
   - Updated ready state to re-enable `.activate-btn`

**Key Implementation Decisions:**

- Kept legacy `.control-btn` CSS for backward compatibility (can be removed in future cleanup)
- `activatePanel()` is async to match pattern evaluation requirements
- PAUSE button uses `display: none` when hidden (cleaner than visibility)
- UPDATE state uses pulsing animation to draw attention to stale panels
- All button updates integrated with panelManager persistence (Story 6.1 integration)

**Task 10 - Keyboard Shortcuts:**
- Skipped as optional (not required for AC)
- Can be added in future enhancement story if requested

### File List

- `index.html` (modified) - Added CSS for .panel-controls, .pause-btn, .activate-btn
- `src/managers/panelManager.js` (modified) - Updated renderPanel() with new button structure
- `src/main.js` (modified) - Added pausePanel(), activatePanel(), updatePanelButtons(), removed toggleCard(), updated event listeners and WebSocket handlers

## QA Results

_Results from QA Agent review of the completed story implementation_

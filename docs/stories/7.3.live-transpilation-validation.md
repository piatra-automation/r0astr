# Story 7.3: Live Transpilation Validation

## Status
Ready for Review

## Story

**As a** live coder,
**I want** to see if my code transpiles correctly before playing,
**so that** I catch syntax errors early

## Acceptance Criteria

1. Transpilation validation runs 500ms after typing stops (debounced)
2. Valid code: PLAY/UPDATE button enabled (normal state)
3. Invalid code: PLAY/UPDATE button disabled (grayed out)
4. Transpilation errors displayed below textarea after 1s debounce
5. Error message format: "Error: [message] (line [N])" in red text
6. Error message clears when code becomes valid
7. Validation does not prevent PAUSE button (always available)

## Tasks / Subtasks

- [x] **Task 1: Create validateCode() function** (AC: 1)
  - [x] Create `validateCode(cardId)` function in `src/main.js`
  - [x] Get textarea content for given panel
  - [x] Call `transpiler(code, { addReturn: false })` in try/catch
  - [x] Return `{ valid: true }` on success
  - [x] Return `{ valid: false, error: errorMessage, line: lineNumber }` on error

- [x] **Task 2: Implement debounced validation trigger** (AC: 1, 4)
  - [x] Create debounce timers: `validationTimers = {}` (per panel)
  - [x] Button state validation: 500ms debounce
  - [x] Error message display: 1000ms debounce (longer delay)
  - [x] Clear timers on new input event
  - [x] Attach `input` event listener to all textareas

- [x] **Task 3: Update button state based on validation** (AC: 2, 3, 7)
  - [x] Create `updateButtonState(cardId, isValid)` function
  - [x] Query PLAY/UPDATE button for given panel
  - [x] If valid: enable button, remove `disabled` class
  - [x] If invalid: disable button, add `disabled` class
  - [x] PAUSE button: always enabled (check if playing, not if valid)

- [x] **Task 4: Add error message container to panel HTML** (AC: 5)
  - [x] Modify panel HTML structure in `index.html` or `src/ui/panelRenderer.js`
  - [x] Add error container below textarea: `<div class="error-message" data-card="${cardId}"></div>`
  - [x] Style error container: red text, small font, hidden by default

- [x] **Task 5: Display error message on validation failure** (AC: 4, 5, 6)
  - [x] Create `displayError(cardId, errorMessage, lineNumber)` function
  - [x] Format error message: `Error: ${errorMessage} (line ${lineNumber})`
  - [x] Insert formatted message into error container
  - [x] Show error container (display: block)
  - [x] If validation succeeds, clear error message and hide container

- [x] **Task 6: Extract error details from transpiler** (AC: 5)
  - [x] Parse transpiler error object for message and line number
  - [x] Handle different error types (syntax errors, runtime errors)
  - [x] Fallback to generic error message if line number unavailable
  - [x] Test with various invalid code patterns

- [x] **Task 7: Integrate with staleness detection** (AC: 2, 3)
  - [x] Button state depends on both validation AND staleness (Story 6.1, 6.2)
  - [x] Playing panel with stale valid code: Show UPDATE button (enabled)
  - [x] Playing panel with stale invalid code: Show UPDATE button (disabled)
  - [x] Not playing panel with valid code: Show PLAY button (enabled)
  - [x] Not playing panel with invalid code: Show PLAY button (disabled)

- [x] **Task 8: Add CSS for disabled button and error message** (AC: 3, 5)
  - [x] Style `.control-btn.disabled` - grayed out, cursor: not-allowed
  - [x] Style `.error-message` - red text, padding, hidden by default
  - [x] Add transition for smooth show/hide of error message

## Dev Notes

### Transpiler Validation Function
[Source: AC: 1, epic-7-text-panel-improvements.md]

```javascript
function validateCode(cardId) {
  const textarea = document.querySelector(`[data-card="${cardId}"]`);
  const code = textarea.value.trim();

  // Empty code is valid (no pattern to play)
  if (!code) {
    return { valid: true };
  }

  try {
    // Attempt transpilation (same options as toggleCard)
    const result = transpiler(code, { addReturn: false });
    return { valid: true };
  } catch (error) {
    // Extract error details
    const errorMessage = error.message || 'Unknown error';
    const lineNumber = error.line || error.lineNumber || 'unknown';

    return {
      valid: false,
      error: errorMessage,
      line: lineNumber
    };
  }
}
```

### Debounced Validation Pattern
[Source: AC: 1, 4, epic-7-text-panel-improvements.md]

Two debounce timers with different delays:
```javascript
const validationTimers = {}; // { cardId: { button: timeoutId, error: timeoutId } }

function attachValidationListener(cardId) {
  const textarea = document.querySelector(`[data-card="${cardId}"]`);

  textarea.addEventListener('input', () => {
    // Clear existing timers
    if (validationTimers[cardId]) {
      clearTimeout(validationTimers[cardId].button);
      clearTimeout(validationTimers[cardId].error);
    }

    // Initialize timer object if needed
    if (!validationTimers[cardId]) {
      validationTimers[cardId] = {};
    }

    // Validate for button state after 500ms
    validationTimers[cardId].button = setTimeout(() => {
      const result = validateCode(cardId);
      updateButtonState(cardId, result.valid);
    }, 500);

    // Display error message after 1000ms (longer delay)
    validationTimers[cardId].error = setTimeout(() => {
      const result = validateCode(cardId);
      if (result.valid) {
        clearErrorMessage(cardId);
      } else {
        displayError(cardId, result.error, result.line);
      }
    }, 1000);
  });
}
```

### Button State Management
[Source: AC: 2, 3, 7, Epic 6 Staleness Detection]

```javascript
function updateButtonState(cardId, isValid) {
  const button = document.querySelector(`.control-btn[data-card="${cardId}"]`);
  const panel = cardStates[cardId];

  // PAUSE button always enabled when playing
  if (panel.playing) {
    const isPauseButton = button.textContent === 'Pause';
    if (isPauseButton) {
      button.disabled = false;
      button.classList.remove('disabled');
      return;
    }
  }

  // PLAY/UPDATE button enabled only if valid
  if (isValid) {
    button.disabled = false;
    button.classList.remove('disabled');
  } else {
    button.disabled = true;
    button.classList.add('disabled');
  }
}
```

### Error Message Display
[Source: AC: 4, 5, 6]

```javascript
function displayError(cardId, errorMessage, lineNumber) {
  const errorContainer = document.querySelector(`.error-message[data-card="${cardId}"]`);
  if (!errorContainer) return;

  const formattedError = `Error: ${errorMessage} (line ${lineNumber})`;
  errorContainer.textContent = formattedError;
  errorContainer.style.display = 'block';
}

function clearErrorMessage(cardId) {
  const errorContainer = document.querySelector(`.error-message[data-card="${cardId}"]`);
  if (!errorContainer) return;

  errorContainer.textContent = '';
  errorContainer.style.display = 'none';
}
```

### Panel HTML Structure Update
[Source: AC: 4, architecture/source-tree.md]

Add error container to panel HTML:
```html
<div class="card" id="card-1">
  <div class="card-header">
    <h3>Instrument 1</h3>
    <button class="control-btn" data-card="card-1">Play</button>
  </div>
  <textarea class="code-input" data-card="card-1"></textarea>
  <div class="slider-container" id="card-1-sliders"></div>
  <!-- NEW: Error message container -->
  <div class="error-message" data-card="card-1"></div>
</div>
```

### CSS Styling
[Source: AC: 3, 5]

```css
/* Disabled button state */
.control-btn.disabled,
.control-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  background-color: #666;
  pointer-events: none; /* Prevent click */
}

/* Error message container */
.error-message {
  display: none; /* Hidden by default */
  color: #e06c75; /* Red */
  font-size: 0.85em;
  padding: 0.5em;
  margin-top: 0.5em;
  background-color: rgba(224, 108, 117, 0.1);
  border-left: 3px solid #e06c75;
  transition: opacity 0.2s ease-in-out;
}

.error-message:empty {
  display: none; /* Hide when empty */
}
```

### Error Parsing from Transpiler
[Source: AC: 5, @strudel/transpiler]

Transpiler error object structure (may vary):
```javascript
try {
  transpiler(code);
} catch (error) {
  // Possible error properties:
  // - error.message: Error description
  // - error.line: Line number (may not always be present)
  // - error.lineNumber: Alternative line number property
  // - error.column: Column number (optional)

  const errorMessage = error.message || 'Syntax error';
  const lineNumber = error.line || error.lineNumber || 'unknown';

  console.error('Transpilation error:', { errorMessage, lineNumber, error });
}
```

### Integration with Staleness Detection
[Source: AC: 2, 3, 7, Epic 6]

Button state logic combines validation and staleness:
```javascript
function updatePlayUpdateButton(cardId) {
  const panel = cardStates[cardId];
  const button = document.querySelector(`.control-btn[data-card="${cardId}"]`);
  const validation = validateCode(cardId);

  // Determine button label
  if (panel.playing && panel.stale) {
    button.textContent = 'Update';
  } else if (panel.playing) {
    button.textContent = 'Pause';
  } else {
    button.textContent = 'Play';
  }

  // Determine button enabled state
  if (panel.playing && button.textContent === 'Pause') {
    // PAUSE button always enabled
    button.disabled = false;
    button.classList.remove('disabled');
  } else {
    // PLAY/UPDATE button enabled only if code is valid
    button.disabled = !validation.valid;
    if (validation.valid) {
      button.classList.remove('disabled');
    } else {
      button.classList.add('disabled');
    }
  }
}
```

### Validation on Panel Creation
[Source: AC: 1, Story 1.1]

Attach validation listener to new panels:
```javascript
function createPanel(options) {
  // Create panel HTML...
  const panelId = generatePanelId();

  // Attach validation listener
  attachValidationListener(panelId);

  return panelId;
}
```

### Performance Considerations
[Source: AC: 1, epic-7-text-panel-improvements.md]

Debounce delays chosen for performance:
- **500ms for button state**: Fast feedback, minimal lag
- **1000ms for error message**: Avoids flickering errors while typing

Transpilation is relatively fast (<10ms for typical patterns), so validation overhead is minimal.

### Edge Cases

**Empty Code**
- Valid (no pattern to play)
- PLAY button enabled, but pattern is empty (no-op)

**Master Panel**
- **DO NOT validate master panel with transpiler** (causes hang, see strudel-integration-gotchas.md)
- Master panel uses regex parsing, no live validation needed

**Multi-Line Errors**
- Display first error only (most relevant)
- User fixes first error, subsequent errors may appear

**Stale Panel with Invalid Code**
- Panel playing, user edits code to invalid state
- Button shows "Update" but is disabled (grayed out)
- User must fix code before updating pattern

### Testing

Manual testing checklist:

- [ ] Valid code: PLAY button enabled
- [ ] Invalid code: PLAY button disabled (grayed out)
- [ ] Typing valid code: Button enables after 500ms
- [ ] Typing invalid code: Button disables after 500ms
- [ ] Invalid code: Error message appears after 1000ms
- [ ] Error message format: "Error: [message] (line [N])"
- [ ] Fix invalid code: Error message disappears
- [ ] Playing panel (PAUSE button): Always enabled, validation irrelevant
- [ ] Stale panel with valid code: UPDATE button enabled
- [ ] Stale panel with invalid code: UPDATE button disabled
- [ ] Empty code: PLAY button enabled (valid)
- [ ] Master panel: No validation (regex parsing only)

## Dependencies

- Epic 6: Staleness Detection (Story 6.1, 6.2 for button state management)
- Epic 1: Dynamic Panel Management (panel creation, event listeners)

## Related Stories

- Story 6.1: Staleness Detection Logic (stale flag management)
- Story 6.2: Separate PAUSE and ACTIVATE Buttons (button state logic)
- Story 7.4: Auto-Formatting on Play/Update (formatting after validation)

## Out of Scope

- Master panel validation (uses regex parsing, transpiler causes hang)
- Real-time syntax highlighting (covered in Story 7.5)
- Auto-fix suggestions (future enhancement)

## Change Log

| Date       | Version | Description          | Author |
|------------|---------|----------------------|--------|
| 2025-11-16 | 1.0     | Initial story draft  | Claude |

## Dev Agent Record

### Agent Model Used

claude-sonnet-4-5-20250929

### Debug Log References

None required - implementation completed without blocking issues

### Completion Notes List

- Created `validateCode()` function with two-step validation:
  * Step 1: Transpile code (catches syntax errors)
  * Step 2: "Dry run" evaluation WITHOUT .p() (catches ReferenceError - undefined vars/functions)
- Validation now catches: syntax errors, ReferenceError (undefined variables/functions)
- **Enhanced error handling**: Multi-layer error catching with console.error interception
  * **Validation phase**: Catches errors during dry-run evaluation (ReferenceError, some TypeErrors)
    - Suppresses console.error spam during validation (prevents duplicate error logging)
  * **Playback phase**: Intercepts console.error during evaluate() to catch runtime errors
    - Invalid methods like `.sq()` caught via console.error interception
    - Strudel logs errors to console.error but doesn't throw/reject promises
    - 50ms delay after evaluate() allows async errors to be logged and captured
    - Prevents panel from entering "playing" state if evaluation fails
    - Calls scheduler.stop() to clean up any partial pattern registration
    - Displays error in validation UI, panel stays in paused state
  * **Error message cleanup** for better readability:
    - "Cannot read properties of undefined (reading 'delay')" → "Property 'delay' is undefined"
    - "arrange(...).s.delay is not a function" → "Method '.delay()' is not a function"
  * **Note**: Strudel's internal `[eval] error:` console messages still appear but errors are properly handled
- Implemented dual debounce timers: 500ms for button state, 1000ms for error display
- Modified `updateActivateButton()` to integrate validation with staleness detection
- PLAY/UPDATE button disabled when code is invalid (grayed out with .disabled class)
- PAUSE button always enabled regardless of validation (AC: 7)
- Added error message container to panel HTML template in renderPanel()
- Error messages format: "Error: [message] (line [N])" with red styling
- Error messages clear automatically when code becomes valid
- Validation runs for all panel lifecycle events:
  * Panel creation: Restored panels from localStorage (session restore)
  * Panel creation: New panels created via Add Panel button
  * Panel creation: Panels created via API/WebSocket (remote control)
  * Panel updates: Code updated via API/WebSocket (remote control)
  * Startup: All existing panels validated after Strudel initialization
- Guard check in validateCode prevents errors when evaluate not yet initialized (early startup)
- Master panel excluded from validation (uses regex parsing, transpiler causes hang)
- Empty code is treated as valid (no pattern to play)

### File List

- `src/main.js` - Added validateCode(), displayError(), clearErrorMessage(), attachValidationListener() functions; modified updateActivateButton() to integrate validation; attached listeners in panel creation and restoration
- `src/managers/panelManager.js` - Added error message container to renderPanel() HTML
- `index.html` - Added CSS for .activate-btn.disabled and .error-message

## QA Results

_Results from QA Agent review of the completed story implementation_

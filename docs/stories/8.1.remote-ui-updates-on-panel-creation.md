# Story 8.1: Remote UI Updates on Panel Creation

## Status
Ready for Review

## Story

**As a** remote control user,
**I want** new panels to appear automatically on my remote device,
**so that** I can control newly created instruments without refreshing

## Acceptance Criteria

1. When main interface creates panel, remote.html receives `panel_created` event
2. Remote client dynamically adds panel controls to UI
3. New panel controls include: title, Play/Pause/Stop buttons
4. Panel appears in same order as main interface
5. No page refresh required on remote device

## Tasks / Subtasks

- [x] **Task 1: Extend WebSocket server to broadcast panel_created event** (AC: 1)
  - [x] Update `src/managers/panelManager.js` `createPanel()` function
  - [x] After panel creation succeeds, call `broadcastWebSocket()`
  - [x] Event payload: `{ type: 'panel_created', id, title, position }`
  - [x] Test: Create panel in main UI, verify WebSocket broadcast
  - [x] Requires Story 5.6 WebSocket infrastructure

- [x] **Task 2: Create remote panel control template** (AC: 2, 3)
  - [x] Define `createRemotePanelControl(panel)` function in remote.html
  - [x] Generate HTML structure matching existing `.panel-control` divs
  - [x] Template: `<div class="panel-control" id="remote-${id}" data-panel-id="${id}">...</div>`
  - [x] Include panel title, Play/Pause button, status text
  - [x] Test: Call function manually, verify HTML is generated correctly

- [x] **Task 3: Update remote WebSocket message handler** (AC: 1, 2)
  - [x] Extend `handleMessage()` in remote.html to handle `panel_created` event
  - [x] Extract panel data from event: `{ id, title, position }`
  - [x] Call `createRemotePanelControl(panel)`
  - [x] Append new control to `.panels` container
  - [x] Test: Send mock panel_created message, verify panel appears

- [x] **Task 4: Implement panel insertion at correct position** (AC: 4)
  - [x] Use `position` field from event to determine insertion order
  - [x] Iterate through existing `.panel-control` elements
  - [x] Insert new panel before first panel with higher position
  - [x] Append to end if position is highest
  - [x] Test: Create panels with various positions, verify correct order

- [x] **Task 5: Wire Play/Pause button for new panel** (AC: 3)
  - [x] Attach click event listener to new panel's `.panel-button`
  - [x] Send `panel.toggle` WebSocket command with panel ID
  - [x] Update local state tracking for new panel
  - [x] Test: Click Play button on dynamically created panel, verify command sent

- [x] **Task 6: Add CSS transitions for smooth panel appearance** (AC: 5)
  - [x] Add CSS class `.panel-control-new` for fade-in animation
  - [x] Apply animation on panel creation: `opacity 0 → 1` over 300ms
  - [x] Remove animation class after transition completes
  - [x] Test: Create panel, verify smooth fade-in effect

- [x] **Task 7: Handle duplicate panel creation** (AC: 2)
  - [x] Check if panel with same ID already exists before creating
  - [x] If exists, skip creation (log warning)
  - [x] Prevents duplicate controls if multiple events received
  - [x] Test: Send duplicate panel_created event, verify no duplicate controls

- [x] **Task 8: Update remote state tracking** (AC: 2, 3)
  - [x] Initialize `panelStates` entry for new panel
  - [x] Set initial state: `{ playing: false }`
  - [x] Ensure state updates work for dynamically created panels
  - [x] Test: Create panel, toggle playback, verify state updates correctly

## Dev Notes

### v0.2.0 Remote Control Current Implementation
[Source: remote.html lines 172-203]

Current remote.html has 4 hardcoded `.panel-control` divs:
```html
<div class="panel-control" id="panel-1">
  <div class="panel-info">
    <h3>Instrument 1 - Bass</h3>
    <div class="status">Stopped</div>
  </div>
  <button class="panel-button" data-panel="1">▶</button>
</div>
```

Panel IDs are numeric: `1, 2, 3, 4`.
Panel titles are static strings: "Instrument 1 - Bass", "Instrument 2 - Drums", etc.

### Breaking Change Alert
[Source: Epic 8 PRD]

After Epic 1 implementation:
- Panel IDs will be timestamp-based: `panel-1701234567890`
- Panel count is dynamic: can exceed 4
- Panel creation is user-initiated (not hardcoded on page load)

Remote.html MUST migrate to dynamic panel creation to remain functional.

### Panel Control Template Structure
[Source: remote.html lines 69-107]

Template for dynamically created panel controls:
```javascript
function createRemotePanelControl(panel) {
  const { id, title } = panel;

  const div = document.createElement('div');
  div.className = 'panel-control panel-control-new';
  div.id = `remote-${id}`;
  div.dataset.panelId = id;

  div.innerHTML = `
    <div class="panel-info">
      <h3>${escapeHtml(title)}</h3>
      <div class="status">Stopped</div>
    </div>
    <button class="panel-button" data-panel="${id}">▶</button>
  `;

  return div;
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}
```

### WebSocket Event Payload
[Source: Epic 8 PRD Technical Notes]

`panel_created` event structure:
```json
{
  "type": "panel_created",
  "id": "panel-1701234567890",
  "title": "Bass",
  "position": 2,
  "timestamp": 1701234567890
}
```

Position field determines display order (lower = higher in list).

### Panel Insertion Logic
[Source: Epic 8 Story 8.5 Panel Order Synchronization]

Insert panel at correct position based on `position` field:
```javascript
function insertPanelAtPosition(panelElement, position) {
  const container = document.querySelector('.panels');
  const existingPanels = Array.from(container.querySelectorAll('.panel-control'));

  // Master panel should always be first - skip it
  const nonMasterPanels = existingPanels.filter(p =>
    !p.dataset.panelId || p.dataset.panelId !== 'master'
  );

  // Find insertion point
  let insertBefore = null;
  for (const panel of nonMasterPanels) {
    const panelPosition = parseInt(panel.dataset.position) || Infinity;
    if (position < panelPosition) {
      insertBefore = panel;
      break;
    }
  }

  if (insertBefore) {
    container.insertBefore(panelElement, insertBefore);
  } else {
    container.appendChild(panelElement);
  }
}
```

### Event Listener Attachment
[Source: remote.html lines 342-348]

Current implementation uses static event listeners:
```javascript
document.querySelectorAll('.panel-button').forEach((button) => {
  const panel = parseInt(button.getAttribute('data-panel'));
  button.addEventListener('click', () => {
    sendCommand('panel.toggle', panel);
  });
});
```

Migrate to event delegation for dynamic panels:
```javascript
document.querySelector('.panels').addEventListener('click', (e) => {
  const button = e.target.closest('.panel-button');
  if (button) {
    const panelId = button.dataset.panel;
    sendCommand('panel.toggle', panelId);
  }
});
```

### CSS Transition for Panel Appearance
[Source: AC: 6]

Add smooth fade-in animation:
```css
.panel-control-new {
  opacity: 0;
  animation: fadeIn 300ms ease-in forwards;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}
```

Remove animation class after completion:
```javascript
panelElement.addEventListener('animationend', () => {
  panelElement.classList.remove('panel-control-new');
}, { once: true });
```

### State Tracking for Dynamic Panels
[Source: remote.html lines 215-220]

Current state tracking is hardcoded:
```javascript
const panelStates = {
  1: false,
  2: false,
  3: false,
  4: false,
};
```

Migrate to dynamic state object:
```javascript
const panelStates = {};

// When panel created:
panelStates[panelId] = { playing: false };

// When panel deleted:
delete panelStates[panelId];
```

### Integration with Epic 1
[Source: src/managers/panelManager.js after Story 1.1]

Panel creation in main interface:
```javascript
export function createPanel(options = {}) {
  const panel = {
    id: generatePanelId(),
    title: options.title || generateDefaultTitle(),
    code: options.code || '',
    playing: false,
    position: options.position || getNextPosition(),
    // ...
  };

  panels[panel.id] = panel;
  renderPanel(panel.id, panel);

  // Broadcast to remote clients
  if (typeof broadcastWebSocket === 'function') {
    broadcastWebSocket({
      type: 'panel_created',
      id: panel.id,
      title: panel.title,
      position: panel.position
    });
  }

  return panel.id;
}
```

### Testing

Manual testing checklist:

- [ ] Start main interface and remote.html in separate browser windows
- [ ] Click [+] button in main interface
- [ ] Verify `panel_created` event received in remote WebSocket connection
- [ ] Verify new panel control appears in remote UI
- [ ] Verify panel control shows correct title
- [ ] Verify panel control has Play button with correct icon
- [ ] Verify panel appears in correct position (after existing panels)
- [ ] Click Play button on new panel in remote UI
- [ ] Verify `panel.toggle` command sent to server
- [ ] Verify main interface updates playback state
- [ ] Create multiple panels, verify all appear in correct order
- [ ] Verify no duplicate panels if multiple clients connected
- [ ] Verify CSS fade-in animation plays smoothly

### Dependencies

- Story 1.1: Add New Panel Button (panel creation in main interface)
- Story 5.6: WebSocket State Sync (WebSocket infrastructure)
- Epic 2: Panel rename may update title field (Story 2.1)

### Related Stories

- Story 8.2: Remote UI Updates on Panel Deletion
- Story 8.3: Remote UI Updates on Panel Rename
- Story 8.4: Full Panel State Sync on Remote Connect
- Story 8.5: Remote Panel Order Synchronization

## Change Log

| Date       | Version | Description          | Author |
|------------|---------|----------------------|--------|
| 2025-11-16 | 1.0     | Initial story draft  | Claude |

## Dev Agent Record

### Agent Model Used

claude-sonnet-4-5-20250929

### Debug Log References

None - Implementation completed without issues

### Completion Notes List

- Implemented WebSocket broadcast in src/main.js (line 635-646) after panel creation
- Added panel_created event type with payload: `{ type, id, title, position, timestamp }`
- Created helper functions in remote.html:
  - `escapeHtml()` for XSS prevention
  - `createRemotePanelControl()` for dynamic panel element generation
  - `insertPanelAtPosition()` for ordered panel insertion
- Extended handleMessage() in remote.html to handle panel_created events
- Added CSS fade-in animation (.panel-control-new class)
- Migrated from static event listeners to event delegation for dynamic panel buttons
- Duplicate panel detection implemented (checks for existing remote-${id} element)
- Panel state tracking automatically initialized on creation

### File List

- `src/main.js` (modified) - Added WebSocket broadcast after panel creation (line 635-646)
- `remote.html` (modified) - Added createRemotePanelControl(), insertPanelAtPosition(), escapeHtml() helper functions
- `remote.html` (modified) - Extended handleMessage() to handle panel_created event (line 379-400)
- `remote.html` (modified) - Added CSS fade-in animation for .panel-control-new (line 163-178)
- `remote.html` (modified) - Migrated to event delegation for panel button clicks (line 450-458)

## QA Results

_Results from QA Agent review of the completed story implementation_

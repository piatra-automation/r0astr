<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Piatra REPL - Dual Card Interface</title>
  <link rel="stylesheet" href="/static/css/base.css">
  <link rel="stylesheet" href="/static/css/components/panel-tree.css">
  <link rel="stylesheet" href="/static/css/themes/synthwave.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:ital,wght@0,100..900;1,100..900&display=swap"
    rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>

<body>
  <!-- Electron: Draggable title bar region (no-op in browser) -->
  <div class="electron-drag-region"></div>

  <!-- Fixed logo in corner -->
  <div class="site-logo">
    <img src="/static/images/banner.png" alt="r0astr Logo">
  </div>

  <!-- Subtitle positioned independently from logo -->
  <div class="banner-subtitle">
    <a href="https://strudel.cc" target="_blank" rel="noopener noreferrer">STRUDEL</a> SYNTH API | ORCHESTRATOR
  </div>

  <!-- Top Menu Bar: Button container positioned per-skin in CSS -->
  <!-- Skins can override .top-menu-bar positioning in their stylesheets -->
  <nav class="top-menu-bar" id="top-menu-bar" aria-label="Main menu">
    <button class="top-bar-btn btn-white" id="save-btn">SAVE</button>
    <button class="top-bar-btn btn-orange" id="load-btn">LOAD</button>
    <a href="/remote" class="top-bar-btn btn-green" id="remote-btn" target="_blank" rel="noopener noreferrer">REMOTE</a>
    <button class="top-bar-btn btn-orange" id="config-btn">CONFIG</button>
  </nav>

  <!-- Screen area (removed for tree layout) -->
  <!-- <div class="screen"></div> -->

  <!-- Hero section with banner -->
  <div class="hero-section">
    <div class="hero-banner">
    </div>

    <!-- Metronome indicator (left side, after banner) -->
    <div class="metronome-indicator" id="metronome" title="Cycle pulse">
      <div class="metronome-pulse"></div>
    </div>

    <!-- Hero controls -->
    <div class="hero-controls">
      <button class="btn-hole btn-hole-slim action-add" id="add-panel-btn" title="Add New Panel">
        <div class="btn-raised btn-raised-slim btn-dark-green">
          <span class="material-icons">add</span>
        </div>
      </button>

      <button class="btn-hole btn-hole-square action-update" id="update-all-btn" title="Update all stale panels">
        <div class="btn-raised btn-raised-square btn-pearl">
          <span class="material-icons">eco</span>
          <span class="count-badge hidden"></span>
        </div>
      </button>

      <button class="btn-hole btn-hole-square action-stop" id="stop-all" title="Stop All">
        <div class="btn-raised btn-raised-square btn-cream">
          <span class="material-icons">stop</span>
        </div>
      </button>
    </div>
  </div>

  <div id="splash-modal" class="splash-overlay" role="dialog" aria-modal="true" aria-label="Loading r0astr">
    <!-- Large animated logo -->
    <div class="splash-logo-image" id="splash-logo-animate">
      <img src="/static/images/banner.png" alt="r0astr Logo">
    </div>

    <div class="splash-content">
      <div class="splash-logo">
        <h1 class="splash-title">r0astr</h1>
      </div>
      <p class="splash-tagline">Multi-Instrument Live Coding Interface</p>
      <div class="splash-progress-container">
        <div class="splash-progress-bar splash-progress-indeterminate">
          <div class="splash-progress-fill"></div>
        </div>
        <p class="splash-status">Loading samples...</p>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settings-modal" class="modal-overlay" role="dialog" aria-labelledby="settings-title" aria-modal="true">
    <div class="modal-content settings-panel">
      <div class="modal-header">
        <h2 id="settings-title">Settings</h2>
      </div>

      <div class="modal-body">
        <!-- Appearance Section (Story 4.5) -->
        <section class="settings-section" id="appearance-settings">
          <h3>Appearance</h3>

          <!-- Color Scheme Dropdown (AC: 1) -->
          <div class="setting-item">
            <label for="color-scheme-select">Color Scheme</label>
            <select id="color-scheme-select" class="setting-select">
              <option value="dark">Dark (Default)</option>
              <option value="light">Light</option>
            </select>
            <p class="setting-description">
              Choose between dark and light themes
            </p>
          </div>

          <!-- Font Size Slider (AC: 2) -->
          <div class="setting-item">
            <label for="font-size-slider">
              Code Editor Font Size: <span id="font-size-value">14px</span>
            </label>
            <input type="range" id="font-size-slider" class="setting-slider" min="10" max="24" value="14" step="1">
            <p class="setting-description">
              Adjust font size for all code editors (10-24px)
            </p>
          </div>

          <!-- Active Panel Opacity Slider -->
          <div class="setting-item">
            <label for="active-panel-opacity-slider">
              Active Panel Opacity: <span id="active-panel-opacity-value">95%</span>
            </label>
            <input type="range" id="active-panel-opacity-slider" class="setting-slider" min="50" max="100" value="95"
              step="5">
            <p class="setting-description">
              Opacity for the currently focused/active panel (50-100%)
            </p>
          </div>

          <!-- Background Panel Opacity Slider -->
          <div class="setting-item">
            <label for="background-panel-opacity-slider">
              Background Panels Opacity: <span id="background-panel-opacity-value">60%</span>
            </label>
            <input type="range" id="background-panel-opacity-slider" class="setting-slider" min="20" max="100"
              value="60" step="5">
            <p class="setting-description">
              Cumulative opacity for unfocused panels (includes text, borders, everything) (20-100%)
            </p>
          </div>

          <!-- Collapse on Blur Toggle -->
          <div class="setting-item">
            <label class="toggle-label">
              <input type="checkbox" id="collapse-on-blur-toggle" class="toggle-input">
              <span class="toggle-slider"></span>
              <span class="toggle-text">Collapse unfocused panels</span>
            </label>
            <p class="setting-description">
              When enabled, background panels collapse to show only header (badge, title, buttons)
            </p>
          </div>

          <!-- Show Splash Screen Toggle -->
          <div class="setting-item">
            <label class="toggle-label">
              <input type="checkbox" id="show-splash-toggle" class="toggle-input">
              <span class="toggle-slider"></span>
              <span class="toggle-text">Show splash screen during loading</span>
            </label>
            <p class="setting-description">
              Display animated splash screen while samples load. When disabled, page shows immediately and samples load in background.
            </p>
          </div>

          <!-- Show Controls When Collapsed Toggle -->
          <div class="setting-item">
            <label class="toggle-label">
              <input type="checkbox" id="show-controls-collapsed-toggle" class="toggle-input">
              <span class="toggle-slider"></span>
              <span class="toggle-text">Show controls when panel collapsed</span>
            </label>
            <p class="setting-description">
              When a playing panel is collapsed, keep sliders and visualizers visible. Only hides the code editor.
            </p>
          </div>

          <!-- Wrap Lines Toggle (Story 7.1) -->
          <div class="setting-item">
            <label class="toggle-label">
              <input type="checkbox" id="wrap-lines-toggle" class="toggle-input">
              <span class="toggle-slider"></span>
              <span class="toggle-text">Wrap long lines in code panels</span>
            </label>
            <p class="setting-description">
              When enabled, long lines wrap to next line instead of scrolling horizontally
            </p>
          </div>

          <!-- Auto-Format Toggle (Story 7.4) -->
          <div class="setting-item">
            <label class="toggle-label">
              <input type="checkbox" id="auto-format-toggle" class="toggle-input">
              <span class="toggle-slider"></span>
              <span class="toggle-text">Auto-format code on PLAY/UPDATE</span>
            </label>
            <p class="setting-description">
              Automatically formats code for readability when pressing PLAY or UPDATE. Does not change code behavior.
            </p>
          </div>

          <!-- Syntax Highlighting Toggle (Story 7.6) -->
          <div class="setting-item">
            <label class="toggle-label">
              <input type="checkbox" id="syntax-highlight-toggle" class="toggle-input">
              <span class="toggle-slider"></span>
              <span class="toggle-text">Enable syntax highlighting</span>
            </label>
            <p class="setting-description">
              Use CodeMirror for syntax highlighting. Disable for plain text editor (better performance on very long
              files).
            </p>
          </div>

          <!-- Pattern Highlighting Toggle -->
          <div class="setting-item">
            <label class="toggle-label">
              <input type="checkbox" id="pattern-highlighting-toggle" class="toggle-input">
              <span class="toggle-slider"></span>
              <span class="toggle-text">Real-time Pattern Highlighting</span>
            </label>
            <p class="setting-description">
              Highlight active pattern elements during playback. Shows which code segments are currently playing.
            </p>
          </div>

          <!-- Editor Theme Selection (Story 7.6) -->
          <div class="setting-item">
            <label for="editor-theme-select">
              Editor Theme
            </label>
            <select id="editor-theme-select" class="setting-select">
              <option value="atomone">Atom One Dark</option>
              <option value="abcdef">Abcdef</option>
              <option value="bespin">Bespin</option>
              <option value="dracula">Dracula</option>
              <option value="gruvboxDark">Gruvbox Dark</option>
              <option value="materialDark">Material Dark</option>
              <option value="nord">Nord</option>
              <option value="solarizedDark">Solarized Dark</option>
            </select>
            <p class="setting-description">
              Color theme for code editor (requires syntax highlighting enabled)
            </p>
          </div>

          <!-- Default Panel Width (Story 7.2) -->
          <div class="setting-item">
            <label for="default-width">
              Default Panel Width (px): <span id="default-width-value">600</span>
            </label>
            <input type="number" id="default-width" class="setting-number-input" min="300" max="2000" value="600"
              step="10">
            <span class="validation-message" id="width-validation"></span>
            <p class="setting-description">
              New panels will be created with this width (300-2000px)
            </p>
          </div>

          <!-- Default Panel Height (Story 7.2) -->
          <div class="setting-item">
            <label for="default-height">
              Default Panel Height (px): <span id="default-height-value">400</span>
            </label>
            <input type="number" id="default-height" class="setting-number-input" min="200" max="1500" value="400"
              step="10">
            <span class="validation-message" id="height-validation"></span>
            <p class="setting-description">
              New panels will be created with this height (200-1500px)
            </p>
          </div>
        </section>

        <!-- Behavior Section (Story 4.4) -->
        <section class="settings-section" id="behavior-settings">
          <h3>Behavior</h3>

          <!-- YOLO Mode Toggle (AC: 1) -->
          <div class="setting-item">
            <label class="toggle-label">
              <input type="checkbox" id="yolo-toggle" class="toggle-input">
              <span class="toggle-slider"></span>
              <span class="toggle-text">YOLO Mode (Skip deletion confirmations)</span>
            </label>
            <p class="setting-description">
              Disable confirmation dialogs when deleting panels. For users who like to live dangerously.
            </p>
          </div>

          <!-- Auto-save Interval (AC: 2) -->
          <div class="setting-item">
            <label for="autosave-interval-select">Auto-save Panel State</label>
            <select id="autosave-interval-select" class="setting-select">
              <option value="manual">Manual (on panel change)</option>
              <option value="30s">Every 30 seconds</option>
              <option value="1min">Every 1 minute</option>
              <option value="5min">Every 5 minutes</option>
            </select>
            <p class="setting-description">
              How frequently to save panel state to localStorage
            </p>
          </div>

          <!-- Restore Session Toggle (AC: 3) -->
          <div class="setting-item">
            <label class="toggle-label">
              <input type="checkbox" id="restore-session-toggle" class="toggle-input">
              <span class="toggle-slider"></span>
              <span class="toggle-text">Restore Session on Load</span>
            </label>
            <p class="setting-description">
              Automatically restore panels and code from previous session when opening the app
            </p>
          </div>

          <!-- Confirmation Dialogs Toggle (AC: 4) -->
          <div class="setting-item">
            <label class="toggle-label">
              <input type="checkbox" id="confirmation-dialogs-toggle" class="toggle-input">
              <span class="toggle-slider"></span>
              <span class="toggle-text">Show Confirmation Dialogs</span>
            </label>
            <p class="setting-description">
              Show confirmation prompts for destructive actions (overrides YOLO mode if disabled)
            </p>
          </div>
        </section>

        <!-- Integrations Section (Story 4.6) -->
        <section class="settings-section" id="integration-settings">
          <h3>Integrations</h3>

          <!-- Snippet Location Input (AC: 1) -->
          <div class="setting-item">
            <label for="snippet-location-input">Snippet Library URL/Path</label>
            <input type="text" id="snippet-location-input" class="setting-text-input"
              placeholder="https://example.com/snippets.json">
            <p class="setting-description">
              URL or file path to external snippet library (JSON format). Leave empty to disable.
            </p>
          </div>

          <!-- Remote WebSocket Layout Dropdown (AC: 2) -->
          <div class="setting-item">
            <label for="remote-ws-layout-select">Remote Control Panel Layout</label>
            <select id="remote-ws-layout-select" class="setting-select">
              <option value="side-panel">Side Panel (Default)</option>
              <option value="modal">Modal Overlay</option>
              <option value="hidden">Hidden</option>
            </select>
            <p class="setting-description">
              Where to display remote control panel (requires WebSocket server from Epic 5)
            </p>
          </div>

          <!-- Skin Pack Path Input (AC: 3) -->
          <div class="setting-item">
            <label for="skin-pack-input">Skin Pack Folder Path</label>
            <input type="text" id="skin-pack-input" class="setting-text-input" placeholder="/path/to/skins">
            <p class="setting-description">
              Path to WinAmp-style skin folder (future feature, Epic 2 extension)
            </p>
          </div>
        </section>

        <!-- Projection Tweaks Section -->
        <section class="settings-section" id="projection-settings">
          <h3>Projection Tweaks</h3>
          <p class="setting-description">
            Add margins to the entire UI for projection or screen sharing adjustments
          </p>

          <div class="notice-box notice-info">
            <span class="material-icons">info</span>
            <span>Changing projection margins requires a page reload to take effect</span>
          </div>

          <!-- Top Margin -->
          <div class="setting-item">
            <label for="projection-margin-top">
              Top Margin: <span id="projection-margin-top-value">0px</span>
            </label>
            <input type="range" id="projection-margin-top" class="setting-slider" min="0" max="200" value="0" step="5">
            <p class="setting-description">
              Top margin in pixels (0-200px)
            </p>
          </div>

          <!-- Right Margin -->
          <div class="setting-item">
            <label for="projection-margin-right">
              Right Margin: <span id="projection-margin-right-value">0px</span>
            </label>
            <input type="range" id="projection-margin-right" class="setting-slider" min="0" max="200" value="0"
              step="5">
            <p class="setting-description">
              Right margin in pixels (0-200px)
            </p>
          </div>

          <!-- Bottom Margin -->
          <div class="setting-item">
            <label for="projection-margin-bottom">
              Bottom Margin: <span id="projection-margin-bottom-value">0px</span>
            </label>
            <input type="range" id="projection-margin-bottom" class="setting-slider" min="0" max="200" value="0"
              step="5">
            <p class="setting-description">
              Bottom margin in pixels (0-200px)
            </p>
          </div>

          <!-- Left Margin -->
          <div class="setting-item">
            <label for="projection-margin-left">
              Left Margin: <span id="projection-margin-left-value">0px</span>
            </label>
            <input type="range" id="projection-margin-left" class="setting-slider" min="0" max="200" value="0" step="5">
            <p class="setting-description">
              Left margin in pixels (0-200px)
            </p>
          </div>
        </section>

        <!-- Advanced Settings Section -->
        <section class="settings-section" id="advanced-settings">
          <h3>Advanced</h3>
          <p class="setting-description">
            Advanced playback and tempo controls
          </p>

          <!-- Show Tempo Knob -->
          <div class="setting-item">
            <label class="toggle-label">
              <span class="setting-label-text">Automatic TEMPO Control</span>
              <div class="toggle-switch">
                <input type="checkbox" id="show-tempo-knob" class="toggle-input">
                <span class="toggle-slider"></span>
              </div>
            </label>
            <p class="setting-description">
              Automatically adds a global tempo slider controlling playback speed
            </p>
          </div>

          <!-- Show CPM -->
          <div class="setting-item">
            <label class="toggle-label">
              <span class="setting-label-text">Display as CPM (Cycles Per Minute)</span>
              <div class="toggle-switch">
                <input type="checkbox" id="show-cpm" class="toggle-input">
                <span class="toggle-slider"></span>
              </div>
            </label>
            <p class="setting-description">
              Show tempo as CPM instead of BPM (BPM = CPM Ã— 4)
            </p>
          </div>
        </section>
      </div>

      <div class="modal-footer">
        <button id="settings-save-btn" class="btn-primary">Save</button>
        <button id="settings-cancel-btn" class="btn-secondary">Cancel</button>
      </div>
    </div>
  </div>

  <header>
    <div class="global-controls">
      <!-- Controls moved to hero section -->
    </div>
  </header>

  <!-- Panel Tree Structure -->
  <ul class="panel-tree" id="panel-tree">
    <!-- Master Panel (panel-0) -->
    <li class="level-panel" data-panel-id="panel-0" data-panel-number="0" id="panel-0">
      <details open>
        <summary>
          <span class="panel-number-badge">0</span>
          <span class="panel-title" contenteditable="true">Master</span>
          <div class="panel-actions">
            <!-- No play button for master panel - it's always the context window -->
            <button class="btn-delete" title="Delete" style="display: none;">
              <span class="material-icons">delete</span>
            </button>
          </div>
        </summary>
        <!-- Editor container - collapses with details -->
        <div class="panel-editor-container">
          <div class="code-editor-wrapper">
            <div class="code-editor" id="editor-panel-0" data-card="panel-0"></div>
          </div>
          <div class="error-message" data-card="panel-0" style="display: none;"></div>
        </div>
      </details>
      <!-- Controls container - outside details, visibility controlled by settings -->
      <div class="panel-controls-container">
        <div class="leaf-viz" style="display: none;">
          <div id="viz-container-panel-0" class="viz-container"></div>
        </div>
        <!-- Slider leaves will be added dynamically by sliderManager -->
      </div>
    </li>
    <!-- Dynamic panels created via [+] button will appear here -->
  </ul>

  <div class="info">
    Click [+] to create new instrument panels. Expand panels to edit code.
  </div>

  <script type="module" src="/src/main.js"></script>
</body>

</html>
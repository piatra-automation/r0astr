<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>r0astr - Strudel Synth API</title>
  <!-- Core CSS (order matters) -->
  <link rel="stylesheet" href="/static/css/variables.css">
  <link rel="stylesheet" href="/static/css/base.css">
  <link rel="stylesheet" href="/static/css/panels.css">
  <link rel="stylesheet" href="/static/css/components.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:ital,wght@0,100..900;1,100..900&display=swap"
    rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>

<body>
  <!-- Electron: Draggable title bar region (no-op in browser) -->
  <div class="electron-drag-region"></div>

  <!-- Banner Bar: Narrow header with logo and subtitle
       MUST come before top-menu-bar for CSS sibling hover selector to work -->
  <div class="banner-bar" id="banner-bar">
    <div class="site-logo">
      <img src="/static/images/banner.png" alt="r0astr Logo">
    </div>
    <div class="banner-subtitle">
      <a href="https://strudel.cc" target="_blank" rel="noopener noreferrer">STRUDEL</a> SYNTH API | ORCHESTRATOR
    </div>
  </div>

  <!-- Top Menu Bar: Auto-hiding drawer from top (slides down on banner hover) -->
  <nav class="top-menu-bar" id="top-menu-bar" aria-label="Main menu">
    <button class="top-bar-btn btn-white" id="save-btn">SAVE</button>
    <button class="top-bar-btn btn-orange" id="load-btn">LOAD</button>
    <a href="/remote" class="top-bar-btn btn-green" id="remote-btn" target="_blank" rel="noopener noreferrer">REMOTE</a>
    <button class="top-bar-btn btn-orange" id="config-btn">CONFIG</button>
  </nav>

  <!-- Metronome Section: Step sequencer indicator (16 steps per cycle) -->
  <div class="metronome-section" id="metronome-section">
    <div class="step-sequencer" id="metronome" title="Cycle position (1/16th steps)">
      <div class="step-box" data-step="0"></div>
      <div class="step-box" data-step="1"></div>
      <div class="step-box" data-step="2"></div>
      <div class="step-box" data-step="3"></div>
      <div class="step-box" data-step="4"></div>
      <div class="step-box" data-step="5"></div>
      <div class="step-box" data-step="6"></div>
      <div class="step-box" data-step="7"></div>
      <div class="step-box" data-step="8"></div>
      <div class="step-box" data-step="9"></div>
      <div class="step-box" data-step="10"></div>
      <div class="step-box" data-step="11"></div>
      <div class="step-box" data-step="12"></div>
      <div class="step-box" data-step="13"></div>
      <div class="step-box" data-step="14"></div>
      <div class="step-box" data-step="15"></div>
    </div>
  </div>

  <!-- Master Button Block: Removed - buttons now in master panel row -->

  <!-- Settings Modal -->
  <div id="settings-modal" class="modal-overlay" role="dialog" aria-labelledby="settings-title" aria-modal="true">
    <div class="modal-content settings-panel">
      <div class="modal-header">
        <h2 id="settings-title">Settings</h2>
      </div>

      <div class="modal-body">
        <!-- GENERAL Section -->
        <section class="settings-section collapsed" id="general-settings">
          <h3>General</h3>
          <div class="settings-section-content">
            <!-- Restore Session Toggle -->
            <div class="setting-item">
              <label class="toggle-label">
                <input type="checkbox" id="restore-session-toggle" class="toggle-input">
                <span class="toggle-slider"></span>
                <span class="toggle-text">Restore Session on Load</span>
              </label>
              <p class="setting-description">
                Automatically restore panels and code from previous session when opening the app
              </p>
            </div>

            <!-- YOLO Mode Toggle -->
            <div class="setting-item">
              <label class="toggle-label">
                <input type="checkbox" id="yolo-toggle" class="toggle-input">
                <span class="toggle-slider"></span>
                <span class="toggle-text">YOLO Mode (Skip confirmations)</span>
              </label>
              <p class="setting-description">
                Disable confirmation dialogs when deleting panels
              </p>
            </div>

            <!-- Auto-save Interval -->
            <div class="setting-item">
              <label for="autosave-interval-select">Auto-save Panel State</label>
              <select id="autosave-interval-select" class="setting-select">
                <option value="manual">Manual (on panel change)</option>
                <option value="30s">Every 30 seconds</option>
                <option value="1min">Every 1 minute</option>
                <option value="5min">Every 5 minutes</option>
              </select>
              <p class="setting-description">
                How frequently to save panel state to localStorage
              </p>
            </div>
          </div>
        </section>

        <!-- EDITOR Section -->
        <section class="settings-section collapsed" id="editor-settings">
          <h3>Editor</h3>
          <div class="settings-section-content">
            <!-- Font Size Slider -->
            <div class="setting-item">
              <label for="font-size-slider">
                Code Editor Font Size: <span id="font-size-value">14px</span>
              </label>
              <input type="range" id="font-size-slider" class="setting-slider" min="10" max="24" value="14" step="1">
              <p class="setting-description">
                Adjust font size for all code editors (10-24px)
              </p>
            </div>

            <!-- Editor Theme Selection -->
            <div class="setting-item">
              <label for="editor-theme-select">Editor Theme</label>
              <select id="editor-theme-select" class="setting-select">
                <option value="atomone">Atom One Dark</option>
                <option value="abcdef">Abcdef</option>
                <option value="bespin">Bespin</option>
                <option value="dracula">Dracula</option>
                <option value="gruvboxDark">Gruvbox Dark</option>
                <option value="materialDark">Material Dark</option>
                <option value="nord">Nord</option>
                <option value="solarizedDark">Solarized Dark</option>
              </select>
              <p class="setting-description">
                Color theme for code editor (requires syntax highlighting enabled)
              </p>
            </div>

            <!-- Wrap Lines Toggle -->
            <div class="setting-item">
              <label class="toggle-label">
                <input type="checkbox" id="wrap-lines-toggle" class="toggle-input">
                <span class="toggle-slider"></span>
                <span class="toggle-text">Wrap long lines in code panels</span>
              </label>
              <p class="setting-description">
                When enabled, long lines wrap to next line instead of scrolling horizontally
              </p>
            </div>

            <!-- Auto-Format Toggle -->
            <div class="setting-item">
              <label class="toggle-label">
                <input type="checkbox" id="auto-format-toggle" class="toggle-input">
                <span class="toggle-slider"></span>
                <span class="toggle-text">Auto-format code on PLAY/UPDATE</span>
              </label>
              <p class="setting-description">
                Automatically formats code for readability when pressing PLAY or UPDATE
              </p>
            </div>

            <!-- Syntax Highlighting Toggle -->
            <div class="setting-item">
              <label class="toggle-label">
                <input type="checkbox" id="syntax-highlight-toggle" class="toggle-input">
                <span class="toggle-slider"></span>
                <span class="toggle-text">Enable syntax highlighting</span>
              </label>
              <p class="setting-description">
                Use CodeMirror for syntax highlighting. Disable for plain text editor.
              </p>
            </div>

            <!-- Pattern Highlighting Toggle -->
            <div class="setting-item">
              <label class="toggle-label">
                <input type="checkbox" id="pattern-highlighting-toggle" class="toggle-input">
                <span class="toggle-slider"></span>
                <span class="toggle-text">Real-time Pattern Highlighting</span>
              </label>
              <p class="setting-description">
                Highlight active pattern elements during playback
              </p>
            </div>
          </div>
        </section>

        <!-- BEHAVIOUR Section -->
        <section class="settings-section collapsed" id="behaviour-settings">
          <h3>Behaviour</h3>
          <div class="settings-section-content">
            <!-- Active Panel Opacity Slider -->
            <div class="setting-item">
              <label for="active-panel-opacity-slider">
                Active Panel Opacity: <span id="active-panel-opacity-value">95%</span>
              </label>
              <input type="range" id="active-panel-opacity-slider" class="setting-slider" min="50" max="100" value="95" step="5">
              <p class="setting-description">
                Opacity for the currently focused/active panel (50-100%)
              </p>
            </div>

            <!-- Background Panel Opacity Slider -->
            <div class="setting-item">
              <label for="background-panel-opacity-slider">
                Background Panels Opacity: <span id="background-panel-opacity-value">60%</span>
              </label>
              <input type="range" id="background-panel-opacity-slider" class="setting-slider" min="20" max="100" value="60" step="5">
              <p class="setting-description">
                Cumulative opacity for unfocused panels (20-100%)
              </p>
            </div>

            <!-- Collapse on Blur Toggle -->
            <div class="setting-item">
              <label class="toggle-label">
                <input type="checkbox" id="collapse-on-blur-toggle" class="toggle-input">
                <span class="toggle-slider"></span>
                <span class="toggle-text">Collapse unfocused panels</span>
              </label>
              <p class="setting-description">
                When enabled, background panels collapse to show only header
              </p>
            </div>

            <!-- Show Controls When Collapsed Toggle -->
            <div class="setting-item">
              <label class="toggle-label">
                <input type="checkbox" id="show-controls-collapsed-toggle" class="toggle-input">
                <span class="toggle-slider"></span>
                <span class="toggle-text">Show controls when panel collapsed</span>
              </label>
              <p class="setting-description">
                Keep sliders and visualizers visible when panel is collapsed
              </p>
            </div>

          </div>
        </section>

        <!-- INTEGRATIONS Section -->
        <section class="settings-section collapsed" id="integration-settings">
          <h3>Integrations</h3>
          <div class="settings-section-content">
            <!-- UI Skin Selector -->
            <div class="setting-item">
              <label for="skin-select">UI Skin / Theme</label>
              <select id="skin-select" class="setting-select">
                <!-- Options populated dynamically from bundled + custom skins -->
              </select>
              <p class="setting-description">
                Choose UI skin. Requires page reload to take effect.
              </p>
            </div>

            <!-- Import Custom Skin -->
            <div class="setting-item">
              <label>Import Custom Skin</label>
              <div class="skin-import-controls">
                <input type="file" id="skin-import-file" accept=".zip" style="display: none;">
                <button class="btn-hole btn-slim-md" id="skin-import-btn" type="button">
                  <span class="btn-surface">
                    <span class="material-icons">upload_file</span>
                    <span>Import Skin (ZIP)</span>
                  </span>
                </button>
                <div id="skin-import-status" class="import-status" style="display: none;"></div>
              </div>
              <p class="setting-description">
                Import custom skins from ZIP files
              </p>
            </div>

            <!-- Manage Custom Skins -->
            <div class="setting-item" id="custom-skins-manager">
              <label>Installed Custom Skins</label>
              <div id="custom-skins-list" class="custom-skins-list">
                <!-- Populated dynamically -->
              </div>
            </div>

            <!-- Snippet Location Input -->
            <div class="setting-item">
              <label for="snippet-location-input">Snippet Library URL/Path</label>
              <input type="text" id="snippet-location-input" class="setting-text-input"
                placeholder="https://example.com/snippets.json">
              <p class="setting-description">
                URL or file path to external snippet library (JSON format)
              </p>
            </div>

          </div>
        </section>

        <!-- ADVANCED Section -->
        <section class="settings-section collapsed" id="advanced-settings">
          <h3>Advanced</h3>
          <div class="settings-section-content">
            <!-- Show Tempo Knob -->
            <div class="setting-item">
              <label class="toggle-label">
                <input type="checkbox" id="show-tempo-knob" class="toggle-input">
                <span class="toggle-slider"></span>
                <span class="toggle-text">Automatic TEMPO Control</span>
              </label>
              <p class="setting-description">
                Automatically adds a global tempo slider controlling playback speed
              </p>
            </div>

            <!-- Show CPM -->
            <div class="setting-item">
              <label class="toggle-label">
                <input type="checkbox" id="show-cpm" class="toggle-input">
                <span class="toggle-slider"></span>
                <span class="toggle-text">Display as CPM (Cycles Per Minute)</span>
              </label>
              <p class="setting-description">
                Show tempo as CPM instead of BPM (BPM = CPM Ã— 4)
              </p>
            </div>

            <!-- Projection Tweaks Sub-section -->
            <div class="setting-item">
              <label>Projection Margins</label>
              <p class="setting-description">
                Add margins to the entire UI for projection adjustments. Requires page reload.
              </p>
            </div>

            <!-- Top Margin -->
            <div class="setting-item">
              <label for="projection-margin-top">
                Top: <span id="projection-margin-top-value">0px</span>
              </label>
              <input type="range" id="projection-margin-top" class="setting-slider" min="0" max="200" value="0" step="5">
            </div>

            <!-- Right Margin -->
            <div class="setting-item">
              <label for="projection-margin-right">
                Right: <span id="projection-margin-right-value">0px</span>
              </label>
              <input type="range" id="projection-margin-right" class="setting-slider" min="0" max="200" value="0" step="5">
            </div>

            <!-- Bottom Margin -->
            <div class="setting-item">
              <label for="projection-margin-bottom">
                Bottom: <span id="projection-margin-bottom-value">0px</span>
              </label>
              <input type="range" id="projection-margin-bottom" class="setting-slider" min="0" max="200" value="0" step="5">
            </div>

            <!-- Left Margin -->
            <div class="setting-item">
              <label for="projection-margin-left">
                Left: <span id="projection-margin-left-value">0px</span>
              </label>
              <input type="range" id="projection-margin-left" class="setting-slider" min="0" max="200" value="0" step="5">
            </div>
          </div>
        </section>
      </div>

      <div class="modal-footer">
        <button id="settings-save-btn" class="btn-primary">Save</button>
        <button id="settings-cancel-btn" class="btn-secondary">Cancel</button>
      </div>
    </div>
  </div>

  <header>
    <div class="global-controls">
      <!-- Controls moved to hero section -->
    </div>
  </header>

  <!-- Panel Tree Structure -->
  <ul class="panel-tree" id="panel-tree">
    <!-- Master Panel (panel-0) -->
    <li class="level-panel" data-panel-id="panel-0" data-panel-number="0" id="panel-0">
      <details open>
        <summary>
          <span class="panel-number-badge">0</span>
          <span class="panel-title" contenteditable="true">GLOBALS</span>
          <div class="panel-actions">
            <!-- Master panel controls: Update All and Stop All -->
            <button class="btn-update-all" id="update-all-btn" title="Update all stale panels">
              <span class="material-icons">eco</span>
              <span class="count-badge hidden"></span>
            </button>
            <button class="btn-stop-all" id="stop-all" title="Stop All">
              <span class="material-icons">stop</span>
            </button>
            <!-- No delete button for master panel -->
          </div>
        </summary>
        <!-- Editor container - collapses with details -->
        <div class="panel-editor-container">
          <div class="code-editor-wrapper">
            <div class="code-editor" id="editor-panel-0" data-card="panel-0"></div>
          </div>
          <div class="error-message" data-card="panel-0" style="display: none;"></div>
        </div>
      </details>
      <!-- Controls container - outside details, visibility controlled by settings -->
      <div class="panel-controls-container">
        <div class="leaf-viz" style="display: none;">
          <div id="viz-container-panel-0" class="viz-container"></div>
        </div>
        <!-- Slider leaves will be added dynamically by sliderManager -->
      </div>
    </li>
    <!-- Dynamic panels created via [+] button will appear here -->

    <!-- Add Panel Row: Always at end of tree -->
    <li class="add-panel-row" id="add-panel-row">
      <button class="add-panel-trigger" id="add-panel-btn" title="Add New Panel">
        <span class="panel-number-badge add-badge">+</span>
        <span class="add-panel-text">Add New Panel</span>
      </button>
    </li>
  </ul>

  <div class="info">
    Click [+] to create new instrument panels. Expand panels to edit code.
  </div>

  <script type="module" src="/src/main.js"></script>
</body>

</html>